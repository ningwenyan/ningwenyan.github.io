<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Python Flask MySQL alembic"><meta name="description" content="Python | Flask |  MySQL | Linux | Ubuntu"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>MySQL版本管理工具alembic | 文彦笔记</title><link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//favicon.png"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//css/matery.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//css/my.css"><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/jquery/jquery.min.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4337512190549598" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="文彦笔记" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">文彦笔记</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">文彦笔记</div><div class="logo-desc">Python | Flask | MySQL | Linux | Ubuntu</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/ningwenyan" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/ningwenyan" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/2020-9-6/1599404990051-84109093-14.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">MySQL版本管理工具alembic</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Flask/"><span class="chip bg-color">Flask</span> </a><a href="/tags/Python/"><span class="chip bg-color">Python</span> </a><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span> </a><a href="/tags/alembic/"><span class="chip bg-color">alembic</span></a></div></div><div class="col s5 right-align"><div class="post-cate"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/SQLAlchemy/" class="post-category">SQLAlchemy</a></div></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2020-09-06</div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><h2 id="alembic"><a href="#alembic" class="headerlink" title="alembic"></a><code>alembic</code></h2><h3 id="1-什么是alembic"><a href="#1-什么是alembic" class="headerlink" title="1. 什么是alembic"></a>1. 什么是<code>alembic</code></h3><blockquote><p>随着项目业务需求的不断变更,数据库的表结构修改难以避免,此时就需要对数据库的修改加以记录和控制,便于项目的版本管理和随意升级和降级.</p><p><code>alembic</code> 很好的解决了这个问题,<code>alembic</code> 是<code>SQLAlchemy</code>的作者开发的<code>Python</code>数据库版本管理工具.</p><p><a href="https://alembic.sqlalchemy.org/en/latest/tutorial.html#the-migration-environment" target="_blank" rel="noopener">官网</a></p></blockquote><h3 id="2-安装"><a href="#2-安装" class="headerlink" title="2.安装"></a>2.安装</h3><blockquote><pre class="line-numbers language-bash">$ conda install alembic</pre><p><code>alembic</code> 需要<code>sqlalchemy</code> 和数据库控制工具如<code>pymysql</code> 的支持,确保安装了这两个工具.</p><pre><code class="bash"><code class="language-bash">$ conda install alembic</code></code></pre><p><code>alembic</code> 需要<code>sqlalchemy</code> 和数据库控制工具如<code>pymysql</code> 的支持,确保安装了这两个工具.</p><pre><code class="bash">$ conda install sqlalchemy
$ conda install pymysql<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><h3 id="3-基本流程"><a href="#3-基本流程" class="headerlink" title="3.基本流程"></a>3.基本流程</h3><blockquote><ol><li>初始化</li><li>修改<code>init</code>配置文件</li><li>修改<code>env.py</code></li><li>创建新的迁移脚本</li><li>变更数据库版本<ol><li>升级数据库版本</li><li>降级数据库版本</li></ol></li></ol></blockquote><h4 id="1-初始化"><a href="#1-初始化" class="headerlink" title="1.初始化"></a>1.初始化</h4><blockquote><p>先创建一个<code>sqlalchemy</code> 的<code>ORM</code>映射:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token triple-quoted-string string">"""
存在数据库 alembic_demo
如果不存在, create database alembic_demo
"""</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span>ForeignKey<span class="token punctuation">,</span>Integer<span class="token punctuation">,</span>String
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship

<span class="token comment" spellcheck="true"># 1.创建数据库连接</span>
msg <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/alembic_demo'</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>msg<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.创建Model</span>
<span class="token comment" spellcheck="true"># 创建 Base</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建Model</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>

 id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
 name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

 addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Address'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Address</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'address'</span>

 id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
 email_address <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
 u_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

 user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'addresses'</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
真实业务不能删除表,从新创建,必须做好版本控制
Base.metadata.drop_all(engine)
Base.metadata.create_all(engine)
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后进行初始化操作,<code>alembic init &lt;YOUR_ALEMBIC_DIR&gt;</code></p><p>这条命令默认会创建一个<code>&lt;YOUR_ALEMBIC_DIR&gt;</code> 的文件夹,所以最好能配置到项目的根目录中.</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>learnpy<span class="token punctuation">)</span> kning@kning-pc:$ alembic init alembic
Creating directory /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
Creating directory /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic/versions <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
Generating /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic/env.py <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
Generating /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic/script.py.mako <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
Generating /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic/README <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
Generating /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic.ini <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
Please edit configuration/connection/logging settings <span class="token keyword">in</span>
<span class="token string">'/home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic.ini'</span> before proceeding.

<span class="token punctuation">(</span>learnpy<span class="token punctuation">)</span> kning@kning-pc:$ tree
<span class="token keyword">.</span>
├── alembic                                     <span class="token comment" spellcheck="true"># &lt;YOUR_ALEMBIC_DIR> 创建的文件夹名字</span>
│   ├── env.py                               <span class="token comment" spellcheck="true">#  迁移脚本</span>
│   ├── README                     
│   ├── script.py.mako             
│   └── versions                          <span class="token comment" spellcheck="true"># 数据库对应版本文件夹</span>
├── alembic.ini                            <span class="token comment" spellcheck="true"># alembic配置文件</span>
└── sqlalchemy_model.py            <span class="token comment" spellcheck="true"># 项目文件</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="2-修改init-配置文件"><a href="#2-修改init-配置文件" class="headerlink" title="2.修改init 配置文件"></a>2.修改<code>init</code> 配置文件</h4><blockquote><p>默认创建完毕后,<code>alembic</code> 并不知道数据库是如何连接的.所以需要修改它的配置文件.</p><pre class="line-numbers language-ini"><code class="language-ini">$ vim  alembic.ini

...
# 找到 sqlalchemy.url <span class="token attr-value"><span class="token punctuation">=</span> driver://user:pass@localhost/dbname</span>
# 修改为和 sqlalchemy 的engine 一样的格式
<span class="token constant">sqlalchemy.url</span> <span class="token attr-value"><span class="token punctuation">=</span> mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/alembic_demo</span>
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多的配置选项参考官网.</p></blockquote><h4 id="3-修改env-py"><a href="#3-修改env-py" class="headerlink" title="3.修改env.py"></a>3.修改<code>env.py</code></h4><blockquote><p>在<code>alembic</code> 中调用的是<code>sqlalchemy</code>的元类(<code>Base</code>)去操作,这需要手动的去改动<code>env.py</code> 文件.</p><pre class="line-numbers language-python"><code class="language-python">$ vim  alembic<span class="token operator">/</span>env<span class="token punctuation">.</span>py

<span class="token comment" spellcheck="true"># 找到target_metadata = None 这行,手动指定 metadata 是在哪个文件中.</span>
<span class="token comment" spellcheck="true"># 比如这里 metadata 是 Base, Base指定在了sqlalchemy_model.py 这个项目文件中</span>

<span class="token triple-quoted-string string">"""
__file__：当前文档（env.py）
os.path.dirname(__file__)：获取当前文档的目录
os.path.dirname(os.path.dirname(__file__))：获取当前文档目录的上一级目录
sys.path: python寻找导入的包的所有路径
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
"""</span>
<span class="token keyword">import</span> os<span class="token punctuation">,</span>sys
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 导入Base</span>
<span class="token keyword">import</span> sqlalchemy_model

<span class="token comment" spellcheck="true"># 指定</span>
target_metadata <span class="token operator">=</span> sqlalchemy_model<span class="token punctuation">.</span>Base<span class="token punctuation">.</span>metadata<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="4-创建新的迁移脚本"><a href="#4-创建新的迁移脚本" class="headerlink" title="4.创建新的迁移脚本"></a>4.创建新的迁移脚本</h4><blockquote><p>进行创建第一次的<code>ORM</code>对应</p><pre class="line-numbers language-bash"><code class="language-bash">$ alembic revision --autogenerate -m <span class="token string">'first commit'</span>

INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Context impl MySQLImpl.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
INFO  <span class="token punctuation">[</span>alembic.autogenerate.compare<span class="token punctuation">]</span> Detected added table <span class="token string">'user'</span>
INFO  <span class="token punctuation">[</span>alembic.autogenerate.compare<span class="token punctuation">]</span> Detected added table <span class="token string">'address'</span>
Generating /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic/versions/8eee680c6ffd_first_commit.py <span class="token punctuation">..</span>.  <span class="token keyword">done</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code></p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:alembic_demo> show tables;                                       
+------------------------+
| Tables_in_alembic_demo |
+------------------------+
| alembic_version        |
+------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它会生成一张纪律当前版本号 的表</p></blockquote><h4 id="5-运行第一次迁移"><a href="#5-运行第一次迁移" class="headerlink" title="5.运行第一次迁移"></a>5.运行第一次迁移</h4><blockquote><p>创建迁移脚本后,并没有创建<code>SQLAlchemy Model</code> 对应的表结构.这需要执行第一次的迁移</p><pre class="line-numbers language-bash"><code class="language-bash">$ alembic upgrade <span class="token function">head</span>

INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Context impl MySQLImpl.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Running upgrade  -<span class="token operator">></span> 8eee680c6ffd, first commit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到<code>alembic</code> 指针指向了第一次的版本号.查看<code>mysql</code> 数据库</p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:alembic_demo> show tables;                                                        
+------------------------+
| Tables_in_alembic_demo |
+------------------------+
| address                |
| alembic_version        |
| user                   |
+------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>现在生成了<code>ORM</code>对应的表结构.</p></blockquote><h4 id="6-变更数据库版本"><a href="#6-变更数据库版本" class="headerlink" title="6.变更数据库版本"></a>6.变更数据库版本</h4><blockquote><p>现在在<code>sqlalchemy_model</code> 中添加新的列</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
__tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>

id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
age <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>

addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Address'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>生成新的数据库迁移脚本,并迁移</p><pre class="line-numbers language-bash"><code class="language-bash">$ alembic revision --autogenerate -m <span class="token string">'add User.age'</span>

INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Context impl MySQLImpl.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
INFO  <span class="token punctuation">[</span>alembic.autogenerate.compare<span class="token punctuation">]</span> Detected added column <span class="token string">'user.age'</span>
Generating /home/kning/My_Note/Python3_learn/Flask/code/alembic_demo/alembic/versions/154a8d766856_add_user_age.py <span class="token punctuation">..</span>.  <span class="token keyword">done</span>

$ alembic upgrade <span class="token function">head</span>

INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Context impl MySQLImpl.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Running upgrade 8eee680c6ffd -<span class="token operator">></span> 154a8d766856, add User.age<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code></p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:alembic_demo> desc user;                                                  
+-------+-------------+------+-----+---------+----------------+
| Field | Type        | Null | Key | Default | Extra          |
+-------+-------------+------+-----+---------+----------------+
| id    | int(11)     | NO   | PRI | <null>  | auto_increment |
| name  | varchar(25) | NO   |     | <null>  |                |
| age   | int(11)     | YES  |     | <null>  |                |
+-------+-------------+------+-----+---------+----------------+

mysql root@192.168.101:alembic_demo> select * from alembic_version;                                                                  
+--------------+
| version_num  |
+--------------+
| 154a8d766856 |
+--------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></null></null></null></code></pre><p>可以看到<code>user</code> 表中确实添加了新的列,<code>alembic_version</code> 表中值也指向了最新生成的<code>154a8d766856</code></p><p>可以执行降级,退回到以前的版本</p><pre class="line-numbers language-python"><code class="language-python">$ alembic downgrade <span class="token number">8eee680c6ffd</span> <span class="token comment" spellcheck="true">#&lt;== 版本号码</span>

INFO  <span class="token punctuation">[</span>alembic<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>migration<span class="token punctuation">]</span> Context impl MySQLImpl<span class="token punctuation">.</span>
INFO  <span class="token punctuation">[</span>alembic<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>migration<span class="token punctuation">]</span> Will assume non<span class="token operator">-</span>transactional DDL<span class="token punctuation">.</span>
INFO  <span class="token punctuation">[</span>alembic<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>migration<span class="token punctuation">]</span> Running downgrade <span class="token number">154a8d766856</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token number">8eee680c6ffd</span><span class="token punctuation">,</span> add User<span class="token punctuation">.</span>age<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code></p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:alembic_demo> desc user;                                              
+-------+-------------+------+-----+---------+----------------+
| Field | Type        | Null | Key | Default | Extra          |
+-------+-------------+------+-----+---------+----------------+
| id    | int(11)     | NO   | PRI | <null>  | auto_increment |
| name  | varchar(25) | NO   |     | <null>  |                |
+-------+-------------+------+-----+---------+----------------+


mysql root@192.168.101:alembic_demo> select * from alembic_version;                                                         
+--------------+
| version_num  |
+--------------+
| 8eee680c6ffd |
+--------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></null></null></code></pre><p>可以看到在<code>mysql</code>中表确实回到了以前的状态.<code>upgrade</code>和<code>downgrade</code>都可以指定版本号</p><pre class="line-numbers language-python"><code class="language-python">alembic upgrade <span class="token operator">&lt;</span>version<span class="token operator">></span>
alembic downgrade <span class="token operator">&lt;</span>version<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>只不过<code>head</code> 参数指向了最新的版本号码,可以使用<code>alembic heads</code> 查看最新的版本号,<code>alembic current</code> 查看当前版本号.</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>learnpy<span class="token punctuation">)</span>$ alembic heads
154a8d766856 <span class="token punctuation">(</span>head<span class="token punctuation">)</span>

<span class="token punctuation">(</span>learnpy<span class="token punctuation">)</span> $ alembic current
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Context impl MySQLImpl.
INFO  <span class="token punctuation">[</span>alembic.runtime.migration<span class="token punctuation">]</span> Will assume non-transactional DDL.
8eee680c6ffd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>需要注意的是,即是数据库中表的版本回到了以前的版本号,但是<code>sqlalchemy_model</code> 中的代码并没有改变.需要手动去修改.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
__tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>

id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
age <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>

addresses <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Address'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="4-alembic-常用参数"><a href="#4-alembic-常用参数" class="headerlink" title="4.alembic 常用参数"></a>4.<code>alembic</code> 常用参数</h3><blockquote><pre class="line-numbers language-bash"><code class="language-bash">$ alembic -h

positional arguments:
<span class="token punctuation">{</span>branches,current,downgrade,edit,heads,history,init,list_templates,merge,revision,show,stamp,upgrade<span class="token punctuation">}</span>
 branches            Show current branch points.
 current             Display the current revision <span class="token keyword">for</span> a database.
 downgrade           Revert to a previous version.
 edit                Edit revision script<span class="token punctuation">(</span>s<span class="token punctuation">)</span> using <span class="token variable">$EDITOR</span><span class="token keyword">.</span>
 heads               Show current available heads <span class="token keyword">in</span> the script directory.
 <span class="token function">history</span>             List changeset scripts <span class="token keyword">in</span> chronological order.
 init                Initialize a new scripts directory.  创建一个新的alembic 仓库
 list_templates      List available templates.
 merge               Merge two revisions together. Creates a new migration
                     file.
 revision            Create a new revision file.
 show                Show the revision<span class="token punctuation">(</span>s<span class="token punctuation">)</span> denoted by the given symbol.
 stamp               <span class="token string">'stamp'</span> the revision table with the given revision<span class="token punctuation">;</span>
                     don't run any migrations.
 upgrade             Upgrade to a later version.

init:创建一个alembic仓库
revision:创建一个新的版本文件
--autogenerate:自动将当前模型的修改，生成迁移脚本
-m:本次迁移做了哪些修改，用户可以指定这个参数，方便回顾
upgrade:将指定版本的迁移文档映射到数据库中，会执行版本文档中的upgrade函数
head:代表当前的迁移脚本的版本号
downgrade:会执行指定版本的迁移文档中的downgrade函数
heads:展示当前可用的heads脚本文档
history:列出所有的迁移版本及其信息
current:展示当前数据库中的版本号<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="5-alembic在Flask中的应用"><a href="#5-alembic在Flask中的应用" class="headerlink" title="5.alembic在Flask中的应用"></a>5.<code>alembic</code>在<code>Flask</code>中的应用</h3><blockquote><p>如果在<code>flask</code> 中使用的是<code>sqlalchemy-flask</code> ,而不是<code>sqlalchemy</code> 的话,<code>alembic</code> 中的元类也会有不同的映射.</p><p>比如,新建一个<code>flask</code> 项目,项目目录如下:</p><pre class="line-numbers language-bash"><code class="language-bash">─ flask_sqlalchemy_alembic
├── app.py
├── static
└── templates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>对这个目录进行<code>alembic</code>数据库版本控制</p></blockquote><h4 id="1-创建flask-配置文件"><a href="#1-创建flask-配置文件" class="headerlink" title="1.创建flask 配置文件"></a>1.创建<code>flask</code> 配置文件</h4><blockquote><p>首先对<code>flask</code> 生成一个配置文件,把默认的配置都放置在配置文件中</p><pre class="line-numbers language-bash">$ vim config.py</pre><pre><code class="python"><code class="language-bash">$ vim config.py</code></code></pre><pre><code class="python">DEBUG = True  # 开启Debug
TEMPLATES_AUTO_RELOAD = True # 模板自动加载
DB_URI = 'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/flask_alembic_demo' # 确保数据库存在 # 确保数据库存在
# 指定数据库连接
SQLALCHEMY_DATABASE_URI = DB_URI
SQLALCHEMY_TRACK_MODIFICATIONS = False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="2-修改app-py"><a href="#2-修改app-py" class="headerlink" title="2.修改app.py"></a>2.修改<code>app.py</code></h4><blockquote><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask_sqlalchemy <span class="token keyword">import</span> SQLAlchemy

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
db <span class="token operator">=</span> SQLAlchemy<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">.</span>from_object<span class="token punctuation">(</span><span class="token string">'config'</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 指定配置文件</span>

<span class="token comment" spellcheck="true"># 创建Model</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>db<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'user'</span>

 id <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
 user <span class="token operator">=</span> db<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>db<span class="token punctuation">.</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>

@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello_world</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
 <span class="token keyword">return</span> <span class="token string">'Hello World!'</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
 app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="3-初始化alembic"><a href="#3-初始化alembic" class="headerlink" title="3.初始化alembic"></a>3.初始化<code>alembic</code></h4><blockquote><p>进入到根目录初始化<code>alembic</code></p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cd</span> flask_sqlalchemy_alembic
$ alembic init alembic<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><h4 id="4-修改init-配置文件"><a href="#4-修改init-配置文件" class="headerlink" title="4.修改init 配置文件"></a>4.修改<code>init</code> 配置文件</h4><blockquote><pre class="line-numbers language-bash">$ vim  ./alembic.ini</pre><pre><code class="ini"><code class="language-bash">$ vim  ./alembic.ini</code></code></pre><pre><code class="ini"># 找到并修改为 和 engine 一样的字段
sqlalchemy.url = mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/flask_alembic_demo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><h4 id="5-修改env-py"><a href="#5-修改env-py" class="headerlink" title="5.修改env.py"></a>5.修改<code>env.py</code></h4><blockquote><pre class="line-numbers language-bash">$ vim ./alembic/env.py</pre><pre><code class="python"><code class="language-bash">$ vim ./alembic/env.py</code></code></pre><pre><code class="python"># 加入系统查找路径
import os,sys
sys.path.append(os.path.dirname(os.path.dirname(__file__)))
import app

# 找到并修改
target_metadata = app.db.Model.metadata<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="6-创建迁移脚本"><a href="#6-创建迁移脚本" class="headerlink" title="6.创建迁移脚本"></a>6.创建迁移脚本</h4><blockquote><pre class="line-numbers language-bash">$ alembic revision --autogenerate -m &#39;first commit&#39;</pre></blockquote><h4 id="7-切换数据库版本"><a href="#7-切换数据库版本" class="headerlink" title="7.切换数据库版本"></a>7.切换数据库版本</h4><blockquote><pre><code class="bash">$ alembic upgrade head</code></pre><p>查看<code>mysql</code>:</p><pre><code class="mysql"><code class="language-bash">$ alembic revision --autogenerate -m &#39;first commit&#39;</code></code></pre></blockquote><h4 id="7-切换数据库版本"><a href="#7-切换数据库版本" class="headerlink" title="7.切换数据库版本"></a>7.切换数据库版本</h4><blockquote><pre><code class="bash">$ alembic upgrade head</code></pre><p>查看<code>mysql</code>:</p><pre><code class="mysql">mysql root@192.168.101:flask_alembic_demo> show tables;                                            
+------------------------------+
| Tables_in_flask_alembic_demo |
+------------------------------+
| alembic_version              |
| user                         |
+------------------------------+

mysql root@192.168.101:flask_alembic_demo> desc user;                    
+-------+-------------+------+-----+---------+----------------+
| Field | Type        | Null | Key | Default | Extra          |
+-------+-------------+------+-----+---------+----------------+
| id    | int(11)     | NO   | PRI | <null>  | auto_increment |
| user  | varchar(20) | NO   |     | <null>  |                |
+-------+-------------+------+-----+---------+----------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></null></null></code></pre><pre class="line-numbers language-bash"><code class="language-bash">$ tree
flask_sqlalchemy_alembic
├── alembic
│   ├── env.py
│   ├── __pycache__
│   │   └── env.cpython-37.pyc
│   ├── README
│   ├── script.py.mako
│   └── versions
│       ├── a8a6381cf539_first_commit.py
│       └── __pycache__
│           └── a8a6381cf539_first_commit.cpython-37.pyc
├── alembic.ini
├── app.py
├── config.py
├── static
└── templates<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><hr><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/2020-9-10/1599749828166-10291.png" alt="10291"></p><h2 id="Flask-migrate"><a href="#Flask-migrate" class="headerlink" title="Flask-migrate"></a><code>Flask-migrate</code></h2><h3 id="1-什么是Flask-migrate"><a href="#1-什么是Flask-migrate" class="headerlink" title="1.什么是Flask-migrate"></a>1.什么是<code>Flask-migrate</code></h3><blockquote><p><code>Flask-Migrate</code> 是基于<code>Alembic</code> 处理<code>SQLAlchemy</code> 数据库迁移的扩展.</p><p>在使用<code>Alembic</code>时,需要配置<code>ini</code> 配置文件和<code>env.py</code> 文件,在<code>Flask-Migrate</code> 中会自动的配置这些文件.它支持<code>Alembic</code> 的所有命令.可以使用<code>Flask</code> 命令行和<code>Flask-Script</code> 来操作数据库.</p><p><a href="https://flask-migrate.readthedocs.io/en/latest/" target="_blank" rel="noopener">官网</a></p><p>官网有很多的用法,这里只扩展和<code>Flask-Script</code> 一起使用.</p></blockquote><h3 id="2-安装-1"><a href="#2-安装-1" class="headerlink" title="2.安装"></a>2.安装</h3><blockquote><pre class="line-numbers language-shell">$ pip install flask-migrate</pre></blockquote><h3 id="3-和flask-script-一起使用"><a href="#3-和flask-script-一起使用" class="headerlink" title="3.和flask-script 一起使用"></a>3.和<code>flask-script</code> 一起使用</h3><blockquote><p>基于<a href="./10038.md">circular_references</a>项目,项目目录为</p><pre><code class="shell"><code class="language-shell">$ pip install flask-migrate</code></code></pre></blockquote><h3 id="3-和flask-script-一起使用"><a href="#3-和flask-script-一起使用" class="headerlink" title="3.和flask-script 一起使用"></a>3.和<code>flask-script</code> 一起使用</h3><blockquote><p>基于<a href="./10038.md">circular_references</a>项目,项目目录为</p><pre><code class="shell">$ tree
circular_references
├── app.py                          # 主 app 文件
├── config.py                        # Flask 配置文件
├── models.py                    # 存放flask-sqlalchemy.Model 类
├── ext.py                                # 存放 db 
├── static                              #  css,js 文件目录
└── templates                     # 模板文件目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>修改<code>config.py</code> 文件,指定一个新的数据库(如果<code>mysql</code> 中没有,需要新建一个数据库)</p><pre class="line-numbers language-mysql"><code class="language-mysql">create database flask_migrate_demo;
use flask_migrate_demo;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p><code>config.py</code></p><pre class="line-numbers language-python"><code class="language-python">DEBUG <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment" spellcheck="true"># 开启Debug</span>
TEMPLATES_AUTO_RELOAD <span class="token operator">=</span> <span class="token boolean">True</span> <span class="token comment" spellcheck="true"># 模板自动加载</span>
DB_URI <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/flask_migrate_demo'</span> <span class="token comment" spellcheck="true"># 确保数据库存在</span>
<span class="token comment" spellcheck="true"># 指定数据库连接</span>
SQLALCHEMY_DATABASE_URI <span class="token operator">=</span> DB_URI
SQLALCHEMY_TRACK_MODIFICATIONS <span class="token operator">=</span> <span class="token boolean">False</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>flask-script</code> 管理文件<code>manager.py</code></p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> flask_script <span class="token keyword">import</span> Manager
<span class="token keyword">from</span> app <span class="token keyword">import</span> app
<span class="token keyword">from</span> flask_migrate <span class="token keyword">import</span> Migrate<span class="token punctuation">,</span>MigrateCommand
<span class="token keyword">from</span> ext <span class="token keyword">import</span> db
<span class="token comment" spellcheck="true"># 导入migrate=Alembic 操作的Model</span>
<span class="token keyword">from</span> models <span class="token keyword">import</span> User2<span class="token punctuation">,</span>Address2

<span class="token comment" spellcheck="true"># 绑定app</span>
manager <span class="token operator">=</span> Manager<span class="token punctuation">(</span>app<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 导入 flask-migrate</span>
<span class="token comment" spellcheck="true"># 导入的Migrate类 可以绑定app ,db到 migrate 中</span>
<span class="token comment" spellcheck="true"># 导入的MigrateCommand 类可以使用 Alembic 中所有的命令</span>
Migrate<span class="token punctuation">(</span>app<span class="token punctuation">,</span>db<span class="token punctuation">)</span>
manager<span class="token punctuation">.</span>add_command<span class="token punctuation">(</span><span class="token string">'db'</span><span class="token punctuation">,</span> MigrateCommand<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 起一个别名</span>

<span class="token comment" spellcheck="true"># 需要导入 Alembic 操作的 Model</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
manager<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在执行<code>manager.py</code> 之前,先看下<code>mysql</code>数据库中信息.</p><pre class="line-numbers language-mysql"><code class="language-mysql">>  use flask_migrate_demo 
> show tables;                                            ;     <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看帮助信息</p><pre class="line-numbers language-shell"><code class="language-shell"># 可以看到命令参数和 Alembic 一样,有的命令还设置了简化
$ python manager.py db --help
usage: Perform database migrations

Perform database migrations

positional arguments:
{init,revision,migrate,edit,merge,upgrade,downgrade,show,history,heads,branches,current,stamp}
 init                Creates a new migration repository
 revision            Create a new revision file.
 migrate             Alias for 'revision --autogenerate'
 edit                Edit current revision.
 merge               Merge two revisions together. Creates a new migration
                     file
 upgrade             Upgrade to a later version
 downgrade           Revert to a previous version
 show                Show the revision denoted by the given symbol.
 history             List changeset scripts in chronological order.
 heads               Show current available heads in the script directory
 branches            Show current branch points
 current             Display the current revision for each database.
 stamp               'stamp' the revision table with the given revision;
                     don't run any migrations

optional arguments:
-?, --help            show this help message and exit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>alembic</code> 中基本的数据库版本控制包括</p><ol><li>初始化</li><li>修改<code>init</code>配置文件</li><li>修改<code>env.py</code></li><li>创建新的迁移脚本</li><li>变更数据库版本<ol><li>升级数据库版本</li><li>降级数据库版本</li></ol></li></ol><p>而<code>migrate</code> 设置了简化,只需要</p><ol><li>初始化</li><li>创建新的迁移脚本</li><li>变更数据库版本<ol><li>升级数据库版本</li><li>降级数据库版本</li></ol></li></ol></blockquote><h4 id="1-初始化-1"><a href="#1-初始化-1" class="headerlink" title="1.初始化"></a>1.初始化</h4><blockquote><p><code>alembic</code></p><pre class="line-numbers language-bash">alembic init alembic</pre><p><code>migrate</code></p><pre><code class="shell">$ python manager.py db init</code></pre><p>此时查看目录结构</p><pre><code class="shell"><code class="language-bash">alembic init alembic</code></code></pre><p><code>migrate</code></p><pre><code class="shell">$ python manager.py db init</code></pre><p>此时查看目录结构</p><pre><code class="shell">circular_references
├── app.py                          # 主 app 文件
├── config.py                        # Flask 配置文件
├── manager.py                    # Flask-script 脚本文件
├── migrations                    # 自动生成的文件夹名称
│   ├── alembic.ini                       # alembic配置文件
│   ├── env.py                               # alembic 的使用文件
│   ├── README
│   ├── script.py.mako
│   └── versions                          # 版本目录
├── models.py                    # 存放flask-sqlalchemy.Model 类
├── ext.py                                # 存放 db 
├── static                              #  css,js 文件目录
└── templates                     # 模板文件目录<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="2-创建新的迁移脚本"><a href="#2-创建新的迁移脚本" class="headerlink" title="2.创建新的迁移脚本"></a>2.创建新的迁移脚本</h4><blockquote><p>查看帮助可以看到</p><pre class="line-numbers language-bash">migrate             Alias for &#39;revision --autogenerate&#39;</pre><p><code>migrate</code>参数默认使用了<code>--autogenerate</code> 命令</p><p>可以如下创建迁移脚本</p><pre><code class="shell"><code class="language-bash">migrate             Alias for &#39;revision --autogenerate&#39;</code></code></pre><p><code>migrate</code>参数默认使用了<code>--autogenerate</code> 命令</p><p>可以如下创建迁移脚本</p><pre><code class="shell">$ python manager.py db migrate
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'user2'
INFO  [alembic.autogenerate.compare] Detected added table 'address2'
Generating circular_refrences/migrations/versions/b296ac4287bd_.py ...  done<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code></p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:flask_migrate_demo> show tables;                                                 
+------------------------------+
| Tables_in_flask_migrate_demo |
+------------------------------+
| alembic_version              |
+------------------------------+
1 row in set
Time: 0.013s
mysql root@192.168.101:flask_migrate_demo> select * from alembic_version;              
+-------------+
| version_num |
+-------------+
0 rows in set
Time: 0.015s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="3-变更数据库版本"><a href="#3-变更数据库版本" class="headerlink" title="3.变更数据库版本"></a>3.变更数据库版本</h4><blockquote><p>现在记录下数据库的初始状态</p><pre class="line-numbers language-shell"><code class="language-shell">$ python manager.py db upgrade
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> b296ac4287bd, empty messag<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>查看数据库:</p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:flask_migrate_demo> show tables;                                                          
+------------------------------+
| Tables_in_flask_migrate_demo |
+------------------------------+
| address2                     |
| alembic_version              |
| user2                        |
+------------------------------+
3 rows in set
Time: 0.015s
mysql root@192.168.101:flask_migrate_demo> select * from alembic_version;            
+--------------+
| version_num  |
+--------------+
| b296ac4287bd |
+--------------+
1 row in set
Time: 0.020s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到<code>mysql</code> 中确实创建了表.</p><p>当然可以对<code>Model</code> 添加字段做修改,然后从新创建新的迁移脚本,并升级或降级数据库版本.</p><p>需要注意的是:</p><p><code>Alembic</code> 对表名的更改,列名的更改,匿名约束等检测的不够准确,有时候是需要去<code>versions</code> 文件夹中找到相关的字段做修改的.</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/wechat.png" alt="wechat"></p><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">文彦</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://blog.kningyuan.eu.org/posts/48390.html">https://blog.kningyuan.eu.org/posts/48390.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">文彦</a> !</span></div></div><script async defer>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})})</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Flask/"><span class="chip bg-color">Flask</span> </a><a href="/tags/Python/"><span class="chip bg-color">Python</span> </a><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span> </a><a href="/tags/alembic/"><span class="chip bg-color">alembic</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/valine/av-min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/valine/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"4D08X5mQ4KUr126NW8IvCzQ7-gzGzoHsz",appKey:"W8Ga6qdP1wi5QLHkirRTdK96",notify:!1,verify:!1,visitor:!0,avatar:"mm",pageSize:"10",lang:"zh-cn",placeholder:"ヾﾉ≧∀≦)o来啊，快活啊!"})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/47601.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/featureimages/4.jpg" class="responsive-img" alt="登录浏览P站"> <span class="card-title">登录浏览P站</span></div></a><div class="card-content article-content"><div class="summary block-with-text">部署浏览Pixiv</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-09-07 </span><span class="publish-author"><i class="fas fa-bookmark fa-fw icon-category"></i> <a href="/categories/Heroku-Shadowsocks/" class="post-category">Heroku Shadowsocks</a></span></div></div><div class="card-action article-tags"><a href="/tags/Heroku/"><span class="chip bg-color">Heroku</span> </a><a href="/tags/Shadowsocks/"><span class="chip bg-color">Shadowsocks</span> </a><a href="/tags/Pixiv/"><span class="chip bg-color">Pixiv</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/9793.html"><div class="card-image"><img src="https://tva1.sinaimg.cn/large/a20ab060ly1gij70iu9q8j20rl0f574j.jpg" class="responsive-img" alt="博客更新评论系统"> <span class="card-title">博客更新评论系统</span></div></a><div class="card-content article-content"><div class="summary block-with-text">valine评论</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-09-05 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> 文彦</span></div></div><div class="card-action article-tags"><a href="/tags/hexo/"><span class="chip bg-color">hexo</span> </a><a href="/tags/valine/"><span class="chip bg-color">valine</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0===window.getSelection||(""+(n=window.getSelection())).length<Number.parseInt("120")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: 文彦笔记<br />文章作者: 文彦<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200))})</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),collapseDepth:Number("0"),headingSelector:"h1,  h2, h3, h4, h5, h6"});let t=0,e="toc-heading-",n=($("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h1,  h2, h3, h4, h5, h6").each(function(){$(this).attr("id",e+ ++t)}),parseInt(.4*$(window).height()-64)),o=$(".toc-widget");$(window).scroll(function(){$(window).scrollTop()>n?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});const i="expanded";let a=$("#toc-aside"),c=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){a.hasClass(i)?(a.removeClass(i).hide(),c.removeClass("l9")):(a.addClass(i).show(),c.addClass("l9"));var e="artDetail";if(0!==(e=$("#artDetail")).length){let t=e.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#prenext-posts").width(t)}})})</script></main><footer class="page-footer bg-color"><script data-ad-client="ca-pub-4337512190549598" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="container row center-align" style="margin-bottom:0!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019</span> <a href="/about" target="_blank">文彦 </a>|&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp; <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/ningwenyan" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:ningyanke@outlook.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//js/search.js"></script><script type="text/javascript">$(function(){searchFunc("https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?407f502eb914179baa7e4efa6da65a6e",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e)}()</script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/others/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/instantpage/instantpage.js" type="module"></script><script type="text/javascript" color="122 103 238" opacity="0.7" zindex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"https://cdn.jsdelivr.net/npm/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},react:{opacity:.7}})</script></body></html>