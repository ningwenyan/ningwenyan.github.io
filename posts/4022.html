<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="Flask MySQL SQLAlchemy"><meta name="description" content="Python | Flask |  MySQL | Linux | Ubuntu"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>SQLAlchemy总结 | 文彦笔记</title><link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//favicon.png"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//css/matery.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//css/my.css"><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/jquery/jquery.min.js"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4337512190549598" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="文彦笔记" type="application/atom+xml"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">文彦笔记</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fas fa-comments" style="zoom:.6"></i> <span>留言板</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">文彦笔记</div><div class="logo-desc">Python | Flask | MySQL | Linux | Ubuntu</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/contact" class="waves-effect waves-light"><i class="fa-fw fas fa-comments"></i> 留言板</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/ningwenyan" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>Fork Me</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/ningwenyan" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="Fork Me" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><div class="bg-cover pd-header post-cover" style="background-image:url(https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10229.png)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">SQLAlchemy总结</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{margin:35px 0 15px 0;padding-left:17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{height:calc(100vh - 250px);overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/Flask/"><span class="chip bg-color">Flask</span> </a><a href="/tags/Python/"><span class="chip bg-color">Python</span> </a><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span> </a><a href="/tags/SQLAlchemy/"><span class="chip bg-color">SQLAlchemy</span></a></div></div><div class="col s5 right-align"></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2020-08-27</div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><p>[TOC]</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10229.png" alt="10229"></p><h2 id="SQLAlchemy总结"><a href="#SQLAlchemy总结" class="headerlink" title="SQLAlchemy总结"></a><code>SQLAlchemy</code>总结</h2><h3 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h3><blockquote><p><code>SQLAlchemy</code>是和数据库交互的一个库,他支持<code>postgresql,mysql,oracle,ms.sql</code>等等主流的数据库.虽然各个厂商使用的<code>SQL</code>语言不通,但是<code>SQLAlcyhemy</code> 在底层封装了她们,可以使用一套标准来操作数据库.</p><p>官网:<code>https://docs.sqlalchemy.org/en/13/</code></p><p><code>SQLAlchemy</code>构成:</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/sqlalchemy.jpg" alt="sqlalchemy"></p><p>最主要的构成部分是<code>SQLAlchemy Core</code>和<code>SQLAlchemy ORM</code>两大部分.</p><ul><li><code>SQLAlchemy Core</code>:基于<code>Scheme</code>,类似传统的<code>SQL</code>语句.<ul><li><code>scheme/types</code>:内部实现了类和表的对应</li><li><code>SQL Expression Language</code>:封装好的<code>SQL</code>语句.</li><li><code>Engine</code>:一个数据库的连接<ul><li><code>connection pooling</code>:连接池</li><li><code>Dlalect</code>:根据<code>Engine</code> 的定义,调用不同的数据库<code>API</code> (比如<code>mysql+pymysql</code>)</li></ul></li></ul></li><li><code>SQLAlchemy ORM</code>: <code>ORM</code> ,关系对象映射,更好的从面向对象的角度去操作数据库.下面着重讨论<code>ORM</code>.</li></ul></blockquote><h3 id="2-什么是ORM"><a href="#2-什么是ORM" class="headerlink" title="2.什么是ORM"></a>2.什么是<code>ORM</code></h3><blockquote><p><code>ORM:(Object-Relationship Mapping)</code>:对象关系映射.</p><p>对象和关系数据是业务实体的两种表现形式.业务实体在内存中表现为对象,在数据库中表现为关系数据.内存中的对象之间存在关联和继承关系.而在数据库中,关系数据无法直接表达多对多关联和继承关系.因此,<code>ORM</code> 一般以中间件的形式存在,主要实现程序对象到关系数据库数据的映射.</p><p>数据库中的表都是二维表,它的基本结构是行和列.如果一张表的内容用<code>python</code> 的数据结构表示出来的话,可以用一个<code>list</code> 来表示,它类似与<code>list((1,2))</code> .在<code>list</code> 中包裹<code>tuple</code> 来表示一行记录.</p><p>比如,一张包含<code>id</code>,<code>name</code>的<code>user</code> 表</p><pre class="line-numbers language-python"><code class="language-python">user <span class="token operator">=</span> <span class="token punctuation">[</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Bob'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Harry'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Python</code> 的<code>DB-API</code> 返回的数据结构就类似上面这样的.</p><p>但是使用<code>tuple</code> 来表示一行,很难看出表的结构.比如在<code>mysql</code> 中也存在一张<code>Users</code>表.</p><pre class="line-numbers language-sql"><code class="language-sql">mysql root<span class="token variable">@192.168.101</span>:test<span class="token operator">></span> <span class="token keyword">desc</span> Users<span class="token punctuation">;</span>                                                                                                                                                                           
<span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> Field    <span class="token operator">|</span> <span class="token keyword">Type</span>        <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> id       <span class="token operator">|</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>     <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> PRI <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span>  <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> name     <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span>  <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> fullname <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span>  <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> password <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span>  <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------+------+-----+---------+-------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>SQL</code> 语句中的约束,非空,数据类型等等,根本不能使用一个单独的<code>list</code> 来表示.</p><p>但是如果把一个<code>tuple</code> 用<code>class</code> 实例来表示,就更容易看出表的结构</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Integer</span><span class="token punctuation">:</span>
     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>x <span class="token operator">=</span> int<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">String</span><span class="token punctuation">:</span>
      <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
         self<span class="token punctuation">.</span>x <span class="token operator">=</span> str<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>
     <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> id<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
         self<span class="token punctuation">.</span>id <span class="token operator">=</span> Interger<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
         self<span class="token punctuation">.</span>name <span class="token operator">=</span> String<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

user <span class="token operator">=</span> <span class="token punctuation">[</span>
    User<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'Jack'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    User<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'Bob'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    User<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'Harry'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当然<code>ORM</code> 框架实现的并不是这么简单的,但是类似与这样把数据库的表结构映射在对象上,就是<code>ORM</code>.</p><p>而做这个工作的就是<code>ORM</code> 框架,在<code>Python</code> 中最有名的框架就是<code>SQLAlchemy</code>.</p><p><code>ORM</code> 的优缺点:</p><ul><li>提高开发效率,提高代码重用</li><li>是开发更加的抽象</li><li>可移植,不只是局限在<code>mysql</code>,可以是<code>MS-SQL</code>,<code>orcal</code> 等.</li><li>可以方便的引入一些附加功能等.</li><li>自动化进行关系数据库的映射需要消耗系统性.</li><li>在处理多表联查,<code>where</code>子句中复杂条件时,<code>ORM</code> 的语法会变得复杂.</li></ul></blockquote><h3 id="3-开启MySQL的记录查询功能"><a href="#3-开启MySQL的记录查询功能" class="headerlink" title="3.开启MySQL的记录查询功能"></a>3.开启<code>MySQL</code>的记录查询功能</h3><blockquote><p>此方法为临时打开记录查询功能.<code>MySQL</code>服务重启会恢复关闭,在此打开只是为了测试<code>SQLAlchemy</code>功能.</p><pre class="line-numbers language-sql"><code class="language-sql">❯ mycli <span class="token operator">-</span>u root <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.101</span>

mysql root<span class="token variable">@192.168.0.101</span>:<span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'general%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+---------------------------+</span>
<span class="token operator">|</span> Variable_name    <span class="token operator">|</span> <span class="token keyword">Value</span>                     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+---------------------------+</span>
<span class="token operator">|</span> general_log      <span class="token operator">|</span> <span class="token keyword">OFF</span>                       <span class="token operator">|</span>
<span class="token operator">|</span> general_log_file <span class="token operator">|</span> <span class="token operator">/</span>mysql_data<span class="token operator">/</span>localhost<span class="token punctuation">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+---------------------------+</span>


mysql root<span class="token variable">@192.168.0.101</span>:<span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">set</span> <span class="token keyword">GLOBAL</span> general_log<span class="token operator">=</span><span class="token string">'ON'</span>                

mysql root<span class="token variable">@192.168.0.101</span>:<span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token operator">></span> <span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'general%'</span><span class="token punctuation">;</span>          
<span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+---------------------------+</span>
<span class="token operator">|</span> Variable_name    <span class="token operator">|</span> <span class="token keyword">Value</span>                     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+---------------------------+</span>
<span class="token operator">|</span> general_log      <span class="token operator">|</span> <span class="token keyword">ON</span>                        <span class="token operator">|</span>
<span class="token operator">|</span> general_log_file <span class="token operator">|</span> <span class="token operator">/</span>mysql_data<span class="token operator">/</span>localhost<span class="token punctuation">.</span>log <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------------------+---------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意:以<code>general_log_file</code>文件为准则,查看记录.</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 远程到MySQL服务器</span>
$ <span class="token function">ssh</span> root@192.168.0.101

<span class="token comment" spellcheck="true"># 查看SQL语句记录</span>
root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># cat  /mysql_data/localhost.log </span>
/var/mysql/bin/mysqld, Version: 5.7.20 <span class="token punctuation">(</span>MySQL Server <span class="token punctuation">(</span>GPL<span class="token punctuation">))</span>. started with:
Tcp port: 3306  Unix socket: /var/lib/mysql/mysql.sock
Time                 Id Command    Argument
2020-08-23T07:03:58.785556Z       16 Query    show variables like <span class="token string">'general%'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="4-SQLAlchemy与数据库的逻辑对应"><a href="#4-SQLAlchemy与数据库的逻辑对应" class="headerlink" title="4.SQLAlchemy与数据库的逻辑对应"></a>4.<code>SQLAlchemy</code>与数据库的逻辑对应</h3><blockquote><table><thead><tr><th><code>SQLAlchemy</code></th><th><code>MySQL</code></th><th>说明</th></tr></thead><tbody><tr><td><code>Engine()</code></td><td>连接数据库</td><td></td></tr><tr><td><code>Session()</code></td><td>连接池</td><td><code>Session</code>是<code>Query</code>的入口</td></tr><tr><td><code>Model</code></td><td>表</td><td><code>Python</code> 中类对应数据库的表,它用面向对象的形式来表现数据库中的表</td></tr><tr><td><code>Column</code></td><td>列</td><td>支持运算符操作,<code>Python</code>类中定义了<code>Column</code></td></tr><tr><td><code>Query</code></td><td>行</td><td>可以对单行或多行操作(增删改查)</td></tr></tbody></table></blockquote><h3 id="5-连接数据库"><a href="#5-连接数据库" class="headerlink" title="5.连接数据库"></a>5.连接数据库</h3><blockquote><p>首先安装所需要的包.</p><pre class="line-numbers language-bash"><code class="language-bash">$ conda activate learnpy
$ conda <span class="token function">install</span> pymysql
$ conda <span class="token function">install</span> sqlalchemy<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>安装完毕后,可以查看当前安装的<code>sqlalchemy</code>版本来验证是否安装成功.</p><pre class="line-numbers language-bash"><code class="language-bash">$ python
<span class="token operator">>></span><span class="token operator">></span> <span class="token function">import</span> sqlalchemy
<span class="token operator">>></span><span class="token operator">></span> sqlalchemy.__version__
<span class="token string">'1.3.18'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><hr><p>连接数据库:<code>dialect</code>用于和数据<code>API</code>进行交流,根据配置文件的不同的数据库<code>API</code>,从而实现对数据库的操作.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span>SQLAPI<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># MySQL-Python</span>
SQLAPI<span class="token operator">=</span><span class="token string">'mysql+mysqldb://&lt;user>:&lt;password>@&lt;host>[:&lt;port>]/&lt;dbname>'</span>'

<span class="token comment" spellcheck="true"># pymysql</span>
SQLAPI<span class="token operator">=</span><span class="token string">'mysql+pymysql://&lt;username>:&lt;password>@&lt;host>/&lt;dbname>[?&lt;options>]'</span>

<span class="token comment" spellcheck="true"># MySQL-Connector</span>
SQLAPI<span class="token operator">=</span><span class="token string">'mysql+mysqlconnector://&lt;user>:&lt;password>@&lt;host>[:&lt;port>]/&lt;dbname>'</span>

<span class="token comment" spellcheck="true"># cx_Oracle</span>
SQLAPI<span class="token operator">=</span><span class="token string">'oracle+cx_oracle://user:pass@host:port/dbname[?key=value&amp;key=value...]'</span>

<span class="token comment" spellcheck="true"># 更多详见:https://docs.sqlalchemy.org/en/latest/dialects/index.html</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>我们这里使用的是<code>pymysql</code>,由于<code>API</code>中需要提供数据库,这里我们在<code>MySQL</code>中创建一个测试数据库:</p><pre class="line-numbers language-sql">mysql root@192.168.0.101:(none)&gt; create database sqlalchemy; </pre><p>然后尝试连接数据库:</p><pre><code class="python"><code class="language-sql">mysql root@192.168.0.101:(none)&gt; create database sqlalchemy; </code></code></pre><p>然后尝试连接数据库:</p><pre><code class="python">>>> from sqlalchemy import create_engine
>>> engine = create_engine('mysql+pymysql://root:2008.Cn123@192.168.0..101:3306/sqlalchemy',echo=True)
# echo=True  表示能看到所有的SQL输出,
# 开启了mysql数据库的数据日志以后,可以通过mysql查看连接和语句的执行
# cat /mysql_data/localhost.log mysql_data/bogon.log <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>初次调用<code>create_engine()</code>的时候并不会真正的去连接数据库.只有在真正执行一条命令的时候才会去尝试建立连接.</p></blockquote><h3 id="6-创建会话"><a href="#6-创建会话" class="headerlink" title="6.创建会话"></a>6.创建会话</h3><blockquote><p>在<code>sqlalchemy</code> 中,控制连接语柄的是<code>Session</code>.</p><p><code>Session</code> 相当于一个会话池.所有与数据库的交互都通过它来运行.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token operator">>></span><span class="token operator">></span> Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>如果还没有创建<code>engine</code> ,先创建了<code>Session</code> ,可以通过<code>Session.configure(bind=engine)</code> 来绑定数据库连接.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> Session<span class="token punctuation">.</span>configure<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># once engine is available</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>不管是哪一种,只要开始和数据库进行交互,就需要从<code>Session</code> 池中实例化一个<code>session</code> 对象来操作</p><pre class="line-numbers language-python">&gt;&gt;&gt; session = Session()</pre><p>当一个<code>session</code> 不使用的时候,就需要手动的去关闭它.</p><pre><code class="python">&gt;&gt;&gt; session.close()</code></pre><p><code>Session</code> 具有以下特性:</p><ul><li><code>Session</code> 会在需要的时候(比如用户读取数据,更新数据时)和数据库进行通信,获取数据对象,并有一个池子来维护这些对象,保证访问数据时不出现意外的问题.</li><li><code>Session</code> 和 <code>connection</code> 不等同,<code>Session</code>会通过<code>connection</code>和数据库通信</li><li><code>Session</code>是<code>Query</code> 查询 的入口</li></ul><p>当实例化<code>Session</code> 会话之后,实例对象<code>session</code> 有几个特别的属性和方法</p><ul><li><code>flush()</code>:这个方法会将当前<code>session</code> 存在的变更发给数据库,也就是会执行<code>SQL</code>语句</li><li><code>commit()</code>:提交事务,一个事务可能包含多条<code>SQL</code>语句</li><li><code>autoflush</code>:默认为<code>True</code> ,<code>session</code> 在查询之前会自动把当前积累的修改发送给数据库.注意:这里是查询的时候(<code>query</code>),并不是在执行<code>session.add()</code>的时候.</li><li><code>autocommit()</code>:默认为<code>False</code>,自动提交事务,默认为不提交,这意味着,执行完任何关于数据的语句后,要执行<code>commit()</code> 命令来提交给数据库.</li></ul></blockquote><h3 id="7-创建映射-Model"><a href="#7-创建映射-Model" class="headerlink" title="7.创建映射(Model)"></a>7.创建映射(<code>Model</code>)</h3><blockquote><p>在<code>Python</code> 中一切接对象,<code>mysql</code> 数据库是关系型数据库,这里要做的就是,把表映射为<code>Python</code> 的一个类.让我们以对象的方式来操作表.</p><ul><li>首先描述将要处理的数据库表</li><li>然后定义包含指令的类</li><li>将类映射到表 映射的类必须根据基类来定义.这个基类维护相对于该基类的类和表的目录,这称为声明性基类.使用 <code>declarative_base</code>(declarative 声明)来创建基类</li></ul><hr><p>使用<code>sublime</code>创建一个文件</p><pre><code class="python"><code class="language-python">&gt;&gt;&gt; session = Session()</code></code></pre><p>当一个<code>session</code> 不使用的时候,就需要手动的去关闭它.</p><pre><code class="python">&gt;&gt;&gt; session.close()</code></pre><p><code>Session</code> 具有以下特性:</p><ul><li><code>Session</code> 会在需要的时候(比如用户读取数据,更新数据时)和数据库进行通信,获取数据对象,并有一个池子来维护这些对象,保证访问数据时不出现意外的问题.</li><li><code>Session</code> 和 <code>connection</code> 不等同,<code>Session</code>会通过<code>connection</code>和数据库通信</li><li><code>Session</code>是<code>Query</code> 查询 的入口</li></ul><p>当实例化<code>Session</code> 会话之后,实例对象<code>session</code> 有几个特别的属性和方法</p><ul><li><code>flush()</code>:这个方法会将当前<code>session</code> 存在的变更发给数据库,也就是会执行<code>SQL</code>语句</li><li><code>commit()</code>:提交事务,一个事务可能包含多条<code>SQL</code>语句</li><li><code>autoflush</code>:默认为<code>True</code> ,<code>session</code> 在查询之前会自动把当前积累的修改发送给数据库.注意:这里是查询的时候(<code>query</code>),并不是在执行<code>session.add()</code>的时候.</li><li><code>autocommit()</code>:默认为<code>False</code>,自动提交事务,默认为不提交,这意味着,执行完任何关于数据的语句后,要执行<code>commit()</code> 命令来提交给数据库.</li></ul></blockquote><h3 id="7-创建映射-Model"><a href="#7-创建映射-Model" class="headerlink" title="7.创建映射(Model)"></a>7.创建映射(<code>Model</code>)</h3><blockquote><p>在<code>Python</code> 中一切接对象,<code>mysql</code> 数据库是关系型数据库,这里要做的就是,把表映射为<code>Python</code> 的一个类.让我们以对象的方式来操作表.</p><ul><li>首先描述将要处理的数据库表</li><li>然后定义包含指令的类</li><li>将类映射到表 映射的类必须根据基类来定义.这个基类维护相对于该基类的类和表的目录,这称为声明性基类.使用 <code>declarative_base</code>(declarative 声明)来创建基类</li></ul><hr><p>使用<code>sublime</code>创建一个文件</p><pre><code class="python">#!/usr/bin/env python
# coding=utf-8

from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, Integer, String


# 1.连接数据库
engine = create_engine('mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy')

# 2.创建Session
Session = sessionmaker(bind=engine)

# 3.实例化session
session = Session()

# 4.创建Model
# 创建基类
Base = declarative_base()

# 创建映射
class TestUser_1(Base):
    """ __tablename 必须存在,指定数据库表名 """
    __tablename__ = 'testuser_1'

    id = Column(Integer, primary_key = True) # primary_key是必须的
    first_name = Column(String(50))
    last_name = Column(String(50))
    password = Column(String(50))

    def __repr__(self):
        """这是非必须的,为了更友好的数据演示"""
        return  '<testuser_1 (first_name="{}," last_name="{}," password="{})">'.format(self.first_name, self.last_name, self.password )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></testuser_1></code></pre><p>注意: <code>__talbename__</code> 是必须的存在的,它的值是数据库中的表名.而且表中的主键列必须存在.</p><p>类构建成功后,就定义了表的元数据信息.<code>sqlalchemy</code> 用来呈现这些信息的对象称为<code>Table</code>对象,可以使用<code>TestUser_1.__table__</code>参数来查看这个对象.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>TestUser_1<span class="token punctuation">.</span>__table__<span class="token punctuation">)</span>
sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>Table

<span class="token operator">>></span><span class="token operator">></span> TestUser_1<span class="token punctuation">.</span>__table__
Table<span class="token punctuation">(</span><span class="token string">'testuser_1'</span><span class="token punctuation">,</span> MetaData<span class="token punctuation">(</span>bind<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">,</span> Column<span class="token punctuation">(</span><span class="token string">'id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token operator">=</span><span class="token operator">&lt;</span>testuser_1<span class="token operator">></span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Column<span class="token punctuation">(</span><span class="token string">'first_name'</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token operator">=</span><span class="token operator">&lt;</span>testuser_1<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> Column<span class="token punctuation">(</span><span class="token string">'last_name'</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token operator">=</span><span class="token operator">&lt;</span>testuser_1<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> Column<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token operator">=</span><span class="token operator">&lt;</span>testuser_1<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> schema<span class="token operator">=</span>None<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 这是一个Table对象,也可以称为 元数据信息</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据这个元数据信息,<code>sqlalchemy</code> 可以使用<code>metadata.create_all(engine)</code> 来创建绑定到<code>Base&#39;</code> 基类上的表,需要注意的是这个方法不能更新表的内容(也就是不能使用<code>alter</code>语句).<code>metadata.drop_all(engine)</code>,用来删除绑定到<code>Base</code>基类上的表</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># Base 是我们创建的基类.这个命令可以生成 绑定到 Base上的表</span>
<span class="token operator">>></span><span class="token operator">></span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 删除绑定到Base上的表</span>
<span class="token operator">>></span><span class="token operator">></span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看数据库日志:</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">tail</span> -10  /mysql_data/localhost.log 
2020-08-23T09:09:56.856411Z        4 Query    CREATE TABLE testuser_1 <span class="token punctuation">(</span>
    <span class="token function">id</span> INTEGER NOT NULL AUTO_INCREMENT, 
    first_name VARCHAR<span class="token punctuation">(</span>50<span class="token punctuation">)</span>, 
    last_name VARCHAR<span class="token punctuation">(</span>50<span class="token punctuation">)</span>, 
    password VARCHAR<span class="token punctuation">(</span>50<span class="token punctuation">)</span>, 
    PRIMARY KEY <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span>
2020-08-23T09:09:56.878901Z        4 Query    COMMIT
2020-08-23T09:09:56.883521Z        4 Query    ROLLBACK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="1-Column-的数据类型"><a href="#1-Column-的数据类型" class="headerlink" title="1.Column 的数据类型"></a>1.<code>Column</code> 的数据类型</h4><blockquote><p><code>sqlalchemy</code>与<code>mysql</code>中常用的数据类型相对应</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 可以通过sqlalchemy导入数据类型</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> String<span class="token punctuation">,</span>Date<span class="token punctuation">,</span>DateTime<span class="token punctuation">,</span>Integer<span class="token punctuation">,</span>Float<span class="token punctuation">,</span>Boolean<span class="token punctuation">,</span>DECIMAL<span class="token punctuation">,</span>Time<span class="token punctuation">,</span>Enum<span class="token punctuation">,</span>Text<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><table><thead><tr><th><code>Mysql</code></th><th><code>SQLAlchemy</code></th></tr></thead><tbody><tr><td><code>smallint</code></td><td><code>Boolean</code></td></tr><tr><td><code>int</code></td><td><code>Integer</code></td></tr><tr><td><code>float</code></td><td><code>Float</code></td></tr><tr><td><code>decimal</code>定点数</td><td><code>DECIMAL</code></td></tr><tr><td><code>date</code></td><td><code>Date</code></td></tr><tr><td><code>datetime</code></td><td><code>DateTime</code></td></tr><tr><td><code>time</code></td><td><code>Time</code></td></tr><tr><td><code>enum</code></td><td><code>Enum</code></td></tr><tr><td><code>text</code></td><td><code>TEXT</code></td></tr></tbody></table><hr><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 通过 sqlalchemy.dialects.mysql 导入更多的Mysql支持的数据类型</span>
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>dialects<span class="token punctuation">.</span>mysql <span class="token keyword">import</span> DOUBLE<span class="token punctuation">,</span>LONGTEXT<span class="token punctuation">,</span>YEAR<span class="token punctuation">,</span>LONGBLOB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>假设创建如图的<code>Model</code></p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10115.png" alt="10115"></p><p>新建一个<code>python</code>文件</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env/python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>dialects<span class="token punctuation">.</span>mysql <span class="token keyword">import</span>  LONGTEXT<span class="token punctuation">,</span>DOUBLE


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Article</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'articles'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    author <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    detail <span class="token operator">=</span> Column<span class="token punctuation">(</span>LONGTEXT<span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>Date<span class="token punctuation">)</span>
    create_time_1 <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    create_time_2 <span class="token operator">=</span> Column<span class="token punctuation">(</span>Time<span class="token punctuation">)</span>
    author_Introduction <span class="token operator">=</span>  Column<span class="token punctuation">(</span>Text<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    category  <span class="token operator">=</span> Column<span class="token punctuation">(</span>Enum<span class="token punctuation">(</span><span class="token string">'Python'</span><span class="token punctuation">,</span> <span class="token string">'Java'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    price <span class="token operator">=</span>  Column<span class="token punctuation">(</span>DECIMAL<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行:</p><pre class="line-numbers language-bash">$ python 2column数据类型.py</pre><p>查看数据库并验证:</p><pre><code class="sql"><code class="language-bash">$ python 2column数据类型.py</code></code></pre><p>查看数据库并验证:</p><pre><code class="sql">mysql root@192.168.0.101:sqlalchemy> show tables;     
+----------------------+
| Tables_in_sqlalchemy |
+----------------------+
| articles             |
| testuser_1           |
+----------------------+

mysql root@192.168.0.101:sqlalchemy> show create table articles;        
+----------+--------------------------------------------------+
| Table    | Create Table                                     |
+----------+--------------------------------------------------+
| articles | CREATE TABLE `articles` (                        |
|          |   `id` int(11) NOT NULL AUTO_INCREMENT,          |
|          |   `author` varchar(45) DEFAULT NULL,             |
|          |   `detail` longtext,                             |
|          |   `create_time` date DEFAULT NULL,               |
|          |   `create_time_1` datetime DEFAULT NULL,         |
|          |   `create_time_2` time DEFAULT NULL,             |
|          |   `author_Introduction` text,                    |
|          |   `category` enum('Python','Java') DEFAULT NULL, |
|          |   `price` decimal(8,4) DEFAULT NULL,             |
|          |   PRIMARY KEY (`id`)                             |
|          | ) ENGINE=InnoDB DEFAULT CHARSET=utf8             |
+----------+--------------------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>也可以通过<code>mysql</code>服务器查看日志</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token comment" spellcheck="true"># 需要ssh到192.168.0.101</span>
<span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -20 /mysql_data/localhost.log</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><p>在上面文件的基础上可以尝试添加数据</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 2column数据类型.py</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
art1 <span class="token operator">=</span> Article<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>author<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">,</span>detail<span class="token operator">=</span><span class="token string">'This is a test. sqlalchemy connect mysql.'</span><span class="token punctuation">,</span>
            create_time<span class="token operator">=</span>date<span class="token punctuation">(</span>year<span class="token operator">=</span><span class="token number">2001</span><span class="token punctuation">,</span>month<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>day<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            create_time_1<span class="token operator">=</span>datetime<span class="token punctuation">(</span>year<span class="token operator">=</span><span class="token number">2017</span><span class="token punctuation">,</span>month<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>day<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>hour<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>minute<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>second<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>microsecond<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            create_time_2<span class="token operator">=</span>time<span class="token punctuation">(</span>hour<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>minute<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>second<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">,</span>microsecond<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            author_introduction<span class="token operator">=</span><span class="token string">'Popular People'</span><span class="token punctuation">,</span>
            category<span class="token operator">=</span><span class="token string">'Python'</span><span class="token punctuation">,</span>
            price<span class="token operator">=</span><span class="token number">8888.8888</span>
            <span class="token punctuation">)</span>

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>art1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>下面会详细讲解添加数据.</p></blockquote><h4 id="2-Column列级别约束"><a href="#2-Column列级别约束" class="headerlink" title="2.Column列级别约束"></a>2.<code>Column</code>列级别约束</h4><blockquote><p><code>SQL</code> 语法中,约束分为表级别约束和列级别约束.</p><p>列级别约束:</p><ul><li><code>PRIMARY KEY</code>:主键约束</li><li><code>FOREIGN KEY</code>:外键约束,不允许重复</li><li><code>UNIQUE</code>:唯一性约束</li><li><code>NOT NULL</code>:非空约束</li><li><code>DEFAULT</code>:默认约束</li><li><code>CHECK</code>: 检查约束</li></ul><p>表级别约束:</p><ul><li><code>PRIMARY KEY</code>:主键约束</li><li><code>FOREIGN KEY</code>:外键约束,不允许重复</li><li><code>UNIQUE</code>:唯一性约束</li></ul><p>他们的区别是:</p><ul><li>列级别约束只能应用与一列上,而表级别约束可以用在多个列上.</li><li>列级别约束直接跟在列后,不用指定列名.而表级别约束必须指定约束列名称.</li></ul><hr><p>这里的<code>Column</code> 函数主要是用来定义列级别的约束的.</p><p><code>SQLAlchemy</code> 与<code>Mysql</code> 中常用约束的对应.</p><hr><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Culumn
<span class="token comment" spellcheck="true"># Column 中自带的属性</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><table><thead><tr><th><code>SQLAlchemy</code></th><th><code>MySQL</code></th></tr></thead><tbody><tr><td><code>primary_key=True</code></td><td><code>PRIMARY KEY</code></td></tr><tr><td>需要导入模块</td><td><code>FOREIGN KEY</code></td></tr><tr><td><code>unique=True</code></td><td><code>UNIQUE</code></td></tr><tr><td><code>nullable=True</code></td><td><code>NOT NULL</code></td></tr><tr><td><code>default=xxx</code></td><td><code>DEFAULT</code></td></tr><tr><td><code>name</code></td><td>指定类的别名<code>AS</code></td></tr><tr><td><code>autoincrement=True</code></td><td><code>AUTO_INCREMENT</code></td></tr><tr><td><code>comment</code> 列的描述字符</td><td><code>COMMENT</code></td></tr><tr><td><code>index=primary_key</code></td><td><code>INDEX</code></td></tr></tbody></table><hr><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#  需要导入 外键 类来实现Column中外键的约束</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> ForeignKey

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'child'</span>    
    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'Parent'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    child_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Interger<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'child.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 这里指定的是表名和字段   </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="3-表级别约束"><a href="#3-表级别约束" class="headerlink" title="3.表级别约束"></a>3.表级别约束</h4><blockquote><p><a href="https://docs.sqlalchemy.org/en/13/core/constraints.html?highlight=primarykeyconstraint#primary-key-constraint" target="_blank" rel="noopener">官网</a></p><p><code>Column</code> 中定义了列级别的约束.如果要定义表级别的约束,需要导入相关的模块</p><pre class="line-numbers language-python">from sqlalchemy import ForeignKeyConstraint,UniqueConstraint,PrimaryKeyConstraint</pre><p>它的创建类似与这样</p><pre><code class="python"><code class="language-python">from sqlalchemy import ForeignKeyConstraint,UniqueConstraint,PrimaryKeyConstraint</code></code></pre><p>它的创建类似与这样</p><pre><code class="python"># 表级别外键约束
from sqlalcemy import Table
# 注意,这里导入的是 Table 对象

invoice_item = Table('invoice_item', metadata,
     Column('item_id', Integer, primary_key=True),
    Column('item_name', String(60), nullable=False),
     Column('invoice_id', Integer, nullable=False),
     Column('ref_num', Integer, nullable=False),
     ForeignKeyConstraint(['invoice_id', 'ref_num'], ['invoice.invoice_id', 'invoice.ref_num'])
)

# 表级别唯一约束
mytable = Table('mytable', metadata,
    # per-column anonymous unique constraint
     Column('col1', Integer, unique=True),

     Column('col2', Integer),
     Column('col3', Integer),

     # explicit/composite unique constraint.  'name' is optional.
     UniqueConstraint('col2', 'col3', name='uix_1')
 )

# 主键约束
my_table = Table('mytable', metadata,
    Column('id', Integer),
    Column('version_id', Integer),
    Column('data', String(50)),
    PrimaryKeyConstraint('id', 'version_id', name='mytable_pk')
     )<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="8-单表操作"><a href="#8-单表操作" class="headerlink" title="8.单表操作"></a>8.单表操作</h3><blockquote><p>首先创建如下映射表:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'users'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fullname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__repr__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""非必须,说明"""</span>
        <span class="token keyword">return</span> <span class="token string">'&lt;User(name={}, fullname={}, passoword={})'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>self<span class="token punctuation">.</span>name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span> self<span class="token punctuation">.</span>password<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行</p><pre class="line-numbers language-bash">$ python 3单表操作.py</pre><p>以下是利用<code>session</code>对象的<code>query</code> 去增删改查数据库中的表.</p></blockquote><h4 id="1-表的操作-增-insert-into"><a href="#1-表的操作-增-insert-into" class="headerlink" title="1.表的操作-增(insert into)"></a>1.表的操作-增(<code>insert into</code>)</h4><blockquote><p>在<code>mysql</code>中查看表</p><pre><code class="sql"><code class="language-bash">$ python 3单表操作.py</code></code></pre><p>以下是利用<code>session</code>对象的<code>query</code> 去增删改查数据库中的表.</p></blockquote><h4 id="1-表的操作-增-insert-into"><a href="#1-表的操作-增-insert-into" class="headerlink" title="1.表的操作-增(insert into)"></a>1.表的操作-增(<code>insert into</code>)</h4><blockquote><p>在<code>mysql</code>中查看表</p><pre><code class="sql">mysql root@192.168.0.101:sqlalchemy> show tables;     
+----------------------+
| Tables_in_sqlalchemy |
+----------------------+
| articles             |
| testuser_1           |
| users                |
+----------------------+


mysql root@192.168.0.101:sqlalchemy> show create table users;   
+-------+-----------------------------------------+
| Table | Create Table                            |
+-------+-----------------------------------------+
| users | CREATE TABLE `users` (                  |
|       |   `id` int(11) NOT NULL AUTO_INCREMENT, |
|       |   `name` varchar(45) DEFAULT NULL,      |
|       |   `fullname` varchar(45) DEFAULT NULL,  |
|       |   `password` varchar(45) DEFAULT NULL,  |
|       |   PRIMARY KEY (`id`)                    |
|       | ) ENGINE=InnoDB DEFAULT CHARSET=utf8    |
+-------+-----------------------------------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>session.add()</code>或<code>session.add_all()</code>来插入数据.</p><hr><p>为了方便,以下将使用<code>jupyter-notebook</code>建立<code>ORM</code>映射并操作.</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10221.png" alt="10221"></p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 新生成一个实例</span>
<span class="token operator">>></span><span class="token operator">></span> instance1 <span class="token operator">=</span> User<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'testA'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'testA H'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'testA'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># session.add 添加实例</span>
<span class="token operator">>></span><span class="token operator">></span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>instance1<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 上面我们说过 session 是 autoflush=True,但是 autocommit=False</span>
<span class="token comment" spellcheck="true"># 所以这里虽然 add 添加了数据,但是并没有 commit 提交数据,事务是不完整的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>当我们没有执行<code>query</code>之前,还没有<code>flush</code>到数据库中,而且并没有写入数据库</p><pre class="line-numbers language-bash">&gt;&gt;&gt; query1 = session.query(User).all()</pre><p>执行完后,就可以在<code>MySQL</code>日志文件中查看</p><pre><code class="bash"><code class="language-bash">&gt;&gt;&gt; query1 = session.query(User).all()</code></code></pre><p>执行完后,就可以在<code>MySQL</code>日志文件中查看</p><pre><code class="bash">$ tail -20 /mysql_data/localhost.log
...

INSERT INTO users (id, name, fullname, password) VALUES (1, 'testA', 'testA H', 'testA')
SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password 
FROM users<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以在日志中查看到<code>insert into</code>语句,如果在数据库中查看文件</p><pre class="line-numbers language-sql"><code class="language-sql">mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users<span class="token punctuation">;</span>     
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+----------+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span> fullname <span class="token operator">|</span> password <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+----------+----------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到表中是没有数据的,因为并没有执行<code>session.commit()</code>,并没有提交数据到数据库.</p><p>提交事务:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 如果不使用session 需要关闭它</span>
<span class="token comment" spellcheck="true"># session.close()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>插入多条数据:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># session.add_all 添加要给列表</span>
session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>
 User<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'wendy'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'wendy williams'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'foobar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 User<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'mary'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'mary C'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'xxg'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 User<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fred'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'fred nn'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 提交事务</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 关闭 session</span>
<span class="token comment" spellcheck="true"># session1.close()</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看数据库:</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> users<span class="token punctuation">;</span>          
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------+----------------+----------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name  <span class="token operator">|</span> fullname       <span class="token operator">|</span> password <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------+----------------+----------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> testA <span class="token operator">|</span> testA H        <span class="token operator">|</span> <span class="token number">123456</span>   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> wendy <span class="token operator">|</span> wendy williams <span class="token operator">|</span> foobar   <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> mary  <span class="token operator">|</span> mary C         <span class="token operator">|</span> xxg      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> fred  <span class="token operator">|</span> fred nn        <span class="token operator">|</span> <span class="token number">123</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------+----------------+----------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="2-表的操作-删-delete"><a href="#2-表的操作-删-delete" class="headerlink" title="2.表的操作-删(delete)"></a>2.表的操作-删(<code>delete</code>)</h4><blockquote><p>在<code>mysql</code> 数据库中删除数据使用<code>delete</code> 语句,对应到<code>sqlalchemy</code>中:</p><ul><li>批量删除:<code>session.query().delete()</code>方法,可以删除单个或多个.<a href="https://docs.sqlalchemy.org/en/13/orm/query.html?highlight=query#sqlalchemy.orm.query.Query.delete" target="_blank" rel="noopener">扩展阅读</a></li><li>删除单个:<code>session.delete(instance)</code>.<a href="https://docs.sqlalchemy.org/en/13/orm/session_api.html?highlight=delete#sqlalchemy.orm.session.Session.delete" target="_blank" rel="noopener">扩展阅读</a></li></ul><p>删除数据:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 删除数据</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> or_

q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>or_<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id <span class="token operator">></span><span class="token number">3</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>id<span class="token operator">==</span><span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code> 日志:</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -20 /mysql_data/localhost.log</span>
<span class="token punctuation">..</span>.
DELETE FROM <span class="token function">users</span> WHERE users.id <span class="token operator">></span> 3 OR users.id <span class="token operator">=</span> 3
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>也可以使用另外一种删除方式:</p><pre class="line-numbers language-python"><code class="language-python">q3 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q3<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="3-表的操作-改-‘update’"><a href="#3-表的操作-改-‘update’" class="headerlink" title="3.表的操作-改(‘update’)"></a>3.表的操作-改(‘update’)</h4><blockquote><p>在<code>mysql</code> 数据库中增加数据使用<code>update</code> 语句,对应到<code>sqlalchemy</code> 中,</p><ul><li>批量更新.它使用的是<code>session.query().update()</code> 的方法.<a href="https://docs.sqlalchemy.org/en/13/orm/query.html?highlight=query#sqlalchemy.orm.query.Query.update" target="_blank" rel="noopener">阅读</a></li></ul><p>更改<code>id=1</code> 的行的<code>password</code> 字段</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 更改,更改id=1的password</span>

<span class="token comment" spellcheck="true"># 注意:update 加入的是一个 dict数据类型</span>
q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">'password'</span><span class="token punctuation">:</span><span class="token string">'new_passwd'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q4<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code>日志</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -20 /mysql_data/localhost.log</span>
<span class="token punctuation">..</span>.
Query    UPDATE <span class="token function">users</span> SET password<span class="token operator">=</span><span class="token string">'new_passwd'</span> WHERE users.id <span class="token operator">=</span> 1
Query    COMMIT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="4-表的操作-查-select"><a href="#4-表的操作-查-select" class="headerlink" title="4.表的操作-查(select)"></a>4.表的操作-查(<code>select</code>)</h4><blockquote><p>在<code>mysql</code> 数据库中增加数据使用<code>select</code> 语句,对应到<code>sqlalchemy</code> 中,它使用的是<code>session.query()</code> 的方法.</p></blockquote><h5 id="1-基本查询"><a href="#1-基本查询" class="headerlink" title="1.基本查询"></a>1.基本查询</h5><blockquote><ol><li>查询表的信息</li></ol><pre class="line-numbers language-mysql"><code class="language-mysql"># 查询单张表
>>> q5 = session.query(User)

>>> print(q5)
"""
SELECT `Users`.id AS `Users_id`, `Users`.name AS `Users_name`, `Users`.fullname AS `Users_fullname`, `Users`.password AS `Users_password` 
FROM `Users`
"""
# 它返回的对象是一个可迭代对象,可以使用 for 读取其中的信息
>>> print(type(q5))
"""
<class 'sqlalchemy.orm.query.Query'>
"""
>>> from collections import Iterable
>>> isinstance(q5, Iterable)
# True

>>> for instance in session1.query(User):
>>>     print(instance.id, instance.name)

"""
1 testA
2 wendy
"""<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="2"><li>查询表的字段</li></ol><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 查询表的字段</span>
q6 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">,</span> User<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q6<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT users.id AS users_id, users.name AS users_name 
FROM users
"""</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> q6<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>id<span class="token punctuation">,</span>i<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
1 testA
2 wendy
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="3"><li>通过查询,可以构造一个<code>python</code>对象</li></ol><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 查询表和字段,返回一个列表包裹的元组</span>

q7 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 返回所有的行</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q7<span class="token punctuation">)</span>
type<span class="token punctuation">(</span>q7<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
[&lt;User(name=testA, fullname=testA H, passoword=new_passwd), &lt;User(name=wendy, fullname=wendy williams, passoword=foobar)]

list
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="4"><li>为查询的字段起别名,相当于<code>mysql</code>的<code>as</code>字句</li></ol><pre class="line-numbers language-python"><code class="language-python">q8 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">'myid'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q8<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> q8<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>myid<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
SELECT users.id AS myid 
FROM users 
WHERE users.id &lt; %(id_1)s
1
2
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="5"><li>查询多个字段,可一个给多个字段起一个别名</li></ol><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> aliased
<span class="token operator">>></span><span class="token operator">></span> user_alias <span class="token operator">=</span> aliased<span class="token punctuation">(</span>User<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'user_alias'</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">for</span> row <span class="token keyword">in</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>user_alias<span class="token punctuation">,</span> user_alias<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span>user_alias<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h5 id="2-查询时where子句"><a href="#2-查询时where子句" class="headerlink" title="2.查询时where子句"></a>2.查询时<code>where</code>子句</h5><blockquote><p>在<code>sqlalchemy</code> 中,它使用的是<code>session.query().filter()</code> 方法来表示<code>mysql</code> 中的<code>where</code> 子句.</p><p>主要有2个方法:</p><ul><li><code>fiter_by()</code>: 使用关键字表达式<code>session.query(MyClass).filter_by(name = &#39;some name&#39;, id = 5)</code></li><li><code>filter()</code>:使用的是<code>class.attribute</code> 的方式</li></ul><p>在<code>filter()</code>中对应的判断条件有:</p><table><thead><tr><th><code>SQL</code></th><th><code>SQLAlchemy</code></th><th>举例</th><th>说明</th></tr></thead><tbody><tr><td><code>=</code></td><td><code>==</code></td><td><code>query.filter(user.name == &#39;jack&#39;)</code></td><td></td></tr><tr><td><code>!=</code></td><td><code>!=</code></td><td><code>query.filter(user.name != &#39;jack&#39;)</code></td><td></td></tr><tr><td><code>&gt;,&lt;</code></td><td><code>&gt;,&lt;</code></td><td><code>query.filter(user.id&gt;3)</code></td><td></td></tr><tr><td><code>like</code></td><td><code>like</code></td><td><code>query.filter(user.name.like(&#39;%Jack&#39;))</code></td><td>区分大小写</td></tr><tr><td></td><td><code>ilike</code></td><td><code>query.filter(user.name.ilike(&#39;%Jack&#39;))</code></td><td>不区分大小写</td></tr><tr><td><code>in</code></td><td><code>in_</code></td><td><code>query.filter(user.name.in_([&#39;A&#39;,&#39;B&#39;]))</code></td><td><code>in_(列表)</code></td></tr><tr><td><code>not in</code></td><td><code>~ in_</code></td><td><code>query.filter(~ user.name.in_([&#39;A&#39;,&#39;B&#39;]))</code></td><td><code>~</code>取反</td></tr><tr><td><code>is null</code></td><td><code>== None</code></td><td><code>query.filter(user.name == None)</code></td><td></td></tr><tr><td><code>not null</code></td><td><code>!=None</code></td><td><code>query.filter(user.name !=None)</code></td><td></td></tr><tr><td><code>and</code></td><td><code>and_</code></td><td><code>form sqlalchemy import and_</code></td><td></td></tr><tr><td><code>or</code></td><td><code>or_</code></td><td><code>from sqlalchemy import or_</code></td><td></td></tr><tr><td><code>match</code></td><td><code>match</code></td><td><code>query.filter(user.name.match(&#39;A&#39;))</code></td><td></td></tr></tbody></table><ul><li><code>in_</code>讲解</li></ul><pre class="line-numbers language-python"><code class="language-python">query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in_<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ed'</span><span class="token punctuation">,</span> <span class="token string">'wendy'</span><span class="token punctuation">,</span> <span class="token string">'jack'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 叠加使用</span>
query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span>in_<span class="token punctuation">(</span>
session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">'%ed%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># use tuple_() for composite (multi-column) queries</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> tuple_
query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>
tuple_<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">,</span> User<span class="token punctuation">.</span>nickname<span class="token punctuation">)</span><span class="token punctuation">.</span>\
in_<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">'ed'</span><span class="token punctuation">,</span> <span class="token string">'edsnickname'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">'wendy'</span><span class="token punctuation">,</span> <span class="token string">'windy'</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># not in </span>
<span class="token comment" spellcheck="true"># 使用~取反</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>and_</code> 讲解</li></ul><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># use and_()</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_
query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>and_<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>fullname <span class="token operator">==</span> <span class="token string">'Ed Jones'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 可以不写and, 某人逗号隔开,表示并列</span>
query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>fullname <span class="token operator">==</span> <span class="token string">'Ed Jones'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 多个filter表示,并列关系</span>
query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>fullname <span class="token operator">==</span> <span class="token string">'Ed Jones'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>or_</code> 讲解</li></ul><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 使用 or_  包裹变量</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> or_
query<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>or_<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'ed'</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'wendy'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>等等</p></blockquote><h5 id="3-查询返回的列表-多个实例-以及标量-一个实例"><a href="#3-查询返回的列表-多个实例-以及标量-一个实例" class="headerlink" title="3.查询返回的列表(多个实例)以及标量(一个实例)"></a>3.查询返回的列表(多个实例)以及标量(一个实例)</h5><blockquote><p>包含一些<code>SQL</code>语句<code>where</code>字句后的判断条件<code>order by</code> ,<code>count</code>,<code>limit</code> 等</p><p>注意:<code>get(indet)</code> :<code>indet</code>用来指定主键的值,可以是一个列表,如<code>[5,7]</code>.它的返回对象是一个实例,也就是<code>select</code>查询后的实例,而其他执行<code>query().filter()</code>返回的是一个可迭代对象,需要去迭代其中的实例.</p><table><thead><tr><th>方法,属性</th><th>说明</th></tr></thead><tbody><tr><td><code>all()</code></td><td>返回一个列表,根据主键对列表条目进行删除,如果有2个主键相同,只保留一行,不适用于查询各个列的情况</td></tr><tr><td><code>get(key)</code></td><td>返回指定主键的行</td></tr><tr><td><code>one()</code></td><td>完全匹配所有的行,如果返回的结果是多行,或者没有匹配到,报错</td></tr><tr><td><code>one_or_none</code></td><td>和<code>one()</code>相同,匹配不到,返回None,匹配多行,报错</td></tr><tr><td><code>first()</code></td><td>对查询结果进行了一个限制-返回列表的第一个值</td></tr><tr><td><code>scalar()</code></td><td>援引自<code>one()</code>函数,查询成功之后会返回这一行的第一列的参数</td></tr><tr><td><code>count()</code></td><td>计数,计算一个数据出现的次数</td></tr><tr><td><code>limit(n)</code></td><td>返回<code>n</code>个数据</td></tr><tr><td><code>distinct()</code></td><td>不重复</td></tr><tr><td><code>order_by()</code></td><td>排序</td></tr><tr><td><code>add_columns()</code></td><td>添加查询列</td></tr><tr><td><code>offset(n)</code></td><td>偏移<code>n</code> 个数据后开始查询数据</td></tr><tr><td><code>slice(start, stop)</code></td><td>切片操作,查询中间的数据</td></tr><tr><td>`query()[start, stop]</td><td>实现和切片<code>slice</code>同样的操作</td></tr></tbody></table></blockquote><blockquote><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># all()</span>
<span class="token comment" spellcheck="true"># 返回一个列表,根据主键对列表条目进行删除,如果有2个主键相同,只保留一行,不适用于查询各个列的情况</span>
<span class="token comment" spellcheck="true"># 比如 id=7 有两行数据,只能保留一行</span>
query_all <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string">'t%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>query_all<span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

query_first <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string">'t%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>query_first<span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

query_one <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>name<span class="token punctuation">.</span>ilike<span class="token punctuation">(</span><span class="token string">'t%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>query_one<span class="token punctuation">.</span>one<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

limit_obj <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>limit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>limit_obj<span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># add.columns 实例</span>
<span class="token comment" spellcheck="true">## add_columns</span>
aaa <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>User<span class="token punctuation">.</span>id <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>add_column<span class="token punctuation">(</span>Column<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>aaa<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT `Users`.id AS `Users_id`, name 
FROM `Users` 
WHERE `Users`.id > %(id_1)s
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h5 id="4-聚合查询"><a href="#4-聚合查询" class="headerlink" title="4.聚合查询"></a>4.聚合查询</h5><blockquote><p><code>mysql</code>聚合函数:<code>max,min,sum,count</code></p><p>使用聚合查询时,需要导入相关的模块</p><pre class="line-numbers language-python">from sqlalchemy import func</pre><p>可以构造一个<code>book</code> 表.表中存放书籍的价格,如下:</p><pre><code class="python"><code class="language-python">from sqlalchemy import func</code></code></pre><p>可以构造一个<code>book</code> 表.表中存放书籍的价格,如下:</p><pre><code class="python">from sqlalchemy import create_engine
from sqlalchemy import Column,Integer,String
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from sqlalchemy import func
import random

# 1.创建Engine

connect_msg = 'mysql+pymysql://root:2008.Cn123@192.168.0.101/test'
engine=create_engine(connect_msg)

# 2.创建 Session
Session = sessionmaker(bind=engine)
session = Session()

# 3.创建基类
Base = declarative_base()

# 4.Model
class Book(Base):
__tablename__ = 'book'
id = Column(Integer,primary_key=True)
price = Column(Integer)

Base.metadata.create_all(engine)

session.add_all([
Book(id=1, price=random.randint(1,256)),
Book(id=2, price=random.randint(1,256)),
Book(id=3, price=random.randint(1,256)),
Book(id=4, price=random.randint(1,256)),
Book(id=5, price=random.randint(1,256)),
Book(id=6, price=random.randint(1,256))
])
session.commit()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后利用<code>func</code> 函数的特性,使用聚合函数查询</p><pre class="line-numbers language-python"><code class="language-python">q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>min<span class="token punctuation">(</span>Book<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT min(book.price) AS min_1 
FROM book
"""</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>max<span class="token punctuation">(</span>Book<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT max(book.price) AS max_1 
FROM book
"""</span>
<span class="token comment" spellcheck="true"># id 列一定是不重复的,可以根据id列查询一共有多少行数据</span>
q3 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>Book<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q3<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT count(book.id) AS count_1 
FROM book
"""</span>
q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>sum<span class="token punctuation">(</span>Book<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q4<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT sum(book.price) AS sum_1 
FROM book
"""</span>
q5 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>func<span class="token punctuation">.</span>avg<span class="token punctuation">(</span>Book<span class="token punctuation">.</span>price<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q5<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT avg(book.price) AS avg_1 
FROM book
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="9-事务回滚"><a href="#9-事务回滚" class="headerlink" title="9.事务回滚"></a>9.事务回滚</h3><blockquote><p>会话<code>session</code> 主要是用来处理与数据库相关的连接的.那么<code>session</code> 也应该能处理基本的事务回滚.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 添加一个新事物对象</span>
fake_name <span class="token operator">=</span> User<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'fakename'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'fakename H'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'123'</span><span class="token punctuation">)</span>

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>fake_name<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>添加完毕后,可以通过<code>query</code>来<code>flush</code>数据库中</p><pre class="line-numbers language-python">q9 = session.query(User).filter(User.name == &#39;fakename&#39;).all()</pre><p>可以查看<code>fake_name</code>这个实例是在<code>session</code>中的,而且没有提交</p><pre><code class="python"><code class="language-python">q9 = session.query(User).filter(User.name == &#39;fakename&#39;).all()</code></code></pre><p>可以查看<code>fake_name</code>这个实例是在<code>session</code>中的,而且没有提交</p><pre><code class="python">fake_name in session
# True<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>执行回滚</p><pre class="line-numbers language-python">session.rollback()</pre><p>再次查看<code>fake_name</code>这个实例</p><pre><code class="python"><code class="language-python">session.rollback()</code></code></pre><p>再次查看<code>fake_name</code>这个实例</p><pre><code class="python">fake_name in session
# False<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看<code>mysql</code>的查询日志</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">tail</span> -10  /mysql_data/localhost.log
<span class="token punctuation">..</span>.
2020-08-23T10:51:42.946715Z        7 Query    INSERT INTO <span class="token function">users</span> <span class="token punctuation">(</span>id, name, fullname, password<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>5, <span class="token string">'fakename'</span>, <span class="token string">'fakename H'</span>, <span class="token string">'123'</span><span class="token punctuation">)</span>
2020-08-23T10:51:42.948944Z        7 Query    SELECT users.id AS users_id, users.name AS users_name, users.fullname AS users_fullname, users.password AS users_password 
FROM <span class="token function">users</span> 
WHERE users.name <span class="token operator">=</span> <span class="token string">'fakename'</span>
2020-08-23T10:52:24.595121Z        7 Query    ROLLBACK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到明显的<code>ROLLBACK</code>,回滚操作.</p></blockquote><h3 id="10-外键约束"><a href="#10-外键约束" class="headerlink" title="10.外键约束"></a>10.外键约束</h3><blockquote><p>在<code>SQL</code> 语句中,外键约束基于两种</p><ul><li>基于表的外键约束.</li><li>基于列的外键约束.</li></ul><p>在<code>SQLAlchemy</code> 中,可以实现基于数据库的外键约束</p><ul><li>基于表的外键约束.</li><li>基于列的外键约束.</li></ul><p>但是<code>SQLAlchemy</code> 作为<code>ORM</code> ,在实现了数据库级别的外键约束后,并不能实现在<code>ORM</code> 层面的外键约束.<a href="https://docs.sqlalchemy.org/en/13/orm/relationship_api.html?highlight=relationship#sqlalchemy.orm.relationship.params.cascade" target="_blank" rel="noopener">查看这里</a><a href="https://docs.sqlalchemy.org/en/13/orm/cascades.html?highlight=cascade" target="_blank" rel="noopener">级联</a></p><pre class="line-numbers language-python"><code class="language-python">help<span class="token punctuation">(</span>ForiegnKey<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ptional string<span class="token punctuation">.</span> If set<span class="token punctuation">,</span> emit ON DELETE <span class="token operator">&lt;</span>value<span class="token operator">></span> when  issuing DDL <span class="token keyword">for</span> this constraint<span class="token punctuation">.</span> Typical values include CASCADE<span class="token punctuation">,</span>DELETE <span class="token operator">and</span> RESTRICT
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

help<span class="token punctuation">(</span>relationship<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
comma<span class="token operator">-</span>separated list of cascade rules which determines how Session operations should be “cascaded” <span class="token keyword">from</span> parent to child<span class="token punctuation">.</span> This defaults to <span class="token boolean">False</span><span class="token punctuation">,</span> which means the default cascade should be used <span class="token operator">-</span> this default cascade <span class="token keyword">is</span> <span class="token string">"save-update, merge"</span><span class="token punctuation">.</span>
The available cascades are save<span class="token operator">-</span>update<span class="token punctuation">,</span> merge<span class="token punctuation">,</span> expunge<span class="token punctuation">,</span> delete<span class="token punctuation">,</span> delete<span class="token operator">-</span>orphan<span class="token punctuation">,</span> <span class="token operator">and</span> refresh<span class="token operator">-</span>expire<span class="token punctuation">.</span> An additional option<span class="token punctuation">,</span> all indicates shorthand <span class="token keyword">for</span> <span class="token string">"save-update, merge, refresh-expire, expunge, delete"</span><span class="token punctuation">,</span> <span class="token operator">and</span> <span class="token keyword">is</span> often used <span class="token keyword">as</span> <span class="token keyword">in</span> <span class="token string">"all, delete-orphan"</span> to indicate that related objects should follow along <span class="token keyword">with</span> the parent object <span class="token keyword">in</span> all cases<span class="token punctuation">,</span> <span class="token operator">and</span> be deleted when de<span class="token operator">-</span>associated<span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>所谓不能实现在<code>ORM</code>中,指的是虽然在<code>MySQL</code> 客户端上,<code>DDL</code> 语句操作实现了外键约束,但是在<code>python</code> 中使用<code>SQLAlchemy</code> 语句仍然能删除数据中记录,并设置为<code>NULL</code> ,原因就是<code>relationship</code> 的<code>cascade</code> 默认是<code>save-update, merge</code>.把它设置成<code>all, delete-orphan</code>之后,就可以产生级联删除,而不是设置成<code>NONE</code>.</p><hr><p>讨论基于列的外键约束,基于表的外键约束同理,写法相同.</p><p>有以下表结构:</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10222.png" alt="10222"></p><p>对应的<code>SQL</code>语句如下:</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 类别表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> categoryes<span class="token punctuation">(</span>
    c_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    c_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    c_description  <span class="token keyword">text</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span><span class="token operator">=</span>utf8 <span class="token keyword">comment</span><span class="token operator">=</span><span class="token string">"类别表"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 商家表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> vendors<span class="token punctuation">(</span>
    v_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    v_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>v_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span><span class="token operator">=</span><span class="token string">'供应商'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 产品表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> products<span class="token punctuation">(</span>
    p_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    p_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    p_price <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    c_id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    v_id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>p_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> fk_products_categoryes
    <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span>
    <span class="token keyword">references</span> categoryes<span class="token punctuation">(</span>c_id<span class="token punctuation">)</span>
    <span class="token keyword">on</span> <span class="token keyword">delete</span> <span class="token keyword">set</span> <span class="token boolean">null</span>
    <span class="token keyword">on</span> <span class="token keyword">update</span> <span class="token keyword">cascade</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> fk_products_vendors
    <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>v_id<span class="token punctuation">)</span>
    <span class="token keyword">references</span> vendors<span class="token punctuation">(</span>v_id<span class="token punctuation">)</span>
    <span class="token keyword">on</span> <span class="token keyword">delete</span> <span class="token keyword">no</span> <span class="token keyword">action</span>
    <span class="token keyword">on</span> <span class="token keyword">update</span> <span class="token keyword">cascade</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">auto_increment</span><span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">default</span> char <span class="token keyword">set</span><span class="token operator">=</span>utf8 <span class="token keyword">comment</span><span class="token operator">=</span><span class="token string">"产品表"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>python</code>创建如下:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env/python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Categoryes</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'categoryes'</span>

    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    c_description <span class="token operator">=</span> Column<span class="token punctuation">(</span>Text<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 设置双向关系,指定的是类方法</span>
    products <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'categoryes'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Vendors</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'vendors'</span>

    v_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    v_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    products <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'vendors'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Products</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'products'</span>

    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    p_price <span class="token operator">=</span> Column<span class="token punctuation">(</span>DECIMAL<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'categoryes.c_id'</span> <span class="token punctuation">,</span>  ondelete<span class="token operator">=</span><span class="token string">'SET NULL'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># 外键指定的是表的字段</span>
    v_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'vendors.v_id'</span><span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">'NO ACTION'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    categoryes <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Categoryes'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">)</span>
    vendors <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Vendors'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
<span class="token comment" spellcheck="true"># Base.metadata.create_all(engine)</span>

<span class="token comment" spellcheck="true"># 查询数据</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Categoryes<span class="token punctuation">)</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Vendors<span class="token punctuation">)</span>
q3 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Products<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 内连接,类的属性就直接代表了他们的relationship</span>
q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Products<span class="token punctuation">.</span>p_id<span class="token punctuation">,</span> Products<span class="token punctuation">.</span>p_name<span class="token punctuation">,</span> Categoryes<span class="token punctuation">.</span>c_name<span class="token punctuation">,</span> Vendors<span class="token punctuation">.</span>v_name<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>and_<span class="token punctuation">(</span>Products<span class="token punctuation">.</span>c_id <span class="token operator">==</span> Categoryes<span class="token punctuation">.</span>c_id<span class="token punctuation">,</span> Products<span class="token punctuation">.</span>v_id <span class="token operator">==</span> Vendors<span class="token punctuation">.</span>v_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'q1:'</span><span class="token punctuation">,</span> q1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'q2:'</span><span class="token punctuation">,</span> q1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'q3:'</span><span class="token punctuation">,</span> q1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'q4:'</span><span class="token punctuation">,</span> q1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'----'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>和<code>MySQL</code>的外键语句相同,<code>on delete action\on update action</code> 如下对应</p><table><thead><tr><th><code>SQLAlchemy</code></th><th><code>MySQL</code></th></tr></thead><tbody><tr><td><code>RESTRICT</code></td><td><code>RESTRICT</code>:默认,不能删除外键连接的数据</td></tr><tr><td><code>NO ACTION</code></td><td><code>NO ACTION</code>: 同<code>RESTRICT</code></td></tr><tr><td><code>CASCADE</code></td><td><code>CASCADE</code>: 级联,做同样的操作</td></tr><tr><td><code>SET NULL</code></td><td><code>SET NULL</code>: 父表删除数据时,子表外键数据设置为<code>NULL</code>(约束不能为<code>not null</code>)</td></tr></tbody></table><p>如果是表级别的外键约束,则可以写成:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> ForeignKeyConstraint

<span class="token keyword">class</span> <span class="token class-name">Products</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'products'</span>

    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    p_price <span class="token operator">=</span> Column<span class="token punctuation">(</span>DECIMAL<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>
    v_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 表级别的外键约束</span>
    ForeignKeyConstraint<span class="token punctuation">(</span>c_id<span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">'SET NULL'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span>
    ForeignKeyConstraint<span class="token punctuation">(</span>v_id<span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">'NO ACTION'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 双向关系.</span>
    categoryes <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Categoryes'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">)</span>
    vendors <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Vendors'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>在数据库中插入数据:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 插入数据</span>
c1 <span class="token operator">=</span> Categoryes<span class="token punctuation">(</span>c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> c_name<span class="token operator">=</span><span class="token string">'fruit'</span><span class="token punctuation">,</span> c_description<span class="token operator">=</span><span class="token string">'水果'</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Categoryes<span class="token punctuation">(</span>c_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c_name<span class="token operator">=</span><span class="token string">'book'</span><span class="token punctuation">,</span> c_description<span class="token operator">=</span><span class="token string">'书籍'</span><span class="token punctuation">)</span>

v1 <span class="token operator">=</span> Vendors<span class="token punctuation">(</span>v_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> v_name<span class="token operator">=</span><span class="token string">'USA'</span><span class="token punctuation">)</span>
v2 <span class="token operator">=</span> Vendors<span class="token punctuation">(</span>v_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> v_name<span class="token operator">=</span><span class="token string">'China'</span><span class="token punctuation">)</span>

p1 <span class="token operator">=</span> Products<span class="token punctuation">(</span>p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p_name<span class="token operator">=</span><span class="token string">'Apple'</span><span class="token punctuation">,</span> p_price<span class="token operator">=</span><span class="token number">1001.0001</span><span class="token punctuation">,</span>c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> v_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
p2 <span class="token operator">=</span> Products<span class="token punctuation">(</span>p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> p_name<span class="token operator">=</span><span class="token string">'Banany'</span><span class="token punctuation">,</span> p_price<span class="token operator">=</span><span class="token number">1001.0001</span><span class="token punctuation">,</span>c_id<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> v_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> v1<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> p1<span class="token punctuation">,</span> p2<span class="token punctuation">]</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看当前<code>products</code>表</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------+------------------------------------------------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>           <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----------+------+------------------------------------------------------------------+</span>
<span class="token operator">|</span> products        <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>products<span class="token punctuation">`</span> <span class="token punctuation">(</span>                                        <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token punctuation">`</span>p_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>                        <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token punctuation">`</span>p_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>                                 <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token punctuation">`</span>p_price<span class="token punctuation">`</span> <span class="token keyword">decimal</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>                               <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token punctuation">`</span>c_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>                                   <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token punctuation">`</span>v_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>                                   <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>p_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                          <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>c_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>c_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                           <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">KEY</span> <span class="token punctuation">`</span>v_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>v_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                           <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>products_ibfk_1<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>c_id<span class="token punctuation">`</span><span class="token punctuation">)</span>              <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>categoryes<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>c_id<span class="token punctuation">`</span><span class="token punctuation">)</span>                               <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">SET</span> <span class="token boolean">NULL</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span><span class="token punctuation">,</span>                          <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>products_ibfk_2<span class="token punctuation">`</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>v_id<span class="token punctuation">`</span><span class="token punctuation">)</span>              <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>vendors<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>v_id<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">NO</span> <span class="token keyword">ACTION</span>              <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span>   <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span>                                              <span class="token operator">|</span>
<span class="token operator">|</span>                 <span class="token operator">|</span> <span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8                             <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----------+-------------------------------------------------------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尝试在数据库中删除<code>categoryes</code>表中数据，然后查看外键引用变化</p><pre class="line-numbers language-sql"><code class="language-sql">mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">delete</span> <span class="token keyword">from</span> categoryes <span class="token keyword">where</span> c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 

mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> products<span class="token punctuation">;</span>      
<span class="token operator">+</span><span class="token comment" spellcheck="true">------+--------+-----------+--------+------+</span>
<span class="token operator">|</span> p_id <span class="token operator">|</span> p_name <span class="token operator">|</span> p_price   <span class="token operator">|</span> c_id   <span class="token operator">|</span> v_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------+--------+-----------+--------+------+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> Apple  <span class="token operator">|</span> <span class="token number">1001.0001</span> <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span> Banany <span class="token operator">|</span> <span class="token number">1001.0001</span> <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">------+--------+-----------+--------+------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到最后在外键<code>products</code>表中<code>c_id</code>变成了<code>null</code>.</p><p>尝试使用<code>sqlalchemy</code>删除数据</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> q2<span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Vendors<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Vendors<span class="token punctuation">.</span>v_id<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

IntegrityError <span class="token punctuation">:</span><span class="token punctuation">(</span>pymysql<span class="token punctuation">.</span>err<span class="token punctuation">.</span>IntegrityError<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1048</span><span class="token punctuation">,</span> <span class="token string">"Column 'v_id' cannot be null"</span><span class="token punctuation">)</span>
<span class="token punctuation">[</span>SQL<span class="token punctuation">:</span> UPDATE products SET v_id<span class="token operator">=</span><span class="token operator">%</span><span class="token punctuation">(</span>v_id<span class="token punctuation">)</span>s WHERE products<span class="token punctuation">.</span>p_id <span class="token operator">=</span> <span class="token operator">%</span><span class="token punctuation">(</span>products_p_id<span class="token punctuation">)</span>s<span class="token punctuation">]</span>
<span class="token punctuation">[</span>parameters<span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">'v_id'</span><span class="token punctuation">:</span> None<span class="token punctuation">,</span> <span class="token string">'products_p_id'</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它会产生一个<code>IntegrityError</code> .这是由于没有设置<code>relationship</code>中的级联模式.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span>Integer<span class="token punctuation">,</span>Text<span class="token punctuation">,</span>DECIMAL<span class="token punctuation">,</span>String<span class="token punctuation">,</span>ForeignKey
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship

<span class="token comment" spellcheck="true"># 1.创建连接</span>
connect_msg <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101/test'</span>
engine<span class="token operator">=</span>create_engine<span class="token punctuation">(</span>connect_msg<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 实例化 Session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建 Model</span>

<span class="token keyword">class</span> <span class="token class-name">Categoryes</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     __tablename__ <span class="token operator">=</span> <span class="token string">'categoryes'</span>

     c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
     c_description <span class="token operator">=</span> Column<span class="token punctuation">(</span>Text<span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 设置双向关系 指定的是 类方法</span>
     products <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span>  back_populates<span class="token operator">=</span><span class="token string">'categoryes'</span><span class="token punctuation">,</span>cascade<span class="token operator">=</span><span class="token string">'all, delete-orphan'</span><span class="token punctuation">,</span>single_parent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Products</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     __tablename__ <span class="token operator">=</span> <span class="token string">'products'</span>

     p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
     p_price <span class="token operator">=</span> Column<span class="token punctuation">(</span>DECIMAL<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 外键连接的是 表.字段</span>
     c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'categoryes.c_id'</span><span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">'SET NULL'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     v_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'vendors.v_id'</span><span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">'NO ACTION'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'CASCADE'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     categoryes <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Categoryes'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">,</span>cascade<span class="token operator">=</span><span class="token string">'all, delete-orphan'</span><span class="token punctuation">,</span>single_parent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     vendors <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Vendors'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">,</span> cascade<span class="token operator">=</span><span class="token string">'all, delete-orphan'</span><span class="token punctuation">,</span>single_parent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Vendors</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     __tablename__ <span class="token operator">=</span> <span class="token string">'vendors'</span>

     v_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     v_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     products <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'vendors'</span><span class="token punctuation">,</span>cascade<span class="token operator">=</span><span class="token string">'all, delete-orphan'</span><span class="token punctuation">,</span>single_parent<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 尝试删除 级联模式的 外键数据</span>

q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Vendors<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>以上删除成功,因为这里是多对多的关系,必须使用参数<code>single-parent=True</code> ,<a href="https://docs.sqlalchemy.org/en/13/orm/relationship_api.html?highlight=relationship#sqlalchemy.orm.relationship.params.single_parent" target="_blank" rel="noopener">参照</a>,如果设置为True,就会放置对象一次与多个父对象关联.多用于一对多,多对多关系中.</p></blockquote><h3 id="11-基本关系模式"><a href="#11-基本关系模式" class="headerlink" title="11.基本关系模式"></a>11.基本关系模式</h3><blockquote><p>基本的关系模式包括(基于外键的<code>FOREIGN_KEY</code>)来实现.包含如下：</p><ul><li>一对一</li><li>一对多</li><li>多对多</li></ul></blockquote><h4 id="1-一对多"><a href="#1-一对多" class="headerlink" title="1.一对多"></a>1.一对多</h4><blockquote><p>一对多,即A,B两个实体,A实体的属性a的数据对象可能需要多个实体B属性b的数据对象.而对于实体B的属性b来说,它只需要一个实体A属性a的数据对象.</p><p>所以,设置外键在实体B的属性b上,并指向了实体A的属性a.</p><p>如两张表<code>Parent_1</code>和<code>Child_1</code>存在如下关系:</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10225.png" alt="10225"></p><hr><p><code>MySQL</code>创建语句：</p><pre class="line-numbers language-sql"><code class="language-sql">zuse sqlalchemy<span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 创建表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> parent_1<span class="token punctuation">(</span>
    p_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    p_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>p_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"父亲表"</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> child_1<span class="token punctuation">(</span>
    c_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    c_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p_id <span class="token keyword">int</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> p_c_1 <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>p_id<span class="token punctuation">)</span> <span class="token keyword">references</span> parent_1<span class="token punctuation">(</span>p_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"父亲表"</span><span class="token punctuation">;</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p><code>SQLAlchemy</code>中对应模式<code>Model</code></p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>


<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Parent_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'parent_1'</span>

    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 注意，一对多 关系指定在 一的这里</span>
    <span class="token comment" spellcheck="true"># 创建一个属性，指向类Child_1</span>
    child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Child_1'</span><span class="token punctuation">)</span>



<span class="token keyword">class</span>  <span class="token class-name">Child_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'child_1'</span>

    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 注意，ForeignKey连接的是数据库的表</span>
    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent_1.p_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建成功后,尝试添加数据.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 继续在上面的文件中添加</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
p1 <span class="token operator">=</span> Parent_1<span class="token punctuation">(</span>p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> p_name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Child_1<span class="token punctuation">(</span>c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> c_name<span class="token operator">=</span><span class="token string">'Jack Child'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> c1<span class="token punctuation">]</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 查询数据</span>
q1  <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Parent_1<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Parent_1<span class="token punctuation">.</span>p_id<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 查询数据</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Child_1<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Child_1<span class="token punctuation">.</span>c_id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出</p><pre class="line-numbers language-bash"><code class="language-bash">$ python 5一对多.py
<span class="token operator">&lt;</span>__main__.Parent_1 object at 0x000001EAA1795DC8<span class="token operator">></span>
SELECT child_1.c_id AS child_1_c_id, child_1.c_name AS child_1_c_name, child_1.p_id AS child_1_p_id
FROM child_1
WHERE child_1.c_id <span class="token operator">=</span> %<span class="token punctuation">(</span>c_id_1<span class="token punctuation">)</span>s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看出,如果有<code>first()</code>会真正的执行语句,否则只会组成要执行的语句.通过查看日志可以更清晰的看到这点(并没有执行<code>q2</code>)</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cat</span> /mysql_data/localhost.log
INSERT INTO parent_1 <span class="token punctuation">(</span>p_id, p_name<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>1, <span class="token string">'Jack'</span><span class="token punctuation">)</span>
2020-08-23T15:23:39.047828Z       23 Query    INSERT INTO child_1 <span class="token punctuation">(</span>c_id, c_name, p_id<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>1, <span class="token string">'Jack Child'</span>, 1<span class="token punctuation">)</span>
2020-08-23T15:23:39.054213Z       23 Query    COMMIT
2020-08-23T15:23:39.069332Z       23 Query    ROLLBACK
2020-08-23T15:23:39.075472Z       23 Query    SELECT parent_1.p_id AS parent_1_p_id, parent_1.p_name AS parent_1_p_name 
FROM parent_1 
WHERE parent_1.p_id <span class="token operator">=</span> 1 
 LIMIT 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>注意:导入的<code>relationsihp()</code> 方法,会自动的设定一对多的关系,我们只需要在<code>一</code> 的关系方设定一个类属性指向<code>多</code> 的关系方的类就可以了.比如<code>children = relationship(&#39;Child1&#39;)</code></p><pre class="line-numbers language-bash"><code class="language-bash">help<span class="token punctuation">(</span>relationship<span class="token punctuation">)</span>
This corresponds to a parent-child or associative table relationship.
 The constructed class is an instance of
 :class:<span class="token variable"><span class="token variable">`</span>.RelationshipProperty<span class="token variable">`</span></span><span class="token keyword">.</span>

 A typical :func:<span class="token variable"><span class="token variable">`</span>.relationship<span class="token variable">`</span></span>, used <span class="token keyword">in</span> a classical mapping::

    mapper<span class="token punctuation">(</span>Parent, properties<span class="token operator">=</span><span class="token punctuation">{</span>
      <span class="token string">'children'</span><span class="token keyword">:</span> relationship<span class="token punctuation">(</span>Child<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 可以看到relationship() 函数对象中类似与一个mapping`对象,指明了父表与子表之间的联系.    </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="2-一对多双向关系"><a href="#2-一对多双向关系" class="headerlink" title="2.一对多双向关系"></a>2.一对多双向关系</h4><blockquote><p>以上,创建的都是单向关系.下面创建双向关系.</p><ul><li>单向关系:以上面为例,一个父亲知道自己有几个孩子,而孩子并不知道自己归属于那个父亲.</li><li>双向关系:以上面为例,一个父亲知道自己有几个孩子,而孩子也知道自己归属于那个父亲.</li><li>也就是说,通过<code>Parent_1</code> 可以检索到其拥有的<code>child</code> ,同时通过<code>Child_1</code> 也可以检索到其对应的<code>parent</code></li></ul><p>更多理解:客户知道自己有哪些订单,订单也知道自己归宿于哪个客户.也就是说,通过客户对象可以检索到其拥有哪些订单;同时,通过订单也可以查找到其对应的客户信息.这是符合我们业务逻辑需求.</p><p>对于上面的例子来说,只能通过<code>Parent_1.child</code> 来查看父表和子表的对应表,并不能从<code>Child_1</code>查找到父类的对应表.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 此为生成的 Parent1和 Child1的实例 p1.c1</span>
<span class="token comment" spellcheck="true"># p1 = Parent_11(p_id=1, p_name='Jack')</span>
<span class="token comment" spellcheck="true"># c1 = Child_1(c_id=1, c_name='Jack child', p_id=1)</span>

<span class="token comment" spellcheck="true"># 查看p1.child 此为 Parent_1和Child_1的对应表</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># sqlalchemy.orm.collections.InstrumentedList</span>
<span class="token comment" spellcheck="true"># 这是个list对象,从中读取它包含的内容</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> p1<span class="token punctuation">.</span>child<span class="token punctuation">:</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># &lt;__main__.Child1 object at 0x7f1219ca5710></span>
<span class="token comment" spellcheck="true"># 这是类 Child1的实例对象 内存地址</span>
<span class="token comment" spellcheck="true"># 转换成 10 进制</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>int<span class="token punctuation">(</span><span class="token number">0x7f1219ca5710</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 139715718829840</span>
<span class="token comment" spellcheck="true"># 产看 c1的内存地址</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>id<span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 139715718829840</span>
<span class="token comment" spellcheck="true"># 这基本验证了 relationship() 函数中是一个类 mapping 的对应表</span>
<span class="token comment" spellcheck="true"># 但是在 Child_1中没有与 Parent_1 对应的表结构</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果要建立双向对应关系,有2种方法,一种显式的创建,可读性好,一种是只指定一个函数<code>backref</code></p><hr><p>显示的创建：</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     __tablename__ <span class="token operator">=</span> <span class="token string">'parent_1'</span>
     p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 指定 back_populates 要严格的指向 Child_2 中的属性值的名字parent</span>
     child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Child_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     __tablename__ <span class="token operator">=</span> <span class="token string">'child_1'</span>
     c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 注意这里连接的数据库的表</span>
     p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent_1.p_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 指定 back_populates 要严格的指向 Parent_2 中的属性值的名字child</span>
     parent<span class="token operator">=</span>relationship<span class="token punctuation">(</span><span class="token string">'Parent_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'child'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果是在命令行创建,因为<code>Table</code> 对象<code>Parent_1</code>,<code>Child_1</code> ,也就是表映射已经创建完了,所以不能映射上,所以需要重开窗口从新创建.</p><hr><p>使用<code>backref</code></p><ul><li>使用这个函数,只需要在父类中指向子类的属性就可以了,子类并不要去创建属性.相对的可读性没有那么好.</li></ul><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     __tablename__ <span class="token operator">=</span> <span class="token string">'parent_1'</span>
     p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
     p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true"># 指定 back_populates 要严格的指向 Child_2 中的属性值的名字parent</span>
     child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Child_2'</span><span class="token punctuation">,</span> backref<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>验证双向连接</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>


<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Parent_3</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'parent_1'</span>

    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Child_3'</span><span class="token punctuation">,</span>  back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child_3</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'child_1'</span>
    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 注意这里连接的数据库的表</span>
    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent_1.p_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Parent_3'</span><span class="token punctuation">,</span>  back_populates<span class="token operator">=</span><span class="token string">'child'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 插入数据</span>
p1 <span class="token operator">=</span> Parent_3<span class="token punctuation">(</span>p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> p_name<span class="token operator">=</span><span class="token string">'Harry'</span><span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Child_3<span class="token punctuation">(</span>c_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> c_name<span class="token operator">=</span><span class="token string">'Harry child 1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Child_3<span class="token punctuation">(</span>c_id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> c_name<span class="token operator">=</span><span class="token string">'Harry child 2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 添加</span>
session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span> c1<span class="token punctuation">,</span> c2<span class="token punctuation">]</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 查看双向连接</span>
<span class="token comment" spellcheck="true"># 注意,查看实例的属性,而不是类的属性</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>p1<span class="token punctuation">.</span>child<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>id<span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>hex<span class="token punctuation">(</span>id<span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c1<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>id<span class="token punctuation">(</span>c1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>c2<span class="token punctuation">.</span>parent<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>id<span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出：</p><pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">[</span><span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Child_3 object at <span class="token number">0x000002155A389688</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Child_3 object at <span class="token number">0x000002155A3AA8C8</span><span class="token operator">></span><span class="token punctuation">]</span>
<span class="token number">2290731015624</span>
<span class="token number">0x2155a355dc8</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Parent_3 object at <span class="token number">0x000002155A355DC8</span><span class="token operator">></span>
<span class="token number">2290731226760</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Parent_3 object at <span class="token number">0x000002155A355DC8</span><span class="token operator">></span>
<span class="token number">2290731362504</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行<code>python</code>终端</p><pre class="line-numbers language-python"><code class="language-python">In <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> hex<span class="token punctuation">(</span><span class="token number">0x000002155A355DC8</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">'0x2155a355dc8'</span>

In <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span> hex<span class="token punctuation">(</span><span class="token number">0x000002155A389688</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">'0x2155a389688'</span>

In <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span> hex<span class="token punctuation">(</span><span class="token number">0x000002155A3AA8C8</span><span class="token punctuation">)</span>
Out<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">:</span> <span class="token string">'0x2155a3aa8c8'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>即可验证,指向是双向的.</p></blockquote><h4 id="3-一对一关系"><a href="#3-一对一关系" class="headerlink" title="3.一对一关系"></a>3.一对一关系</h4><blockquote><p>一对一本质上是双向关系.双方都需要设置反向对应<code>back_popultaes</code> .但是为了表示一对一的关系,需要设置<code>relationshiop()</code>的参数<code>uselist=False</code>.</p><p>查看<code>uselist</code></p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> help<span class="token punctuation">(</span>relationship<span class="token punctuation">)</span>
<span class="token punctuation">:</span>param uselist<span class="token punctuation">:</span>
a boolean that indicates <span class="token keyword">if</span> this property should be loaded <span class="token keyword">as</span> alist <span class="token operator">or</span> a scalar<span class="token punctuation">.</span> In most cases<span class="token punctuation">,</span> this value <span class="token keyword">is</span> determined automatically by <span class="token punctuation">:</span>func<span class="token punctuation">:</span>`<span class="token punctuation">.</span>relationship` at mapper configuration time<span class="token punctuation">,</span> based on the type <span class="token operator">and</span> direction of the relationship <span class="token operator">-</span> 
      one to many forms a list<span class="token punctuation">,</span>
      many to one forms a scalar<span class="token punctuation">,</span>
      many to many <span class="token keyword">is</span> a list<span class="token punctuation">.</span>
If a scalar <span class="token keyword">is</span> desired where normally a list would be present<span class="token punctuation">,</span> such <span class="token keyword">as</span> a bi<span class="token operator">-</span>directional one<span class="token operator">-</span>to<span class="token operator">-</span>one relationship<span class="token punctuation">,</span> set <span class="token punctuation">:</span>paramref<span class="token punctuation">:</span>`<span class="token operator">~</span><span class="token punctuation">.</span>relationship<span class="token punctuation">.</span>uselist` to  <span class="token boolean">False</span><span class="token punctuation">.</span>

The <span class="token punctuation">:</span>paramref<span class="token punctuation">:</span>`<span class="token operator">~</span><span class="token punctuation">.</span>relationship<span class="token punctuation">.</span>uselist` flag <span class="token keyword">is</span> also available on an existing <span class="token punctuation">:</span>func<span class="token punctuation">:</span>`<span class="token punctuation">.</span>relationship` construct <span class="token keyword">as</span> a read<span class="token operator">-</span>only attribute<span class="token punctuation">,</span>
which can be used to determine <span class="token keyword">if</span> this <span class="token punctuation">:</span>func<span class="token punctuation">:</span>`<span class="token punctuation">.</span>relationship` deals <span class="token keyword">with</span> collections <span class="token operator">or</span> scalar attributes<span class="token punctuation">:</span><span class="token punctuation">:</span>

    <span class="token operator">>></span><span class="token operator">></span> User<span class="token punctuation">.</span>addresses<span class="token punctuation">.</span>property<span class="token punctuation">.</span>uselist
    <span class="token boolean">True</span>

<span class="token triple-quoted-string string">"""
一个布尔值，指示是否应将此属性加载为列表或标量。 在大多数情况下，此值是在映射器配置时由.func：`.relationship`根据关系的类型和方向自动确定的-
       一对多的列表
       多对一形成标量，
       多对多是一个列表。
 如果需要一个标量，通常在其中会出现一个列表，例如双向一对一关系，则将paramref：〜.relationship.uselist设置为False。
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>简单的锁,<code>uselist</code> 需要设置为布尔值,而且在关系模式中是自动匹配的(除了一对一关系).如果是一对一关系,就需要在<code>一</code>的关系一行设置<code>uselist=False</code>(没有外键的一方).</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
  __tablename__ <span class="token operator">=</span> <span class="token string">'parent'</span>
  id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">,</span> uselist<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"parent"</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
  __tablename__ <span class="token operator">=</span> <span class="token string">'child'</span>
  id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  parent_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Parent"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">"child"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>如果使用的是<code>backref()</code> 函数,写法如下</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> backref

<span class="token keyword">class</span> <span class="token class-name">Parent</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
  __tablename__ <span class="token operator">=</span> <span class="token string">'parent'</span>
  id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
  child_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'child.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">"Child"</span><span class="token punctuation">,</span> backref<span class="token operator">=</span>backref<span class="token punctuation">(</span><span class="token string">"parent"</span><span class="token punctuation">,</span> uselist<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="4-多对多关系-中间表无意义"><a href="#4-多对多关系-中间表无意义" class="headerlink" title="4.多对多关系-中间表无意义"></a>4.多对多关系-中间表无意义</h4><blockquote><p>这里只讨论多对多双向关系.</p><p>一个实体A的属性a的数据对象会对应多个实体B属性b的数据对象.从实体B属性b的角度看,它对应多个实体A属性a的数据对象.</p><p>比如说,学生和课程的关系.一个学生会学习多门课程,一个课程也会有多个学生学习.</p><p>在关系型数据库中,必须使用中间表来表示多对对的关系.中间表可以分成2种,一种是纯粹表示关系的中间表.一种是表示中间实体的中间表.</p><ul><li>第一种比较简单.只需要两列:<code>Aid</code>和<code>Bid</code>.<code>Aid</code>以外键关联到A表的主键,<code>Bid</code>以外键关联到B表的主键,然后这两个列联合组成主键.这个中间表纯粹是表示多对多关系而存在,在业务上不会有敌营的实体与之对应.比如学生和课程的关系.只需要知道哪些学生上那些课,那些课有哪些学生,不需要更多的信息的情况下,可以建立<code>学生课程</code> 中间表,表中只要包含学生id和课程id就可以了.</li><li>第二种是在纯粹的中间关系表的基础 上,加上了更多的属性,从而形成了一个新的实体.比如学生课程表的关系.如果需要记录学生选课的时间,选课后的考试成绩,那么就需要建立一个<code>选课</code> 实体.实体具有属性:<ul><li>选课id, 主键.</li><li>学生id, 与学生表做外键关联</li><li>课程id,与课程表做外键关联</li><li>选课时间</li><li>选课后成绩</li></ul></li></ul><p>而关联表的创建,在<code>sqlalchemy</code> 中要使用<code>Table</code> 对象模型,而不是使用类来对应.</p><p>什么是<code>Table</code>对象,其实<code>Model</code> 利用基类生成的<code>Parent_2</code> 就是一个<code>Table</code>对象.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>Parent_2<span class="token punctuation">.</span>__table__<span class="token punctuation">)</span>
sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema<span class="token punctuation">.</span>Table

<span class="token operator">>></span><span class="token operator">></span> Parent_2<span class="token punctuation">.</span>__table__
Table<span class="token punctuation">(</span><span class="token string">'parent_1'</span><span class="token punctuation">,</span> MetaData<span class="token punctuation">(</span>bind<span class="token operator">=</span>None<span class="token punctuation">)</span><span class="token punctuation">,</span> Column<span class="token punctuation">(</span><span class="token string">'p_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token operator">=</span><span class="token operator">&lt;</span>Parent_1<span class="token operator">></span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Column<span class="token punctuation">(</span><span class="token string">'p_name'</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span>length<span class="token operator">=</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table<span class="token operator">=</span><span class="token operator">&lt;</span>Parent_1<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span> schema<span class="token operator">=</span>None<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以通过导入这个<code>Table</code> 类,来查看它的方法</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Table
<span class="token operator">>></span><span class="token operator">></span> help<span class="token punctuation">(</span>Table<span class="token punctuation">)</span>
Help on <span class="token keyword">class</span> <span class="token class-name">Table</span> <span class="token keyword">in</span> module sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>schema<span class="token punctuation">:</span>

<span class="token keyword">class</span> <span class="token class-name">Table</span><span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>base<span class="token punctuation">.</span>DialectKWArgs<span class="token punctuation">,</span> SchemaItem<span class="token punctuation">,</span> sqlalchemy<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>selectable<span class="token punctuation">.</span>TableClause<span class="token punctuation">)</span>
<span class="token operator">|</span>  Table<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kw<span class="token punctuation">)</span>
<span class="token operator">|</span>  
<span class="token operator">|</span>  Represent a table <span class="token keyword">in</span> a database<span class="token punctuation">.</span>
<span class="token operator">|</span>  
<span class="token operator">|</span>  e<span class="token punctuation">.</span>g<span class="token punctuation">.</span><span class="token punctuation">:</span><span class="token punctuation">:</span>
<span class="token operator">|</span>  
<span class="token operator">|</span>      mytable <span class="token operator">=</span> Table<span class="token punctuation">(</span><span class="token string">"mytable"</span><span class="token punctuation">,</span> metadata<span class="token punctuation">,</span>
<span class="token operator">|</span>                      Column<span class="token punctuation">(</span><span class="token string">'mytable_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">|</span>                      Column<span class="token punctuation">(</span><span class="token string">'value'</span><span class="token punctuation">,</span> String<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">|</span>                 <span class="token punctuation">)</span>
<span class="token operator">|</span>  
<span class="token operator">|</span>  The <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Table` object constructs a unique instance of itself based
<span class="token operator">|</span>  on its name <span class="token operator">and</span> optional schema name within the given
<span class="token operator">|</span>  <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>MetaData` object<span class="token punctuation">.</span> Calling the <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Table`
<span class="token operator">|</span>  constructor <span class="token keyword">with</span> the same name <span class="token operator">and</span> same <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>MetaData` argument
<span class="token operator">|</span>  a second time will <span class="token keyword">return</span> the <span class="token operator">*</span>same<span class="token operator">*</span> <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Table` object <span class="token operator">-</span> <span class="token keyword">in</span> this way
<span class="token operator">|</span>  the <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Table` constructor acts <span class="token keyword">as</span> a registry function<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它就是用来表示数据库中的表的.</p><p>如何建立与中间表的联系.这个需要设置<code>relationship()</code> 中的<code>secondary</code> 参数</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> help<span class="token punctuation">(</span>ralationship<span class="token punctuation">)</span>
<span class="token punctuation">:</span>param secondary<span class="token punctuation">:</span>
<span class="token keyword">for</span> a many<span class="token operator">-</span>to<span class="token operator">-</span>many relationship<span class="token punctuation">,</span> specifies the intermediary table<span class="token punctuation">,</span> <span class="token operator">and</span> <span class="token keyword">is</span> typically an instance of <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Table`<span class="token punctuation">.</span>In less common circumstances<span class="token punctuation">,</span> the argument may also be specified <span class="token keyword">as</span> an <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Alias` construct<span class="token punctuation">,</span> <span class="token operator">or</span> even a <span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">:</span>`<span class="token punctuation">.</span>Join` construct<span class="token punctuation">.</span>
<span class="token comment" spellcheck="true"># 对于多对多关系，指定中间表，通常是.table的实例</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,对于中间表来说,就是用这个参数指定的.而且它指定的是一个<code>Table</code> 对象实例.</p><p>这样,可以构建一个多对多的对应.</p><hr><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10226.png" alt="10226"></p><p>根据上图创建表:</p><p>使用<code>MySQL</code></p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">use</span> sqlalchemy<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> course_1<span class="token punctuation">(</span>
    c_id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    c_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"课程表1"</span><span class="token punctuation">;</span>


<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> student_1<span class="token punctuation">(</span>
    s_id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    s_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>s_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"学生表1"</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">-- 中间表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> course_student_1<span class="token punctuation">(</span>
    c_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    s_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">,</span> s_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> cons1 <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>c_id<span class="token punctuation">)</span> <span class="token keyword">references</span> course_1<span class="token punctuation">(</span>c_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> cons2 <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>s_id<span class="token punctuation">)</span> <span class="token keyword">references</span> student_1<span class="token punctuation">(</span>s_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"学生课程连接表"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 插入数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> course_1 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'语文'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'数学'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'英语'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> student_1 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'赵一'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'钱二'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'孙三'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> course_student_1 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>使用<code>SQLAlchemy</code>创建表的对应</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>


<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span>  Table
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span>  PrimaryKeyConstraint

<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
Course_Student_1 <span class="token operator">=</span> Table<span class="token punctuation">(</span><span class="token string">'course_student_1'</span><span class="token punctuation">,</span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
                         Column<span class="token punctuation">(</span><span class="token string">'c_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'course_1.c_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         Column<span class="token punctuation">(</span><span class="token string">'s_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'student_1.s_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         <span class="token comment" spellcheck="true"># 表级别主键，指定多一个主键 name 可以指定主键的名称</span>
                        PrimaryKeyConstraint<span class="token punctuation">(</span><span class="token string">'c_id'</span><span class="token punctuation">,</span> <span class="token string">'s_id'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'pk_course_student_1'</span><span class="token punctuation">)</span>
                        <span class="token comment" spellcheck="true"># 如果是列级别,定义在类中,可以直接写类的属性</span>
                       <span class="token comment" spellcheck="true"># Column('c_id', Integer, ForeignKey('course_1.c_id'), nullable=False, primary_key=True),</span>
                       <span class="token comment" spellcheck="true"># Column('s_id', Integer, ForeignKey('student1.s_id'), nullable=False, primary_key=True)</span>
<span class="token punctuation">)</span>



<span class="token keyword">class</span> <span class="token class-name">Course_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'course_1'</span>

    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 创建 双向关系</span>
    <span class="token comment" spellcheck="true"># 字段第一个 指向 子类</span>
    <span class="token comment" spellcheck="true"># 第二个指向 Table  实例</span>
    <span class="token comment" spellcheck="true"># 第三个 双向 参数,必须保证子类中有这个属性</span>
    student <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Student_1'</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>Course_Student_1<span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'course'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Student_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'student_1'</span>

    s_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    s_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 创建双向关系</span>
    <span class="token comment" spellcheck="true"># 第一个指向父类</span>
    <span class="token comment" spellcheck="true"># 第二个指向 Table 实例</span>
    <span class="token comment" spellcheck="true"># 第三个 双向参数 必须保证父类中有这个属性</span>
    course <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Course_1'</span><span class="token punctuation">,</span> secondary<span class="token operator">=</span>Course_Student_1<span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'student'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># 映射完成后,查询验证</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Course_1<span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Student_1<span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="5-多对多关系-中间表有意义"><a href="#5-多对多关系-中间表有意义" class="headerlink" title="5.多对多关系-中间表有意义"></a>5.多对多关系-中间表有意义</h4><blockquote><p>使用<code>MySQL</code>创建表</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> course_2<span class="token punctuation">(</span>
    c_id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    c_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"课程表2"</span><span class="token punctuation">;</span>


<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> student_2<span class="token punctuation">(</span>
    s_id <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    s_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>s_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"学生表2"</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">-- 中间表,有意义</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> course_student_2<span class="token punctuation">(</span>
    e_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span>
    c_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    s_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    e_time <span class="token keyword">date</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    e_score <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>e_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> cons3 <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>c_id<span class="token punctuation">)</span> <span class="token keyword">references</span> course_2<span class="token punctuation">(</span>c_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> cons4 <span class="token keyword">foreign</span> <span class="token keyword">key</span><span class="token punctuation">(</span>s_id<span class="token punctuation">)</span> <span class="token keyword">references</span> student_2<span class="token punctuation">(</span>s_id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> char <span class="token keyword">set</span> utf8 <span class="token keyword">comment</span> <span class="token string">"学生课程连接表2"</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 插入数据</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> course_2 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'语文'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'数学'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'英语'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> student_2 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'赵一'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'钱二'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'孙三'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> course_student_2 <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2010-12-1'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token string">'2010-12-1'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token string">'2010-12-1'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2010-12-1'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2010-12-1'</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>使用<code>SQLAlchemy</code></p><p>如果中间表有意义,可以不指定<code>secondary</code> 参数,而是创建新类直接映射表.它类似与这样:</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10227.png" alt="10227"></p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>


<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Course_Student_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'course_student_2'</span>

    e_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'course_2.c_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    s_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'student2.s_id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    e_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>Date<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    e_score <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    e_course <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Course_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'student'</span><span class="token punctuation">)</span>
    e_student <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Student_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'course'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Course_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'course_2'</span>

    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 创建 双向关系</span>
    <span class="token comment" spellcheck="true"># 字段第一个 指向 子类</span>
    <span class="token comment" spellcheck="true"># 第二个指向 Table  实例</span>
    <span class="token comment" spellcheck="true"># 第三个 双向 参数,必须保证子类中有这个属性</span>
    student <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Course_Student_2'</span><span class="token punctuation">,</span>  back_populates<span class="token operator">=</span><span class="token string">'e_course'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Student_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'student_2'</span>

    s_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    s_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 创建双向关系</span>
    <span class="token comment" spellcheck="true"># 第一个指向父类</span>
    <span class="token comment" spellcheck="true"># 第二个指向 Table 实例</span>
    <span class="token comment" spellcheck="true"># 第三个 双向参数 必须保证父类中有这个属性</span>
    course <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Course_Student_2'</span><span class="token punctuation">,</span>  back_populates<span class="token operator">=</span><span class="token string">'e_student'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># 映射完成后,查询验证</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Course_2<span class="token punctuation">.</span>c_name<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Course_2<span class="token punctuation">.</span>c_id<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="12-双向关系中数据的查询和添加"><a href="#12-双向关系中数据的查询和添加" class="headerlink" title="12.双向关系中数据的查询和添加"></a>12.双向关系中数据的查询和添加</h3><blockquote><p>这里演示多表查询基于一对多关系.</p><p>多对多关系也是基于一对多关系的.</p><p>有如下一对多关系:</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10228.png" alt="10228"></p><hr><p>使用<code>MySQL</code>创建表</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">use</span> sqlalchemy<span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> user_1<span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fullname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    nickname <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> <span class="token keyword">charset</span> utf8 <span class="token keyword">comment</span> <span class="token string">"用户表"</span><span class="token punctuation">;</span>

<span class="token keyword">create</span> <span class="token keyword">table</span> addresses_1<span class="token punctuation">(</span>
    id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    email_address <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
    <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">constraint</span> p1 <span class="token keyword">foreign</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">references</span> user_1<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">default</span> <span class="token keyword">charset</span> utf8 <span class="token keyword">comment</span> <span class="token string">"地址表"</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>创建<code>SQLAlchemy</code>连接</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>


<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>

<span class="token keyword">class</span> <span class="token class-name">User1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_1'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fullname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    nickname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 定义双向对应,连接的是 Model</span>
    address <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Address1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Address1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'addresses_1'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    email_address <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 定义外键</span>
    user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_1.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 定义双向对应</span>
    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'address'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>初始化一个<code>User1</code> 的实例,并访问它的<code>address</code> 属性,它是一个类<code>list</code> 对象.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 创建一个User1实例对象</span>
<span class="token operator">>></span><span class="token operator">></span> Jack<span class="token operator">=</span>User1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">"Jack Ning"</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token string">'Ningning'</span><span class="token punctuation">)</span>

<span class="token operator">>></span><span class="token operator">></span> Jack<span class="token punctuation">.</span>address
<span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token operator">>></span><span class="token operator">></span> type<span class="token punctuation">(</span>Jack<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>InstrumentedList<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>因为我们上面使用的是双向的一对多关系,那么在一个方向上添加元素,会自动的在另一个方向上可见.需要注意的是,这只是在<code>python</code> 中做操作,并没有与数据库进行交互.而且,<code>address</code> 就指向了<code>Address1</code> 的实例化对象,所有可以这样创建这个对象</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> Jack<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token punctuation">[</span>
Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'xxx@xx1.com'</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'xxx@xx2.com'</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'xxx@xx3.com'</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>
<span class="token comment" spellcheck="true"># 可以使用 list 的方法 比如,append,count,extend,等等</span>

<span class="token comment" spellcheck="true"># 访问数据对象</span>
<span class="token operator">>></span><span class="token operator">></span>Jack<span class="token punctuation">.</span>address<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token operator">&lt;</span>__main__<span class="token punctuation">.</span>Address1 at <span class="token number">0x7fd4c81476d0</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这里并没有手动的去实例化<code>Address1</code> 的对象,但是在内存中确实创建了它的实例对象,如果这时提交到数据库中,那么会把所有的实例对象都提交.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Jack<span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看日志:</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -5 /mysql_data/localhost.log</span>

Query    SET NAMES utf8mb4
Query    INSERT INTO user_1 <span class="token punctuation">(</span>id, name, fullname, nickname<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>1, <span class="token string">'Jack'</span>, <span class="token string">'Jack Ning'</span>, <span class="token string">'Ningning'</span><span class="token punctuation">)</span>
Query    INSERT INTO addresses_1 <span class="token punctuation">(</span>id, email_address, user_id<span class="token punctuation">)</span> VALUES <span class="token punctuation">(</span>1, <span class="token string">'xxx@xx1.com'</span>, 1<span class="token punctuation">)</span>,<span class="token punctuation">(</span>2, <span class="token string">'xxx@xx2.com'</span>, 1<span class="token punctuation">)</span>,<span class="token punctuation">(</span>3, <span class="token string">'xxx@xx3.com'</span>, 1<span class="token punctuation">)</span>
Query    COMMIT
Query    ROLLBACK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到把所有的实例对象都提交到了数据库中.</p><p>一对多关系中,各自返回的数据类型也不相同</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 查询表中所有的行</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
SELECT user_1.id AS user_1_id, user_1.name AS user_1_name, user_1.fullname AS user_1_fullname, user_1.nickname AS user_1_nickname 
FROM user_1
"""</span>

<span class="token comment" spellcheck="true"># 查询表中第一行</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
&lt;__main__.User1 object at 0x7fa624b6c150>
"""</span>
<span class="token comment" spellcheck="true"># 返回的类的一个实例,而类的实例的 address 属性是个list 对象</span>
<span class="token triple-quoted-string string">"""
因为在 User1 中定义了 属性 address, 它对应的就是 外键连接的所有 Addresses1
中的所有列
相当于执行了
SELECT addresses_1.id AS addresses_1_id, addresses_1.email_address AS addresses_1_email_address, addresses_1.user_id AS addresses_1_user_id 
FROM addresses_1 
WHERE 1 = addresses_1.user_id
"""</span>
q2<span class="token punctuation">.</span>address
<span class="token triple-quoted-string string">"""
[&lt;__main__.Address1 at 0x7fa62616d290>,
&lt;__main__.Address1 at 0x7fa62616d310>,
&lt;__main__.Address1 at 0x7fa62616d390>]
"""</span>
type<span class="token punctuation">(</span>q2<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># sqlalchemy.orm.collections.InstrumentedList</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> q2<span class="token punctuation">.</span>address<span class="token punctuation">:</span>
 <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>id<span class="token punctuation">,</span> i<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
1 1
2 1
3 1
"""</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>双向查询</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 因为是双向的,所以也可以去 Address1的查询实例</span>
<span class="token triple-quoted-string string">"""
SELECT addresses_1.id AS addresses_1_id, addresses_1.email_address AS addresses_1_email_address, addresses_1.user_id AS addresses_1_user_id 
FROM addresses_1 
LIMIT 1
"""</span>
q3 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Address1<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q3<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># &lt;__main__.User1 object at 0x7fa625af7c10></span>
q3<span class="token punctuation">.</span>user<span class="token punctuation">.</span>id
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>双向添加数据</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 由于在关系 一  的一行返回的是一个 list对象,而在关系 多 的一行返回的是 类的实例</span>
<span class="token comment" spellcheck="true"># 这样添加数据可以是</span>
user <span class="token operator">=</span> User1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Bob Ning'</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token string">'Bob NN'</span><span class="token punctuation">)</span>
add1 <span class="token operator">=</span> Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>email_address<span class="token operator">=</span><span class="token string">'xxx@xx4.com'</span><span class="token punctuation">,</span>user_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
add2 <span class="token operator">=</span> Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>email_address<span class="token operator">=</span><span class="token string">'xxx@xx5.com'</span><span class="token punctuation">,</span>user_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># list 对象</span>
user<span class="token punctuation">.</span>address<span class="token punctuation">.</span>append<span class="token punctuation">(</span>add1<span class="token punctuation">)</span>
user<span class="token punctuation">.</span>address<span class="token punctuation">.</span>append<span class="token punctuation">(</span>add2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 而对于 Address1 的实例可以这样添加</span>
session1 <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
user2 <span class="token operator">=</span> User1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Harry'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">'Harry K'</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token string">'K K'</span><span class="token punctuation">)</span>
add3 <span class="token operator">=</span> Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span>email_address<span class="token operator">=</span><span class="token string">'xxx@xx6.com'</span><span class="token punctuation">,</span>user_id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
add4 <span class="token operator">=</span> Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span>email_address<span class="token operator">=</span><span class="token string">'xxx@xx7.com'</span><span class="token punctuation">,</span>user_id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
add3<span class="token punctuation">.</span>user <span class="token operator">=</span> user2
add4<span class="token punctuation">.</span>user <span class="token operator">=</span> user2

session1<span class="token punctuation">.</span>add<span class="token punctuation">(</span>add3<span class="token punctuation">)</span>
session1<span class="token punctuation">.</span>add<span class="token punctuation">(</span>add4<span class="token punctuation">)</span>
session1<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>

session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
session1<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以通过查看<code>mysql</code> 数据库查看数据正常添加.</p></blockquote><h3 id="13-cascade级联"><a href="#13-cascade级联" class="headerlink" title="13.cascade级联"></a>13.<code>cascade</code>级联</h3><blockquote><p>首先,对于原生的<code>SQL</code>语句,已经<code>MySQL</code>而言,外键约束如下:</p><pre class="line-numbers language-mysql"><code class="language-mysql">create table table_name(
    column_1,
    column_2,
    ....
    constraint constraint_name foreign key (column_name) 
    references parent_table(column_name)
    on delete action
    on update action
) engine=InnoDB default charset utf8;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p><code>constraint</code> 子句允许为外键定义一个名称,如果不写,<code>MySQL</code> 自动生成一个名称</p></li><li><p><code>foreign key</code> 子句指定子表中要应用父表的列.注意:<code>MySQL</code> 会自动创建一个基于外键的索引.</p></li><li><p><code>references</code> 子句指定父表中的被引用字段.<code>foreign key</code> 和<code>references</code> 指定的列数必须相同.</p></li><li><p><code>on delete</code>: 定义当父表中的记录被删除时,子表的记录应该执行的动作.<code>action</code>包括:</p><ul><li><code>on delete restrict</code>:(默认),父表不能删除一个已经被子表引用的记录.</li><li><code>on delete no action</code>:等同与<code>on delete restrict</code></li><li><code>on delete cascade</code>: 级联模式,父表删除后,对应子表关联的数据也跟着被删除</li><li><code>on delete set null</code>:置空模式,父表删除后,对应子表关联的外键值被设置为<code>NULL</code>,需要注意的是,如果子表的外键设置<code>not null</code> ,则不能使用这种模式,因为会相互冲突.</li></ul></li><li><p><code>on update</code>:定义父表中的记录更新时,子表的记录应该执行的动作.<code>action</code> 包括:</p><ul><li><code>on update restrict</code>:(默认),父表不能更新一个已经被子表引用的记录.</li><li><code>on update no action</code>:等同与<code>on delete restrict</code></li><li><code>on update cascade</code>: 级联模式,父表更新后,对应子表关联的数据也跟着被更新</li><li><code>on update set null</code>:置空模式,父表更新后,对应子表关联的外键值被设置为<code>NULL</code>,需要注意的是,如果子表的外键设置<code>not null</code> ,则不能使用这种模式.</li></ul></li></ul><hr><p>当使用<code>ORM</code>的<code>SQLAlchemy</code>时,在原生的<code>SQL</code>语句上又添加了一层约束<code>relationship</code>.</p></blockquote><h4 id="1-一对多模式中relationship的影响"><a href="#1-一对多模式中relationship的影响" class="headerlink" title="1.一对多模式中relationship的影响"></a>1.一对多模式中<code>relationship</code>的影响</h4><blockquote><p>创建如下两个对比文件:级联对比1,级联对比2</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 10级联对比1</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Cascade_Parent_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_parent_1'</span>

 id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
 name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment" spellcheck="true"># 设置双向关系</span>
 childs <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Child_1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span>  <span class="token class-name">Cascade_Child_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_child_1'</span>

 id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
 name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment" spellcheck="true"># 外键连接的是 表</span>
 p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'cascade_parent_1.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Parent_1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'childs'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 11级联对比2</span>

<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Cascade_Parent_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_parent_2'</span>

 id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
 name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment" spellcheck="true"># 设置双向关系</span>
 childs <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Child_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span>  <span class="token class-name">Cascade_Child_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
 __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_child_2'</span>

 id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
 name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 <span class="token comment" spellcheck="true"># 外键连接的是 表</span>
 p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'cascade_parent_2.id'</span><span class="token punctuation">,</span> ondelete<span class="token operator">=</span><span class="token string">'cascade'</span><span class="token punctuation">,</span> onupdate<span class="token operator">=</span><span class="token string">'cascade'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
 parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Parent_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'childs'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建文件:</p><pre class="line-numbers language-bash"><code class="language-bash">$ python 10级联对比1.py
$ python 11级联对比2.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以看到上面唯一的不同,就是指定外键的约束不同,查看<code>SQL</code>语句,可以更清晰的分辨(默认不指定情况下是<code>restrict</code>):</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> cascade_child_1<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>cascade_child_1<span class="token punctuation">`</span> <span class="token punctuation">(</span> 
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>                                                         
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>                                                              
    <span class="token punctuation">`</span>p_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>                                                                  
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                                           
    <span class="token keyword">KEY</span> <span class="token punctuation">`</span>p_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>p_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                                                                         
    <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>cascade_child_1_ibfk_1<span class="token punctuation">`</span> 
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>p_id<span class="token punctuation">`</span><span class="token punctuation">)</span> 
    <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>cascade_parent_1<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> 
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 


<span class="token operator">></span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> cascade_child_2<span class="token punctuation">;</span> 
cascade_child_2 <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>cascade_child_2<span class="token punctuation">`</span> <span class="token punctuation">(</span>  
    <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>   
    <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
    <span class="token punctuation">`</span>p_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
    <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    
    <span class="token keyword">KEY</span> <span class="token punctuation">`</span>p_id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>p_id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     
    <span class="token keyword">CONSTRAINT</span> <span class="token punctuation">`</span>cascade_child_2_ibfk_1<span class="token punctuation">`</span> 
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>p_id<span class="token punctuation">`</span><span class="token punctuation">)</span> 
    <span class="token keyword">REFERENCES</span> <span class="token punctuation">`</span>cascade_parent_2<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span> 
    <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">CASCADE</span> 
    <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CASCADE</span> 
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8       <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>restrict</code>:父表不能删除一个已经被子表引用的记录</li><li><code>cascade</code>:父表删除后,子表数据也删除</li></ul><hr><p>现在我们尝试在两张表中添加数据,并使用<code>SQLAlchemy</code>去删除数据.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 10级联对比1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true"># 添加以下内容</span>
<span class="token comment" spellcheck="true"># 添加数据</span>
p1 <span class="token operator">=</span> Cascade_Parent_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Cascade_Child_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Cascade_Child_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 双向关系,子表也可以添加数据</span>
p2 <span class="token operator">=</span> Cascade_Parent_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob'</span><span class="token punctuation">)</span>
c3 <span class="token operator">=</span> Cascade_Child_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c4 <span class="token operator">=</span> Cascade_Child_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c3<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2
c4<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c3<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c4<span class="token punctuation">)</span>

session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 11级联对比2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token comment" spellcheck="true"># 添加以下内容</span>
<span class="token comment" spellcheck="true"># 添加数据</span>
p1 <span class="token operator">=</span> Cascade_Parent_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Cascade_Child_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Cascade_Child_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 双向关系,子表也可以添加数据</span>
p2 <span class="token operator">=</span> Cascade_Parent_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob'</span><span class="token punctuation">)</span>
c3 <span class="token operator">=</span> Cascade_Child_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c4 <span class="token operator">=</span> Cascade_Child_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c3<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2
c4<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c3<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c4<span class="token punctuation">)</span>

session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行程序</p><pre class="line-numbers language-bash"><code class="language-bash">$ python 10级联对比1.py
$ python 11级联对比2.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>可以在数据库中查看并验证已经添加的数据:</p><pre class="line-numbers language-sql"><code class="language-sql">mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cascade_child_1<span class="token punctuation">;</span>        
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name        <span class="token operator">|</span> p_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Jack child1 <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Jack child2 <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Bob child1  <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Bob child2  <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+------+</span>


mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cascade_child_2<span class="token punctuation">;</span>                 
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name        <span class="token operator">|</span> p_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Jack child1 <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Jack child2 <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Bob child1  <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Bob child2  <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>接下来尝试使用<code>SQLAlchemy</code>删除数据.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 10级联对比1</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true"># 注释添加数据的内容</span>
<span class="token comment" spellcheck="true"># 添加以下内容</span>
<span class="token comment" spellcheck="true"># 尝试删除一条数据</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Cascade_Parent_1<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 11级联对比2</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true"># 注释添加数据的内容</span>
<span class="token comment" spellcheck="true"># 添加以下内容</span>
<span class="token comment" spellcheck="true"># 尝试删除一条数据</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Cascade_Parent_1<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>运行程序:</p><pre class="line-numbers language-bash"><code class="language-bash">$ python 10级联对比1.py
$ python 11级联对比2.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>查看<code>MySQL</code>日志,可以很明显的看到<code>set p_id =NULL</code>的语句</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cat</span> /mysql_data/localhost.log
<span class="token punctuation">..</span><span class="token punctuation">..</span>
2020-08-25T13:15:12.063798Z       37 Query    UPDATE cascade_child_1 SET p_id<span class="token operator">=</span>NULL WHERE cascade_child_1.id <span class="token operator">=</span> 1
2020-08-25T13:15:12.093034Z       37 Query    UPDATE cascade_child_1 SET p_id<span class="token operator">=</span>NULL WHERE cascade_child_1.id <span class="token operator">=</span> 2
2020-08-25T13:15:12.104037Z       37 Query    DELETE FROM cascade_parent_1 WHERE cascade_parent_1.id <span class="token operator">=</span> 1
2020-08-25T13:15:12.114879Z       37 Query    COMMIT
<span class="token punctuation">..</span><span class="token punctuation">..</span>
2020-08-25T13:15:17.618876Z       38 Query    UPDATE cascade_child_2 SET p_id<span class="token operator">=</span>NULL WHERE cascade_child_2.id <span class="token operator">=</span> 1
2020-08-25T13:15:17.621866Z       38 Query    UPDATE cascade_child_2 SET p_id<span class="token operator">=</span>NULL WHERE cascade_child_2.id <span class="token operator">=</span> 2
2020-08-25T13:15:17.635397Z       38 Query    DELETE FROM cascade_parent_2 WHERE cascade_parent_2.id <span class="token operator">=</span> 1
2020-08-25T13:15:17.638600Z       38 Query    COMMIT
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>并且表中数据被清空</p><pre class="line-numbers language-sql"><code class="language-sql">mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cascade_child_1<span class="token punctuation">;</span>                                   
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name        <span class="token operator">|</span> p_id   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Jack child1 <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Jack child2 <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Bob child1  <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Bob child2  <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+--------+</span>


mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cascade_child_2<span class="token punctuation">;</span>     
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+--------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name        <span class="token operator">|</span> p_id   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+--------+</span>
<span class="token operator">|</span> <span class="token number">1</span>  <span class="token operator">|</span> Jack child1 <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Jack child2 <span class="token operator">|</span> <span class="token operator">&lt;</span><span class="token boolean">null</span><span class="token operator">></span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Bob child1  <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Bob child2  <span class="token operator">|</span> <span class="token number">2</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+-------------+--------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>问题是,在<code>MySQL</code>的创建表的语句中,默认就没有<code>set null</code>的设置,但是在<code>SQLAlchemy</code>的<code>ORM</code>中却自己设置了.原因是什么?</p><p>这就涉及到了<code>sqlalchemy</code>中<code>relationship</code>的<code>cascade</code>参数的设置.</p><p>当然为了避免出现<code>null</code>这种情况,在创建外键时最好指定<code>null</code>不能为空</p><pre class="line-numbers language-python">p_id = Column(Integer, ForeignKey(&#39;parent.id&#39;, ondelete=&#39;cascade&#39;, onupdate=&#39;cascade&#39;),nullable=False)</pre></blockquote><h4 id="2-relationship中cascade参数设置"><a href="#2-relationship中cascade参数设置" class="headerlink" title="2.relationship中cascade参数设置"></a>2.<code>relationship</code>中<code>cascade</code>参数设置</h4><blockquote><p>主要可设置的参数包括以下几种,<code>cascade=</code></p><ul><li><code>save-update</code>:默认选项,表示当一个对象被添加到<code>session</code> 通过<code>session.add()</code> 时,与它关联的<code>relationship()</code> 也应该添加到同一个<code>session</code></li><li><code>delete</code>:表示当父对象被标记为删除时,其相关的子对象也应该被标记为删除.</li><li><code>delete-orphan</code>:当子对象和父对象取消关联时,子对象被标记为删除;父对象被标记删除时,子对象也被标记为删除.它大多用于一对多关系的<code>一</code> ,而在<code>多</code> 的一方不使用.如果要使用,必须设置<code>single_parent=True</code> .多对多同理.这也是符合常理的.比如:一个班级有多个学生,如果班级取消,那班级中的学生也要删除.不能一个学生删除,而删除整个班级.</li><li><code>merge</code>:默认选项,合并操作,表示新更新的数据会覆盖老数据.</li><li><code>expunge</code>:移除操作的时候,会将相关联的对象也进行移除,这个操作只是从session中移除,并不会从数据库删除</li><li><code>all</code>:包含<code>save-update, merge, refresh-expire, expunge, delete</code> ,并不包括<code>delete-orpha</code></li><li><code>all, delete-orpha</code> 是最常用的操作.</li></ul><hr><p>创建如下文件</p><pre><code class="python"><code class="language-python">p_id = Column(Integer, ForeignKey(&#39;parent.id&#39;, ondelete=&#39;cascade&#39;, onupdate=&#39;cascade&#39;),nullable=False)</code></code></pre></blockquote><h4 id="2-relationship中cascade参数设置"><a href="#2-relationship中cascade参数设置" class="headerlink" title="2.relationship中cascade参数设置"></a>2.<code>relationship</code>中<code>cascade</code>参数设置</h4><blockquote><p>主要可设置的参数包括以下几种,<code>cascade=</code></p><ul><li><code>save-update</code>:默认选项,表示当一个对象被添加到<code>session</code> 通过<code>session.add()</code> 时,与它关联的<code>relationship()</code> 也应该添加到同一个<code>session</code></li><li><code>delete</code>:表示当父对象被标记为删除时,其相关的子对象也应该被标记为删除.</li><li><code>delete-orphan</code>:当子对象和父对象取消关联时,子对象被标记为删除;父对象被标记删除时,子对象也被标记为删除.它大多用于一对多关系的<code>一</code> ,而在<code>多</code> 的一方不使用.如果要使用,必须设置<code>single_parent=True</code> .多对多同理.这也是符合常理的.比如:一个班级有多个学生,如果班级取消,那班级中的学生也要删除.不能一个学生删除,而删除整个班级.</li><li><code>merge</code>:默认选项,合并操作,表示新更新的数据会覆盖老数据.</li><li><code>expunge</code>:移除操作的时候,会将相关联的对象也进行移除,这个操作只是从session中移除,并不会从数据库删除</li><li><code>all</code>:包含<code>save-update, merge, refresh-expire, expunge, delete</code> ,并不包括<code>delete-orpha</code></li><li><code>all, delete-orpha</code> 是最常用的操作.</li></ul><hr><p>创建如下文件</p><pre><code class="python">#!/usr/bin/env python
# coding=utf-8

# 12级联对比3
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, Integer, String, Date, DateTime, Time, Text, Enum, DECIMAL, ForeignKey
from sqlalchemy.orm import  relationship


# 1.连接数据库
engine = create_engine('mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy')

# 2.创建Session
Session = sessionmaker(bind=engine)

# 3.实例化session
session = Session()

# 4.创建Model
# 创建基类
Base = declarative_base()

# 创建映射
class Cascade_Parent_3(Base):
    __tablename__ = 'cascade_parent_3'

    id = Column(Integer, primary_key=True, nullable=False)
    name = Column(String(45))
    # 设置双向关系
    childs = relationship('Cascade_Child_3', back_populates='parent', cascade= '')

class  Cascade_Child_3(Base):
    __tablename__ = 'cascade_child_3'

    id = Column(Integer, primary_key=True, nullable=False)
    name = Column(String(45))
    # 外键连接的是 表
    # 使用默认的MySQl外键
    p_id = Column(Integer, ForeignKey('cascade_parent_3.id'))
    parent = relationship('Cascade_Parent_3', back_populates='childs', cascade='save-update')

# 创建表
Base.metadata.create_all(engine)


# 添加数据
p1 = Cascade_Parent_3(id=1, name='Jack')
c1 = Cascade_Child_3(id=1, name='Jack child1', p_id=1)
c2 = Cascade_Child_3(id=2, name='Jack child2', p_id=2)
p1.childs.append(c1)
p1.childs.append(c2)
session.add(p1)

# 双向关系,子表也可以添加数据
p2 = Cascade_Parent_3(id=2, name='Bob')
c3 = Cascade_Child_3(id=3, name='Bob child1', p_id=2)
c4 = Cascade_Child_3(id=4, name='Bob child2', p_id=2)
c3.parent = p2
c4.parent = p2

session.add(c3)
session.add(c4)

session.commit()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在以上双向关系中,父表的<code>relationship</code>没有设置任何选项,子表中<code>relationship</code>只是设置了一个<code>save-update</code>.根据定义,应该看到:</p><ul><li>父表的数据更新,不会添加到子表</li><li>子表的数据更新,应该添加到父表</li></ul><p>运行文件</p><pre class="line-numbers language-bash">$ python  12级联对比3.py</pre><p>在<code>MySQL</code>中验证表,可以看到,父表没有把子表中的数据添加.</p><pre><code class="sql"><code class="language-bash">$ python  12级联对比3.py</code></code></pre><p>在<code>MySQL</code>中验证表,可以看到,父表没有把子表中的数据添加.</p><pre><code class="sql">mysql root@192.168.0.101:sqlalchemy> select * from cascade_parent_3;  
+----+------+
| id | name |
+----+------+
| 1  | Jack |
| 2  | Bob  |
+----+------+


mysql root@192.168.0.101:sqlalchemy> select * from cascade_child_3;         
+----+------------+------+
| id | name       | p_id |
+----+------------+------+
| 3  | Bob child1 | 2    |
| 4  | Bob child2 | 2    |
+----+------------+------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>创建如下文件</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token comment" spellcheck="true"># 13级联对比4</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Cascade_Parent_4</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_parent_4'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 设置双向关系</span>
    childs <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Child_4'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">,</span> cascade<span class="token operator">=</span> <span class="token string">'save-update, delete'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span>  <span class="token class-name">Cascade_Child_4</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_child_4'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 外键连接的是 表</span>
    <span class="token comment" spellcheck="true"># 使用默认的MySQl外键</span>
    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'cascade_parent_4.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Parent_4'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'childs'</span><span class="token punctuation">,</span> cascade<span class="token operator">=</span><span class="token string">'save-update'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
p1 <span class="token operator">=</span> Cascade_Parent_4<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Cascade_Child_4<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Cascade_Child_4<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 双向关系,子表也可以添加数据</span>
p2 <span class="token operator">=</span> Cascade_Parent_4<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob'</span><span class="token punctuation">)</span>
c3 <span class="token operator">=</span> Cascade_Child_4<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c4 <span class="token operator">=</span> Cascade_Child_4<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c3<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2
c4<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c3<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c4<span class="token punctuation">)</span>

session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在以上双向关系中,父表的<code>relationship</code>中设置了<code>delete</code>,子表中<code>relationship</code>中没有设置<code>delete</code>. 根据定义,应该看到:</p><ul><li>父表的数据删除,会删除子表中数据</li><li>子表的数据删除,不会删除父表中的数据.</li></ul><p>运行文件:</p><pre class="line-numbers language-bash">$ python  13级联对比4.py</pre><p>查看数据库表:</p><pre><code class="sql"><code class="language-bash">$ python  13级联对比4.py</code></code></pre><p>查看数据库表:</p><pre><code class="sql">mysql root@192.168.0.101:sqlalchemy> select * from cascade_parent_4;       
+----+------+
| id | name |
+----+------+
| 1  | Jack |
| 2  | Bob  |
+----+------+


mysql root@192.168.0.101:sqlalchemy> select * from cascade_child_4;   
+----+-------------+------+
| id | name        | p_id |
+----+-------------+------+
| 1  | Jack child1 | 1    |
| 2  | Jack child2 | 1    |
| 3  | Bob child1  | 2    |
| 4  | Bob child2  | 2    |
+----+-------------+------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尝试在父表中删除数据:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 13级联对比4</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true"># 注释添加内容</span>
<span class="token comment" spellcheck="true"># 添加如下内容</span>

<span class="token comment" spellcheck="true"># 尝试删除一条数据</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Cascade_Parent_4<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行文件:</p><pre class="line-numbers language-bash">$ python  13级联对比4.py</pre><p>查看<code>MySQL</code>日志:</p><pre><code class="bash"><code class="language-bash">$ python  13级联对比4.py</code></code></pre><p>查看<code>MySQL</code>日志:</p><pre><code class="bash">$ cat /mysql_data/localhost.log
....
2020-08-25T13:50:24.510759Z       41 Query    DELETE FROM cascade_child_4 WHERE cascade_child_4.id = 1
2020-08-25T13:50:24.517217Z       41 Query    DELETE FROM cascade_child_4 WHERE cascade_child_4.id = 2
2020-08-25T13:50:24.522725Z       41 Query    DELETE FROM cascade_parent_4 WHERE cascade_parent_4.id = 1
2020-08-25T13:50:24.527657Z       41 Query    COMMIT<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看表:</p><pre class="line-numbers language-sql"><code class="language-sql">mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cascade_child_4<span class="token punctuation">;</span> 
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------------+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name       <span class="token operator">|</span> p_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------------+------+</span>
<span class="token operator">|</span> <span class="token number">3</span>  <span class="token operator">|</span> Bob child1 <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>  <span class="token operator">|</span> Bob child2 <span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------------+------+</span>


mysql root<span class="token variable">@192.168.0.101</span>:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> cascade_parent_4<span class="token punctuation">;</span>    
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> name <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+</span>
<span class="token operator">|</span> <span class="token number">2</span>  <span class="token operator">|</span> Bob  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment" spellcheck="true">----+------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>尝试从子表删除:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 13级联对比4</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true"># 注释添加内容</span>
<span class="token comment" spellcheck="true"># 添加如下内容</span>

<span class="token comment" spellcheck="true"># 尝试删除一条数据</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Cascade_Child_4<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Cascade_Child_4<span class="token punctuation">.</span>id <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行并验证:</p><pre class="line-numbers language-bash"><code class="language-bash">mysql root@192.168.0.101:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> * from cascade_parent_4<span class="token punctuation">;</span>           
+----+------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name <span class="token operator">|</span>
+----+------+
<span class="token operator">|</span> 2  <span class="token operator">|</span> Bob  <span class="token operator">|</span>
+----+------+


mysql root@192.168.0.101:sqlalchemy<span class="token operator">></span> <span class="token keyword">select</span> * from cascade_child_4<span class="token punctuation">;</span>  
+----+------------+------+
<span class="token operator">|</span> <span class="token function">id</span> <span class="token operator">|</span> name       <span class="token operator">|</span> p_id <span class="token operator">|</span>
+----+------------+------+
<span class="token operator">|</span> 4  <span class="token operator">|</span> Bob child2 <span class="token operator">|</span> 2    <span class="token operator">|</span>
+----+------------+------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>注意:<code>relationship</code>没有设置参数的删除,参照上面的<strong>11级联对比2.py</strong>,不是真正的删除,只是吧相关的字段设置成<code>NULL</code>.</p><hr><p>创建如下文件:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python</span>
<span class="token comment" spellcheck="true"># coding=utf-8</span>

<span class="token comment" spellcheck="true"># 14级联对比5</span>
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship


<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token keyword">class</span> <span class="token class-name">Cascade_Parent_5</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_parent_5'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 设置双向关系</span>
    childs <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Child_5'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">,</span> cascade<span class="token operator">=</span> <span class="token string">'save-update, delete, delete-orphan'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span>  <span class="token class-name">Cascade_Child_5</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'cascade_child_5'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true"># 外键连接的是 表</span>
    <span class="token comment" spellcheck="true"># 使用默认的MySQl外键</span>
    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'cascade_parent_5.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Cascade_Parent_5'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'childs'</span><span class="token punctuation">,</span> cascade<span class="token operator">=</span><span class="token string">'save-update'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
p1 <span class="token operator">=</span> Cascade_Parent_5<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
c1 <span class="token operator">=</span> Cascade_Child_5<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
c2 <span class="token operator">=</span> Cascade_Child_5<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span>childs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 双向关系,子表也可以添加数据</span>
p2 <span class="token operator">=</span> Cascade_Parent_5<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob'</span><span class="token punctuation">)</span>
c3 <span class="token operator">=</span> Cascade_Child_5<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child1'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c4 <span class="token operator">=</span> Cascade_Child_5<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Bob child2'</span><span class="token punctuation">,</span> p_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c3<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2
c4<span class="token punctuation">.</span>parent <span class="token operator">=</span> p2

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c3<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c4<span class="token punctuation">)</span>

session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>根据定义:<code>delete-orphan</code>的使用和<code>delete</code>类似.需要注意的是绑定到关系的哪一方.<code>delete-orphan</code>要和<code>delete</code>搭配使用.要删除就会都删除.</p><p>运行程序:</p><pre class="line-numbers language-bash">$ python  14级联对比5.py</pre><p>执行取消关联</p><pre><code class="python"><code class="language-bash">$ python  14级联对比5.py</code></code></pre><p>执行取消关联</p><pre><code class="python"># 14级联对比5

# 注释添加数据
# 添加取消关联
q1 = session.query(Cascade_Parent_5).get(1)
q1.childs = []

session.commit()<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行并检查</p><pre class="line-numbers language-bash"><code class="language-bash">$ python 14*.py

$ <span class="token function">cat</span> /mysql_data/localhost.log
<span class="token punctuation">..</span>.
2020-08-25T14:07:22.788616Z       44 Query    DELETE FROM cascade_child_5 WHERE cascade_child_5.id <span class="token operator">=</span> 1
2020-08-25T14:07:22.821541Z       44 Query    DELETE FROM cascade_child_5 WHERE cascade_child_5.id <span class="token operator">=</span> 2
<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,当子对象和父对象取消关联时,子对象被标记为删除.</p></blockquote><h3 id="14-relationship中使用order-by-排序"><a href="#14-relationship中使用order-by-排序" class="headerlink" title="14.relationship中使用order_by 排序"></a>14.<code>relationship</code>中使用<code>order_by</code> 排序</h3><blockquote><p>就像前面介绍的可以使用<a href="./10030.md#%E6%9F%A5%E8%AF%A2%E8%BF%94%E5%9B%9E%E7%9A%84%E5%88%97%E8%A1%A8(%E5%A4%9A%E4%B8%AA%E5%AE%9E%E4%BE%8B)%E4%BB%A5%E5%8F%8A%E6%A0%87%E9%87%8F(%E4%B8%80%E4%B8%AA%E5%AE%9E%E4%BE%8B)"><code>oder_by()</code> </a>对返回的对象进行排序操作.<code>SQLAlchemy</code> 也提供了一些简化排序的方法,比如</p><ul><li>在定义两张表的关系模式的时候指定他们排序方式,<ul><li>指定<code>relationship</code>中<code>order_by</code>的参数,它指定的类的属性,并可以添加<code>desc()</code>和<code>asc()</code>方法,</li><li>如<code>order_by=&#39;Products.create_time.desc()&#39;</code></li></ul></li><li>定义一张表的时候指定它的排序模式<ul><li>指定类的反向映射<code>__mapper_args__({ })</code> ,里面包含的是一个字典对象.</li></ul></li><li>排序方式<ul><li><code>asc</code>:升序</li><li><code>desc</code>:降序</li></ul></li></ul><p>有如下表</p><ul><li><code>categoryes</code>类别表,一个类有多个产品</li><li><code>products</code>产品表,一个产品属于多个类别</li><li><code>statistics</code>与上面两张表无关,是用来统计数据库中信息的</li></ul><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span>Integer<span class="token punctuation">,</span>Text<span class="token punctuation">,</span>DECIMAL<span class="token punctuation">,</span>String<span class="token punctuation">,</span>ForeignKey
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> DateTime

<span class="token comment" spellcheck="true"># 1.创建连接</span>
connect_msg <span class="token operator">=</span> <span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101/sqlalchemy'</span>
engine<span class="token operator">=</span>create_engine<span class="token punctuation">(</span>connect_msg<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 实例化 Session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>创建<code>Model</code>,类和表的对应</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Categoryes</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'categoryes_1'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>

    __mapper_args__ <span class="token operator">=</span>  <span class="token punctuation">{</span>
        <span class="token string">'order_by'</span><span class="token punctuation">:</span> create_time<span class="token punctuation">.</span>desc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true"># 在relationship 上指定排序方式, </span>
    <span class="token comment" spellcheck="true"># 这里指定的 类的属性</span>
    products <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Products'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'category'</span><span class="token punctuation">,</span> order_by<span class="token operator">=</span><span class="token string">'Products.create_time.desc()'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Products</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'products_1'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'categoryes_1.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 这个relationship 上不用指定排序,因为一个产品只属于一个类别,排序没有意义</span>
    category<span class="token operator">=</span>relationship<span class="token punctuation">(</span><span class="token string">'Categoryes'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'products'</span><span class="token punctuation">)</span>



<span class="token keyword">class</span> <span class="token class-name">Statistics</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'statistics_1'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span>nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true"># 正常排序方式</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>给表中添加数据</p><pre class="line-numbers language-python"><code class="language-python">c1 <span class="token operator">=</span> Categoryes<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Book'</span><span class="token punctuation">,</span>create_time<span class="token operator">=</span><span class="token string">'2013-10-20 11:21:30'</span><span class="token punctuation">)</span>
p1 <span class="token operator">=</span> Products<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'Java'</span><span class="token punctuation">,</span>create_time<span class="token operator">=</span><span class="token string">'2013-10-21 11:21:30'</span><span class="token punctuation">,</span>c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
p2 <span class="token operator">=</span> Products<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'Python'</span><span class="token punctuation">,</span>create_time<span class="token operator">=</span><span class="token string">'2013-10-22 11:21:30'</span><span class="token punctuation">,</span>c_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
c1<span class="token punctuation">.</span>products<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p1<span class="token punctuation">)</span>
c1<span class="token punctuation">.</span>products<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p2<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c1<span class="token punctuation">)</span>

c2 <span class="token operator">=</span> Categoryes<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Fruit'</span><span class="token punctuation">,</span>create_time<span class="token operator">=</span><span class="token string">'2013-10-23 11:21:30'</span><span class="token punctuation">)</span>
p3 <span class="token operator">=</span> Products<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'Apple'</span><span class="token punctuation">,</span>create_time<span class="token operator">=</span><span class="token string">'2013-10-24 11:21:30'</span><span class="token punctuation">,</span>c_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
p4 <span class="token operator">=</span> Products<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'Banana'</span><span class="token punctuation">,</span>create_time<span class="token operator">=</span><span class="token string">'2013-10-25 11:21:30'</span><span class="token punctuation">,</span>c_id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
c2<span class="token punctuation">.</span>products<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p3<span class="token punctuation">)</span>
c2<span class="token punctuation">.</span>products<span class="token punctuation">.</span>append<span class="token punctuation">(</span>p4<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>c2<span class="token punctuation">)</span>

s1 <span class="token operator">=</span> Statistics<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'categoryes表'</span><span class="token punctuation">,</span> create_time<span class="token operator">=</span><span class="token string">'2013-9-20 11:21:30'</span><span class="token punctuation">)</span>
s2 <span class="token operator">=</span> Statistics<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'products表'</span><span class="token punctuation">,</span> create_time<span class="token operator">=</span><span class="token string">'2013-9-19 11:21:30'</span><span class="token punctuation">)</span>
session<span class="token punctuation">.</span>add_all<span class="token punctuation">(</span><span class="token punctuation">[</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">]</span><span class="token punctuation">)</span>

session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查看<code>mysql</code>数据库</p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:test> select * from categoryes_1;                                                                                                                                                           
+----+-------+---------------------+
| id | name  | create_time         |
+----+-------+---------------------+
| 1  | Book  | 2013-10-20 11:21:30 |
| 2  | Fruit | 2013-10-23 11:21:30 |
+----+-------+---------------------+
2 rows in set
Time: 0.015s
mysql root@192.168.101:test> select * from products_1;                                                                                                                                                             
+----+--------+---------------------+------+
| id | name   | create_time         | c_id |
+----+--------+---------------------+------+
| 1  | Java   | 2013-10-21 11:21:30 | 1    |
| 2  | Python | 2013-10-22 11:21:30 | 1    |
| 3  | Apple  | 2013-10-24 11:21:30 | 2    |
| 4  | Banana | 2013-10-25 11:21:30 | 2    |
+----+--------+---------------------+------+
4 rows in set
Time: 0.019s
mysql root@192.168.101:test> select * from statistics_1;                                                                                                                                                           
+----+--------------+---------------------+
| id | name         | create_time         |
+----+--------------+---------------------+
| 1  | categoryes表 | 2013-09-20 11:21:30 |
| 2  | products表   | 2013-09-19 11:21:30 |
+----+--------------+---------------------+
2 rows in set
Time: 0.034s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对默认创建的表<code>statistics_1</code> 执行查询</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 执行查询语句</span>
<span class="token comment" spellcheck="true"># 查询 statistics_1 表,不使用 order_by</span>

q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Statistics<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q1<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT statistics_1.id AS statistics_1_id, statistics_1.name AS statistics_1_name,
statistics_1.create_time AS statistics_1_create_time 
FROM statistics_1
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用<code>order_by()</code>方法查询</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 使用order_by 升序和降序查询</span>

q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Statistics<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Statistics<span class="token punctuation">.</span>create_time<span class="token punctuation">.</span>desc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
q3 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Statistics<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span>Statistics<span class="token punctuation">.</span>create_time<span class="token punctuation">.</span>asc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q3<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT statistics_1.id AS statistics_1_id, statistics_1.name AS statistics_1_name,
statistics_1.create_time AS statistics_1_create_time 
FROM statistics_1 ORDER BY statistics_1.create_time DESC

SELECT statistics_1.id AS statistics_1_id, statistics_1.name AS statistics_1_name,
statistics_1.create_time AS statistics_1_create_time 
FROM statistics_1 ORDER BY statistics_1.create_time ASC
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>对表<code>categoryes_1</code>进行查询,它的<code>Model</code>中内置了排序方法</p><pre class="line-numbers language-python"><code class="language-python">q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Categoryes<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q4<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT categoryes_1.id AS categoryes_1_id, categoryes_1.name AS categoryes_1_name,
categoryes_1.create_time AS categoryes_1_create_time 
FROM categoryes_1 ORDER BY categoryes_1.create_time DESC
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,只是执行普通的查询语句,就执行了<code>order_by</code>命令,这是因为魔法方法<code>__mapper_args__</code>可以实现函数方法的反向映射.</p><p>对<code>categoryes_1</code>和<code>products_1</code>进行联表查询</p><pre class="line-numbers language-python"><code class="language-python">q5 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Categoryes<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>Categoryes<span class="token punctuation">.</span>products<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q5<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT categoryes_1.id AS categoryes_1_id, categoryes_1.name AS categoryes_1_name,
categoryes_1.create_time AS categoryes_1_create_time 
FROM categoryes_1 
INNER JOIN products_1 ON 
categoryes_1.id = products_1.c_id 
ORDER BY categoryes_1.create_time DESC
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过一个分类去获取它下面的所有产品,并查看排序方式.</p><pre class="line-numbers language-python"><code class="language-python">q6 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>Categoryes<span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 拿到一个类别下的所有的产品</span>
q6<span class="token punctuation">.</span>products
<span class="token keyword">for</span> i <span class="token keyword">in</span> q6<span class="token punctuation">.</span>products<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>id<span class="token punctuation">)</span>


    <span class="token triple-quoted-string string">"""
2
1
    """</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>通过查看<code>mysql</code>的查询日志,可以看到在<code>relationship</code>中定义的排序方式确实生效了.</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">tail</span> -10 /mysql_data/localhost.log
<span class="token string">''</span>'
Query    SELECT products_1.id AS products_1_id, products_1.name AS products_1_name, 
products_1.create_time AS products_1_create_time, products_1.c_id AS products_1_c_id 
FROM products_1 
WHERE 1 <span class="token operator">=</span> products_1.c_id ORDER BY products_1.create_time DESC<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h3 id="15-relationship中惰性查询"><a href="#15-relationship中惰性查询" class="headerlink" title="15.relationship中惰性查询"></a>15.<code>relationship</code>中惰性查询</h3><h4 id="1-试理解relationship"><a href="#1-试理解relationship" class="headerlink" title="1.试理解relationship"></a>1.试理解<code>relationship</code></h4><blockquote><p><code>MySQL</code> 是一个关系型数据库,关系型数据库最关键的就是关系.<code>SQLAlchemy</code> 作为一层<code>ORM</code> 对象关系映射,它是通过<code>Model</code> 的属性来模拟关系的.</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10205.png" alt="10206"></p><p>对于他们的映射</p><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/10206.png" alt="10206"></p><p>大致被映射成了如上关系.</p><p>表与表之间的关系,直接映射成了<code>Class</code> 的一个<code>relationship()</code> 属性.表中字段之间的关系直接映射成一个一个<code>class</code> 类实例与另外 一个<code>class</code> 类实例之间的关系.</p><p>比如如下最简单的一对多的关系:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">Parent_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'parent_1'</span>
    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    p_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    child <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Child_1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'parent'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Child_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'Child_1'</span>
    c_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    c_name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'parent_1.p_id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    parent<span class="token operator">=</span>relationship<span class="token punctuation">(</span><span class="token string">'Parent2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'child'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>那么<code>Parent_1</code> 的实例<code>p1</code>,就和多个<code>Child_1</code> 的实例产生了关系(通过外键),比如<code>c1,c2</code>.这样就完成了关系的抽象,也就是实现了面向对象的考虑.通过访问<code>p1.child</code> 就能访问到<code>c1,c2</code>,这样从<code>ORM</code>的角度简化了<code>SQL</code>语句的查询.</p><p>虽然底层实现的是<code>SQL</code> 语句.但是我们只用考虑面向对象层面就行.</p><p>这样又产生了新的问题,当访问<code>p1.children</code> 时,会拿到所有的在<code>Child2</code> 类中对应的实例.如果数据量过多,会非常消耗资源(比如内存吃紧),有时候,只想去拿到<code>p1.children</code> 对应的个别实例.这样就需要对<code>Parent1.children</code> 这个给属性做出控制.</p><p><code>Paren1.children</code> 是一个<code>relationship()</code> 对象,也就是对<code>relationship()</code>做出控制.</p><p>从<code>SQL</code>关系的角度看,这样就产生了惰性查询,也就是不返回所有的实例,而是返回一个<code>Query</code> 对象,让父类的属性再次操作<code>Query</code> 对象</p></blockquote><h4 id="2-简单验证lazy-dynamic"><a href="#2-简单验证lazy-dynamic" class="headerlink" title="2.简单验证lazy=dynamic"></a>2.简单验证<code>lazy=dynamic</code></h4><blockquote><pre class="line-numbers language-bash"><code class="language-bash">lazy 决定了 SQLAlchemy 什么时候从数据库中加载数据:，有如下四个值:<span class="token punctuation">(</span>其实还有个noload不常用<span class="token punctuation">)</span>
select: <span class="token punctuation">(</span>which is the default<span class="token punctuation">)</span> means that SQLAlchemy will load the data as necessary <span class="token keyword">in</span> one go using a standard <span class="token keyword">select</span> statement. 
joined: tells SQLAlchemy to load the relationship <span class="token keyword">in</span> the same query as the parent using a JOIN statement. 
subquery: works like ‘joined’ but instead SQLAlchemy will use a subquery. 
dynamic <span class="token keyword">:</span> is special and useful <span class="token keyword">if</span> you have many items. Instead of loading the items SQLAlchemy will <span class="token keyword">return</span> another query object <span class="token function">which</span> you can further refine before loading the items. This is usually what you want <span class="token keyword">if</span> you <span class="token function">expect</span> <span class="token function">more</span> than a handful of items <span class="token keyword">for</span> this relationship<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>select</code>:默认值, 后台会用<code>select</code>语句一次性加载所有数据,即访问到属性的时候,就会全部加载该属性的数据.</li><li><code>joined</code>:数据会被JOIN语句加载,即对关联的两个表进行<code>join</code>操作,从而获取到所有相关的对象.</li><li><code>dynamic</code>:在访问属性的时候,并不在内存中加载数据,而是返回一个<code>AppenderQuery</code> 类对象,这个类继承自<code>Query</code> ,也就是会返回一个<code>Query</code> 对象.</li><li><code>subquery</code>: 数据被用<code>subquery子</code>查询SQL语句加载</li><li><code>True</code> :即<code>select</code>方法</li><li><code>False</code>:即<code>joined</code>方法</li></ul><p>现在来看一下一对多关系中的懒加载,首先一对多关系,说明父表的实例对象上关联了多个子表的实例对象.所以,一般会在父表上设置<code>lazy=&#39;dynamic&#39;</code>, 而不是子表.</p><p>设置如下关系的父表和子表</p><ul><li>父表:<code>User</code>,文章的作者,一个作者可以写多篇文章</li><li>子表:<code>Article</code>,文章表,一个文章只能对应一个作者,它有一个外键连接在父表上<code>u_id</code></li></ul><hr><p>创建如下:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> String<span class="token punctuation">,</span> Date<span class="token punctuation">,</span> DateTime<span class="token punctuation">,</span> Time<span class="token punctuation">,</span> Text<span class="token punctuation">,</span> Enum<span class="token punctuation">,</span> DECIMAL<span class="token punctuation">,</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span>  relationship

<span class="token comment" spellcheck="true"># 1.连接数据库</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101:3306/sqlalchemy'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 2.创建Session</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 3.实例化session</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 4.创建Model</span>
<span class="token comment" spellcheck="true"># 创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建映射</span>
<span class="token comment" spellcheck="true"># 一对多关系表,默认的加载方式时 lazy= select</span>
<span class="token keyword">class</span> <span class="token class-name">User_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_2'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    articles <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Article_1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Article_1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'article_2'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    u_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_2.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User_1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'articles'</span><span class="token punctuation">)</span>


<span class="token comment" spellcheck="true"># 添加 懒加载</span>
<span class="token keyword">class</span> <span class="token class-name">User_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_3'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    articles <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Article_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">,</span> lazy <span class="token operator">=</span> <span class="token string">'dynamic'</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Article_2</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'article_3'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    u_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_3.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User_2'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'articles'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
u1 <span class="token operator">=</span> User_1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a1 <span class="token operator">=</span> Article_1<span class="token punctuation">(</span>id<span class="token operator">=</span>i<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child'</span><span class="token punctuation">,</span> create_time<span class="token operator">=</span><span class="token string">'201{}-1{}-2{} 11:2{}:1{}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">,</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">,</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">,</span>i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">,</span> i<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> u_id<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">)</span>
    u1<span class="token punctuation">.</span>articles<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a1<span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a1<span class="token punctuation">)</span>



<span class="token comment" spellcheck="true">#</span>
u2 <span class="token operator">=</span> User_2<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a2 <span class="token operator">=</span> Article_2<span class="token punctuation">(</span>id<span class="token operator">=</span>i<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack child'</span><span class="token punctuation">,</span>
                   create_time<span class="token operator">=</span><span class="token string">'201{}-1{}-2{} 11:2{}:1{}'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">,</span> i <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> u_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    u2<span class="token punctuation">.</span>articles<span class="token punctuation">.</span>append<span class="token punctuation">(</span>a2<span class="token punctuation">)</span>
    session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>a2<span class="token punctuation">)</span>


session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><ol><li>使用默认创建的一对多关系,查看<code>Model</code>上的关系</li></ol><pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment" spellcheck="true"># 拿到 父表 映射 类 中的 第一条实例,也就是 第一个作者</span>
q1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User_1<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 通过关系的映射 relationship 来查看子表中第一个作者写的所有文章</span>
q1<span class="token punctuation">.</span>articles<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>然后对照<code>mysql</code>的查询日志,查看他的<code>SQL</code>语句</p><pre class="line-numbers language-shell"><code class="language-shell">$ tail -10 /mysql_data/localhost_log

...

2020-08-25T16:57:14.768883Z       52 Query    SELECT article_2.id AS article_2_id, article_2.name AS article_2_name, article_2.create_time AS article_2_create_time, article_2.u_id AS article_2_u_id 
FROM article_2 
WHERE 1 = article_2.u_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,它其实是查找了,所有<code>u_id=1</code> 的所有数据,上面添加了100条数据,它会把这100条数据全部输出.</p><p>假如,只想从这100条数据中查询出某一条数据,那上面的<code>q1.articles</code> 就不能满足需求了.这时候就需要懒查询.</p><hr><ol start="2"><li>使用<code>lazy=dynamic</code></li></ol><pre class="line-numbers language-python"><code class="language-python"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User_2<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
q2<span class="token punctuation">.</span>articles<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在<code>MySQL</code>日志中查看:</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">tail</span> -10 /mysql_data/localhost_log

<span class="token punctuation">..</span>.
2020-08-25T17:01:33.765645Z       53 Query    SELECT user_3.id AS user_3_id, user_3.name AS user_3_name 
FROM user_3 
 LIMIT 1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>为什么会这样,进一步看:</p><pre class="line-numbers language-python"><code class="language-python">t <span class="token operator">=</span> q2<span class="token punctuation">.</span>articles

<span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">#&lt;class 'sqlalchemy.orm.dynamic.AppenderQuery'></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,当设置了<code>lazy=dynamic</code> 后,<code>q2.articles</code> 的操作就不是去数据库取出所有的数据了,而是返回一个<code>AppenderQuery</code> 对象.这里来查看一下这个对象.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>dynamic <span class="token keyword">import</span> AppenderQuery
<span class="token operator">>></span><span class="token operator">></span> help<span class="token punctuation">(</span>AppenderQuery<span class="token punctuation">)</span>

Help on <span class="token keyword">class</span> <span class="token class-name">AppenderQuery</span> <span class="token keyword">in</span> module sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>dynamic<span class="token punctuation">:</span>
<span class="token keyword">class</span> <span class="token class-name">AppenderQuery</span><span class="token punctuation">(</span>AppenderMixin<span class="token punctuation">,</span> sqlalchemy<span class="token punctuation">.</span>orm<span class="token punctuation">.</span>query<span class="token punctuation">.</span>Query<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,<code>AppenderQuery</code> 是继承自<code>AppenderMixin</code> 和<code>salalcemy.orm.query.Query</code> 这两个类的.那么这个对象首先就拥有了<code>Query</code> 查询的所有方法(比如<code>filter,count,limit,offset等</code>).</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 查询一个实例</span>
q3 <span class="token operator">=</span> t<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Article2<span class="token punctuation">.</span>create_time<span class="token operator">==</span><span class="token string">'2011-11-21 11:21:11'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Article2<span class="token punctuation">.</span>id<span class="token operator">==</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>type<span class="token punctuation">(</span>q3<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q3<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></blockquote><h4 id="3-lazy-joined"><a href="#3-lazy-joined" class="headerlink" title="3.lazy=joined"></a>3.<code>lazy=joined</code></h4><blockquote><p>基于上面,对比<code>lazy=joined</code></p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">User_3</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'user_4'</span>
    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    articles <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Article_3'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">,</span> lazy<span class="token operator">=</span><span class="token string">'joined'</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Article_3</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'article_4'</span>

    id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    create_time <span class="token operator">=</span> Column<span class="token punctuation">(</span>DateTime<span class="token punctuation">)</span>
    u_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_4.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User_3'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'articles'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>drop_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
Base<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
u3 <span class="token operator">=</span> User_3<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">)</span>
a3 <span class="token operator">=</span> Article_3<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sdf'</span><span class="token punctuation">,</span> create_time<span class="token operator">=</span><span class="token string">'2011-11-21 11:21:11'</span><span class="token punctuation">,</span>u_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
a4 <span class="token operator">=</span> Article_3<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'sdf'</span><span class="token punctuation">,</span> create_time<span class="token operator">=</span><span class="token string">'2011-11-21 11:21:11'</span><span class="token punctuation">,</span>u_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

u3<span class="token punctuation">.</span>articles <span class="token operator">=</span> <span class="token punctuation">[</span>a3<span class="token punctuation">,</span> a4<span class="token punctuation">]</span>


session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>u3<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>查询</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 查询</span>
q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User_3<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
tt <span class="token operator">=</span> q4<span class="token punctuation">.</span>articles
type<span class="token punctuation">(</span>tt<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># # sqlalchemy.orm.collections.InstrumentedList</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,它返回的也是所有的查询结果,但是,查看<code>mysql</code> 的查询日志,可以看到它执行的查询语句是</p><pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> anon_1<span class="token punctuation">.</span>user_4_id <span class="token keyword">AS</span> anon_1_user_4_id<span class="token punctuation">,</span> anon_1<span class="token punctuation">.</span>user_4_name <span class="token keyword">AS</span> anon_1_user_4_name<span class="token punctuation">,</span> article_4_1<span class="token punctuation">.</span>id <span class="token keyword">AS</span> article_4_1_id<span class="token punctuation">,</span> article_4_1<span class="token punctuation">.</span>name <span class="token keyword">AS</span> article_4_1_name<span class="token punctuation">,</span> article_4_1<span class="token punctuation">.</span>create_time <span class="token keyword">AS</span> article_4_1_create_time<span class="token punctuation">,</span> article_4_1<span class="token punctuation">.</span>u_id <span class="token keyword">AS</span> article_4_1_u_id 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> user_4<span class="token punctuation">.</span>id <span class="token keyword">AS</span> user_4_id<span class="token punctuation">,</span> user_4<span class="token punctuation">.</span>name <span class="token keyword">AS</span> user_4_name 
<span class="token keyword">FROM</span> user_4 
 <span class="token keyword">LIMIT</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> anon_1 <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> article_4 <span class="token keyword">AS</span> article_4_1 <span class="token keyword">ON</span> anon_1<span class="token punctuation">.</span>user_4_id <span class="token operator">=</span> article_4_1<span class="token punctuation">.</span>u_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>它首先执行了一个子查询,然后执行了一个外连接查询.</p><p><code>lazy</code> 指定的参数不同,执行的效率也是不同的.</p></blockquote><h3 id="16-join"><a href="#16-join" class="headerlink" title="16.join"></a>16.<code>join</code></h3><blockquote><p>创建表</p><pre class="line-numbers language-python"><code class="language-python">rom sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span>String<span class="token punctuation">,</span>Integer
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship


<span class="token comment" spellcheck="true"># 1.创建连接</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101/test'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 2.创建 session池,并实例化</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 3.创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建Model</span>
<span class="token keyword">class</span> <span class="token class-name">User1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
      __tablename__ <span class="token operator">=</span> <span class="token string">'user_1'</span>

      id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
      name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      fullname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      nickname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true"># 定义双向对应,连接的是 Model</span>
      address <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Address1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Address1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
      __tablename__ <span class="token operator">=</span> <span class="token string">'addresses_1'</span>

      id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
      email_address <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true"># 定义外键</span>
      user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_1.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token comment" spellcheck="true"># 定义双向对应</span>
      user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'address'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建表</span>
Base<span class="token punctuation">.</span>metadate<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 添加数据</span>
Jack<span class="token operator">=</span>User1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">,</span> fullname<span class="token operator">=</span><span class="token string">"Jack Ning"</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token string">'Ningning'</span><span class="token punctuation">)</span>
Jack<span class="token punctuation">.</span>address <span class="token operator">=</span> <span class="token punctuation">[</span>
Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'xxx@xx1.com'</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'xxx@xx2.com'</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
Address1<span class="token punctuation">(</span>id<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> email_address<span class="token operator">=</span><span class="token string">'xxx@xx3.com'</span><span class="token punctuation">,</span> user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span>

session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>Jack<span class="token punctuation">)</span>
session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>执行<code>join</code> 查询,默认是内连接.</p><hr><p>普通的交叉连接可以这样查询</p><pre class="line-numbers language-python">q1 = session.query(User1, Address1).all()</pre><p>通过日志查看,它相当查询了一个笛卡尔积.</p><pre><code class="bash"><code class="language-python">q1 = session.query(User1, Address1).all()</code></code></pre><p>通过日志查看,它相当查询了一个笛卡尔积.</p><pre><code class="bash">[root@localhost ~]# tail -5 /mysql_data/localhost.log
SELECT user_1.id AS user_1_id, user_1.name AS user_1_name, user_1.fullname AS user_1_fullname, user_1.nickname AS user_1_nickname, addresses_1.id AS addresses_1_id, addresses_1.email_address AS addresses_1_email_address, addresses_1.user_id AS addresses_1_user_id 
FROM user_1, addresses_1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>使用<code>Queue.join()</code> 查询</p><pre class="line-numbers language-python"><code class="language-python"><span class="token operator">>></span><span class="token operator">></span> q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>Address1<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>Address1<span class="token punctuation">.</span>email_address <span class="token operator">==</span> <span class="token string">'xxx@xx3.com'</span><span class="token punctuation">)</span>
<span class="token operator">>></span><span class="token operator">></span> <span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span>
SELECT user_1<span class="token punctuation">.</span>id AS user_1_id<span class="token punctuation">,</span> user_1<span class="token punctuation">.</span>name AS user_1_name<span class="token punctuation">,</span> user_1<span class="token punctuation">.</span>fullname AS user_1_fullname<span class="token punctuation">,</span> user_1<span class="token punctuation">.</span>nickname AS user_1_nickname 
FROM user_1 INNER JOIN addresses_1 ON user_1<span class="token punctuation">.</span>id <span class="token operator">=</span> addresses_1<span class="token punctuation">.</span>user_id 
WHERE addresses_1<span class="token punctuation">.</span>email_address <span class="token operator">=</span> <span class="token operator">%</span><span class="token punctuation">(</span>email_address_1<span class="token punctuation">)</span>s

<span class="token comment" spellcheck="true"># 它相当于要执行如上语句,但是并没有去执行,调用 one(),get(),all() 去执行语句</span>
<span class="token operator">>></span><span class="token operator">></span> q2<span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>调用<code>all()</code> 之后,查看日志</p><pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">[</span>root@localhost ~<span class="token punctuation">]</span><span class="token comment" spellcheck="true"># tail -5 /mysql_data/localhost.log</span>
<span class="token punctuation">..</span>.
SELECT user_1.id AS user_1_id, user_1.name AS user_1_name, user_1.fullname AS user_1_fullname, user_1.nickname AS user_1_nickname 
FROM user_1 INNER JOIN addresses_1 ON user_1.id <span class="token operator">=</span> addresses_1.user_id 
WHERE addresses_1.email_address <span class="token operator">=</span> <span class="token string">'xxx@xx3.com'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到,如果join()直接写<code>Address1</code> ,相当于一个内连接,<code>filter</code> 在这里扮演了<code>where</code> 子句的作用.</p><p>那么在<code>SQL</code> 语句中,<code>join...on...</code> 是有<code>on</code>子句做条件的.对应到<code>sqlalchemy</code>的<code>join</code>函数,这个函数会处理<code>join...on</code> 的判断条件.因为<code>User1</code> 和<code>Address1</code> 是通过外键连接的,也就是表<code>user_1</code>和<code>addresses_1</code> 是通过外键连接的,这里<code>join(Address1)</code> 虽然没有写条件,但是<code>join</code>() 函数会自动通过外键去连接这两张表.</p><p><code>User_1</code> 和<code>Address_1</code> 他们的关系却是双向的,也就是说,除了<code>Address_1</code> 代表表<code>addresses_1</code>,也可以通过<code>User_1.address</code> 这个属性去代表<code>address_1</code> 这张表.</p><pre class="line-numbers language-python"><code class="language-python">q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>User1<span class="token punctuation">.</span>address<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q4<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT user_1.id AS user_1_id, user_1.name AS user_1_name, user_1.fullname AS user_1_fullname, user_1.nickname AS user_1_nickname 
FROM user_1 INNER JOIN addresses_1 ON user_1.id = addresses_1.user_id
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>join</code>() 函数还可以容纳多个<code>on</code>子句(表与表之间通过外键连接).比如:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">class</span> <span class="token class-name">oders</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token keyword">pass</span>
<span class="token keyword">class</span> <span class="token class-name">Items</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
     <span class="token keyword">pass</span>

q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>Address_1<span class="token punctuation">,</span> Oders<span class="token punctuation">,</span> Items<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 通过属性连接,相当于</span>
q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>User1<span class="token punctuation">.</span>address<span class="token punctuation">,</span> 
                            Address_1<span class="token punctuation">.</span>oders<span class="token punctuation">,</span>
                            Oders<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 表与表之间是通过外键连接的</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>join()</code> 函数还可以加入<code>Table</code> 对象.比如:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token comment" spellcheck="true"># 比如多对多中的Table对象,</span>
<span class="token comment" spellcheck="true"># 新建一个Table对象,有外键连接</span>
table_test <span class="token operator">=</span> Table<span class="token punctuation">(</span><span class="token string">'table_test'</span><span class="token punctuation">,</span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span>
                Column<span class="token punctuation">(</span><span class="token string">'c_id'</span><span class="token punctuation">,</span> Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_1.id'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 内连接 外键是条件判断对象</span>
q4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>table_test<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>join()</code> 函数还可以显式的把<code>on</code>子句加入:</p><pre class="line-numbers language-python"><code class="language-python">q5 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>Address1<span class="token punctuation">,</span> User1<span class="token punctuation">.</span>id <span class="token operator">==</span> Address1<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q5<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
SELECT user_1.id AS user_1_id, user_1.name AS user_1_name, user_1.fullname AS user_1_fullname, user_1.nickname AS user_1_nickname 
FROM user_1 INNER JOIN addresses_1 ON user_1.id = addresses_1.id
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>使用别名查询: 在多个表中查询时,如果同一个表需要多次应用,可以给表起个别名.比如</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> aliased

a1 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address1<span class="token punctuation">)</span>
a2 <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address1<span class="token punctuation">)</span>

test1 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> a1<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> a2<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test1<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT user_1.name AS user_1_name, addresses_1_1.email_address AS addresses_1_1_email_address, addresses_1_2.email_address AS addresses_1_2_email_address 
FROM user_1, addresses_1 AS addresses_1_1, addresses_1 AS addresses_1_2
"""</span>
test3<span class="token operator">=</span>session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> a1<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> a2<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>a1<span class="token punctuation">,</span> User1<span class="token punctuation">.</span>id <span class="token operator">==</span> a1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>a2<span class="token punctuation">,</span> User1<span class="token punctuation">.</span>id <span class="token operator">==</span> a2<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test3<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT user_1.name AS user_1_name, addresses_1_1.email_address AS addresses_1_1_email_address, addresses_1_2.email_address AS addresses_1_2_email_address 
FROM user_1 INNER JOIN addresses_1 AS addresses_1_1 ON user_1.id = addresses_1_1.user_id INNER JOIN addresses_1 AS addresses_1_2 ON user_1.id = addresses_1_2.user_id
"""</span>
test4 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User1<span class="token punctuation">.</span>name<span class="token punctuation">,</span> a1<span class="token punctuation">.</span>email_address<span class="token punctuation">,</span> a2<span class="token punctuation">.</span>email_address<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>a1<span class="token punctuation">,</span> User1<span class="token punctuation">.</span>id <span class="token operator">==</span> a1<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>a2<span class="token punctuation">,</span> User1<span class="token punctuation">.</span>id <span class="token operator">==</span> a2<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a1<span class="token punctuation">.</span>email_address<span class="token operator">==</span><span class="token string">'xxx@xx1.com'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>a2<span class="token punctuation">.</span>email_address<span class="token operator">==</span><span class="token string">'xxx@xx2.com'</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>test4<span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
SELECT user_1.name AS user_1_name, addresses_1_1.email_address AS addresses_1_1_email_address, addresses_1_2.email_address AS addresses_1_2_email_address 
FROM user_1 INNER JOIN addresses_1 AS addresses_1_1 ON user_1.id = addresses_1_1.user_id INNER JOIN addresses_1 AS addresses_1_2 ON user_1.id = addresses_1_2.user_id 
WHERE addresses_1_1.email_address = %(email_address_1)s AND addresses_1_2.email_address = %(email_address_2)s
"""</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>更多的查询阅读官网</p><pre class="line-numbers language-bash"><code class="language-bash">https://docs.sqlalchemy.org/en/13/orm/query.html<span class="token comment" spellcheck="true">#sqlalchemy.orm.query.Query.join</span>
https://docs.sqlalchemy.org/en/13/orm/tutorial.html<span class="token comment" spellcheck="true">#querying-with-joins</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></blockquote><h3 id="17-outerjoin"><a href="#17-outerjoin" class="headerlink" title="17.outerjoin()"></a>17.<code>outerjoin()</code></h3><blockquote><p>左连接,用法和<code>join()</code> 一样.</p></blockquote><h3 id="18-子查询subquery"><a href="#18-子查询subquery" class="headerlink" title="18.子查询subquery"></a>18.子查询<code>subquery</code></h3><blockquote><p><code>Query</code>对象不仅仅可以用于查询,还可以用于生成子查询.<br>有如下<code>ORM</code>对应:</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Column<span class="token punctuation">,</span>String<span class="token punctuation">,</span>Integer
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> ForeignKey
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">import</span> declarative_base
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> relationship


<span class="token comment" spellcheck="true"># 1.创建连接</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">'mysql+pymysql://root:2008.Cn123@192.168.0.101/test'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 2.创建 session池,并实例化</span>
Session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>
session <span class="token operator">=</span> Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># 3.创建基类</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># 创建Model</span>
<span class="token keyword">class</span> <span class="token class-name">User1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
   __tablename__ <span class="token operator">=</span> <span class="token string">'user_1'</span>

   id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
   name <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   fullname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   nickname <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token comment" spellcheck="true"># 定义双向对应,连接的是 Model</span>
   address <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'Address1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Address1</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
   __tablename__ <span class="token operator">=</span> <span class="token string">'addresses_1'</span>

   id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
   email_address <span class="token operator">=</span> Column<span class="token punctuation">(</span>String<span class="token punctuation">(</span><span class="token number">45</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token comment" spellcheck="true"># 定义外键</span>
   user_id <span class="token operator">=</span> Column<span class="token punctuation">(</span>Integer<span class="token punctuation">,</span> ForeignKey<span class="token punctuation">(</span><span class="token string">'user_1.id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token comment" spellcheck="true"># 定义双向对应</span>
   user <span class="token operator">=</span> relationship<span class="token punctuation">(</span><span class="token string">'User1'</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'address'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>假设要通过数据库查询每个用户<code>user</code>拥有的<code>email_address</code>的个数.<br>可以使用子查询来解决这个问题:<br>1.先查看一下表</p><pre class="line-numbers language-mysql"><code class="language-mysql">mysql root@192.168.101:test> select * from user_1;           
+----+-------+-----------+----------+
| id | name  | fullname  | nickname |
+----+-------+-----------+----------+
| 1  | Jack  | Jack Ning | Ningning |
| 2  | Bob   | Bob Ning  | Bob NN   |
| 3  | Harry | Harry K   | K K      |
+----+-------+-----------+----------+
3 rows in set
Time: 0.015s

mysql root@192.168.101:test> select * from addresses_1;
\+----+---------------+---------+
| id | email_address | user_id |
+----+---------------+---------+
| 1  | xxx@xx1.com   | 1       |
| 2  | xxx@xx2.com   | 1       |
| 3  | xxx@xx3.com   | 1       |
| 4  | xxx@xx4.com   | 2       |
| 5  | xxx@xx5.com   | 2       |
| 6  | xxx@xx6.com   | 3       |
| 7  | xxx@xx7.com   | 3       |
+----+---------------+---------+
7 rows in set
Time: 0.014s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>2.查看临时表</p><pre class="line-numbers language-mysql">select count(a.id),a.user_id from addresses_1 as a group by a.user_id;</pre><p>3.利用临时表查询</p><pre><code class="mysql"><code class="language-mysql">select count(a.id),a.user_id from addresses_1 as a group by a.user_id;</code></code></pre><p>3.利用临时表查询</p><pre><code class="mysql">-- 生成临时表用于查询
> select u.fullname,temp_count_address.count from user_1 as u inner join 
(select count(a.id) as count,  -- 给聚合函数的结果一个别名
a.user_id 
from addresses_1 as a
 group by a.user_id) as temp_count_address -- 给临时表一个别名
 where u.id=temp_count_address.user_id;

 +-----------+-------+
| fullname  | count |
+-----------+-------+
| Jack Ning | 3     |
| Bob Ning  | 2     |
| Harry K   | 2     |
+-----------+-------+
3 rows in set
Time: 0.015s
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>在<code>ORM</code>中,从内到外构造这样的语句.</p><pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> func
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> aliased

a <span class="token operator">=</span> aliased<span class="token punctuation">(</span>Address1<span class="token punctuation">)</span>

stmt <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>a<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> func<span class="token punctuation">.</span>count<span class="token punctuation">(</span>a<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span>label<span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>group_by<span class="token punctuation">(</span>a<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span><span class="token punctuation">.</span>subquery<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>它是一个<code>sqlalchemy.aql.selecttable</code>对象,<code>help stmt</code>可以看到这个对象拥有重要属性<code>columns</code></p><pre class="line-numbers language-mardown"><code class="language-mardown">columns(...)
   A named-based collection of :class:`.ColumnElement` objects
   maintained by this :class:`.FromClause`.

   The :attr:`.columns`, or :attr:`.c` collection, is the gateway
   to the construction of SQL expressions using table-bound or
   other selectable-bound columns::

       select([mytable]).where(mytable.c.somecolumn == 5)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>columns</code>这个属性可以简写成<code>c</code>,通过这个属性可以拿到表中对应列的值.<br><code>stmt</code>这个对象的行为类似与<code>Table</code>对象</p><pre class="line-numbers language-python">print(stmt.columns.count)</pre><pre><code>anon_1.count</code></pre><pre><code class="python">q1 = session.query(stmt.columns.count)</code></pre><pre><code class="python"><code class="language-python">print(stmt.columns.count)</code></code></pre><pre><code>anon_1.count</code></pre><pre><code class="python">q1 = session.query(stmt.columns.count)</code></pre><pre><code class="python">print(q1)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre><code>SELECT anon_1.count AS anon_1_count 
FROM (SELECT addresses_1_1.user_id AS user_id, count(addresses_1_1.id) AS count 
FROM addresses_1 AS addresses_1_1 GROUP BY addresses_1_1.user_id) AS anon_1</code></pre><p>可以看到<code>stmt</code>其实是子查询的集合体,它可以通过<code>query</code>语句再次查询结果.</p><pre class="line-numbers language-python"><code class="language-python">u <span class="token operator">=</span> aliased<span class="token punctuation">(</span>User1<span class="token punctuation">)</span>
q2 <span class="token operator">=</span> session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>u<span class="token punctuation">.</span>fullname<span class="token punctuation">,</span> stmt<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">.</span>filter<span class="token punctuation">(</span>u<span class="token punctuation">.</span>id<span class="token operator">==</span>stmt<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>user_id<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>q2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre><code>SELECT user_1_1.fullname AS user_1_1_fullname, anon_1.count AS anon_1_count 
FROM user_1 AS user_1_1, (SELECT addresses_1_1.user_id AS user_id, count(addresses_1_1.id) AS count 
FROM addresses_1 AS addresses_1_1 GROUP BY addresses_1_1.user_id) AS anon_1 
WHERE user_1_1.id = anon_1.user_id</code></pre><p>对比执行的<code>sql</code>语句</p><pre class="line-numbers language-mysql"><code class="language-mysql">select u.fullname,temp_count_address.count from user_1 as u inner join 
(select count(a.id) as count,  -- 给聚合函数的结果一个别名
a.user_id 
from addresses_1 as a
 group by a.user_id) as temp_count_address -- 给临时表一个别名
 where u.id=temp_count_address.user_id;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>q2</code>执行的功能上完全和<code>SQL</code>语句相同.<br>执行<code>q2.all()</code>通过查看<code>MySQL</code>的查询日志对比</p><pre class="line-numbers language-bash"><code class="language-bash">$ <span class="token function">cat</span> /mysql_data/localhost.log 
<span class="token punctuation">..</span>.
SELECT user_1_1.fullname AS user_1_1_fullname, anon_1.count AS anon_1_count 
FROM user_1 AS user_1_1, <span class="token punctuation">(</span>SELECT addresses_1_1.user_id AS user_id, count<span class="token punctuation">(</span>addresses_1_1.id<span class="token punctuation">)</span> AS count 
FROM addresses_1 AS addresses_1_1 GROUP BY addresses_1_1.user_id<span class="token punctuation">)</span> AS anon_1 
WHERE user_1_1.id <span class="token operator">=</span> anon_1.user_id<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-python"><code class="language-python">q2<span class="token punctuation">.</span>all<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre><code>[(&#39;Jack Ning&#39;, 3), (&#39;Bob Ning&#39;, 2), (&#39;Harry K&#39;, 2)]</code></pre></blockquote><p><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/wechat.png" alt="wechat"></p><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kity@2.0.4/dist/kity.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer type="text/javascript" src="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/hexo-simple-mindmap@0.2.0/dist/mindmap.min.css"></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">文彦</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://www.kningyuan.eu.org/posts/4022.html">https://www.kningyuan.eu.org/posts/4022.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">文彦</a> !</span></div></div><script async defer>function navToReprintStatement(){$("html, body").animate({scrollTop:$("#reprint-statement").offset().top-80},800)}document.addEventListener("copy",function(t){M.toast({html:'<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>'})})</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/Flask/"><span class="chip bg-color">Flask</span> </a><a href="/tags/Python/"><span class="chip bg-color">Python</span> </a><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span> </a><a href="/tags/SQLAlchemy/"><span class="chip bg-color">SQLAlchemy</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><style>.valine-card{margin:1.5rem auto}.valine-card .card-content{padding:20px 20px 5px 20px}#vcomments textarea{box-sizing:border-box;background:url(/medias/comment_bg.png) 100% 100% no-repeat}#vcomments p{margin:2px 2px 10px;font-size:1.05rem;line-height:1.78rem}#vcomments blockquote p{text-indent:.2rem}#vcomments a{padding:0 2px;color:#4cbf30;font-weight:500;text-decoration:none}#vcomments img{max-width:100%;height:auto;cursor:pointer}#vcomments ol li{list-style-type:decimal}#vcomments ol,ul{display:block;padding-left:2em;word-spacing:.05rem}#vcomments ul li,ol li{display:list-item;line-height:1.8rem;font-size:1rem}#vcomments ul li{list-style-type:disc}#vcomments ul ul li{list-style-type:circle}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}#vcomments table,td,th{border:0}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments h1{font-size:1.85rem;font-weight:700;line-height:2.2rem}#vcomments h2{font-size:1.65rem;font-weight:700;line-height:1.9rem}#vcomments h3{font-size:1.45rem;font-weight:700;line-height:1.7rem}#vcomments h4{font-size:1.25rem;font-weight:700;line-height:1.5rem}#vcomments h5{font-size:1.1rem;font-weight:700;line-height:1.4rem}#vcomments h6{font-size:1rem;line-height:1.3rem}#vcomments p{font-size:1rem;line-height:1.5rem}#vcomments hr{margin:12px 0;border:0;border-top:1px solid #ccc}#vcomments blockquote{margin:15px 0;border-left:5px solid #42b983;padding:1rem .8rem .3rem .8rem;color:#666;background-color:rgba(66,185,131,.1)}#vcomments pre{font-family:monospace,monospace;padding:1.2em;margin:.5em 0;background:#272822;overflow:auto;border-radius:.3em;tab-size:4}#vcomments code{font-family:monospace,monospace;padding:1px 3px;font-size:.92rem;color:#e96900;background-color:#f8f8f8;border-radius:2px}#vcomments pre code{font-family:monospace,monospace;padding:0;color:#e8eaf6;background-color:#272822}#vcomments pre[class*=language-]{padding:1.2em;margin:.5em 0}#vcomments code[class*=language-],pre[class*=language-]{color:#e8eaf6}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}#vcomments b,strong{font-weight:700}#vcomments dfn{font-style:italic}#vcomments small{font-size:85%}#vcomments cite{font-style:normal}#vcomments mark{background-color:#fcf8e3;padding:.2em}#vcomments table,td,th{padding:12px 13px;border:1px solid #dfe2e5}table tr:nth-child(2n),thead{background-color:#fafafa}#vcomments table th{background-color:#f2f2f2;min-width:80px}#vcomments table td{min-width:80px}#vcomments [type=checkbox]:not(:checked),[type=checkbox]:checked{position:inherit;margin-left:-1.3rem;margin-right:.4rem;margin-top:-1px;vertical-align:middle;left:unset;visibility:visible}</style><div class="card valine-card" data-aos="fade-up"><div class="comment_headling" style="font-size:20px;font-weight:700;position:relative;padding-left:20px;top:15px;padding-bottom:5px"><i class="fas fa-comments fa-fw" aria-hidden="true"></i> <span>评论</span></div><div id="vcomments" class="card-content" style="display:grid"></div></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/valine/av-min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/valine/Valine.min.js"></script><script>new Valine({el:"#vcomments",appId:"4D08X5mQ4KUr126NW8IvCzQ7-gzGzoHsz",appKey:"W8Ga6qdP1wi5QLHkirRTdK96",notify:!1,verify:!1,visitor:!0,avatar:"mm",pageSize:"10",lang:"zh-cn",placeholder:"ヾﾉ≧∀≦)o来啊，快活啊!"})</script><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/58427.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/2020-9-1/1598970771491-10242.png" class="responsive-img" alt="免费在线云数据库"> <span class="card-title">免费在线云数据库</span></div></a><div class="card-content article-content"><div class="summary block-with-text">免费在线云数据库</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-09-01 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> 文彦</span></div></div><div class="card-action article-tags"><a href="/tags/MySQL/"><span class="chip bg-color">MySQL</span> </a><a href="/tags/MongoDB/"><span class="chip bg-color">MongoDB</span> </a><a href="/tags/Redis/"><span class="chip bg-color">Redis</span> </a><a href="/tags/PostgreSQL/"><span class="chip bg-color">PostgreSQL</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/3151.html"><div class="card-image"><img src="https://cdn.jsdelivr.net/gh/ningwenyan/My_chat_picgo/git_learn.png" class="responsive-img" alt="Git学习"> <span class="card-title">Git学习</span></div></a><div class="card-content article-content"><div class="summary block-with-text">Git学习</div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2020-08-19 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> 文彦</span></div></div><div class="card-action article-tags"><a href="/tags/Git/"><span class="chip bg-color">Git</span></a></div></div></div></div></article></div><script>$("#articleContent").on("copy",function(e){var n,t,o,i;void 0===window.getSelection||(""+(n=window.getSelection())).length<Number.parseInt("120")||(t=document.getElementsByTagName("body")[0],(o=document.createElement("div")).style.position="absolute",o.style.left="-99999px",t.appendChild(o),o.appendChild(n.getRangeAt(0).cloneContents()),"PRE"===n.getRangeAt(0).commonAncestorContainer.nodeName&&(o.innerHTML="<pre>"+o.innerHTML+"</pre>"),i=document.location.href,o.innerHTML+='<br />来源: 文彦笔记<br />文章作者: 文彦<br />文章链接: <a href="'+i+'">'+i+"</a><br />本文章著作权归作者所有，任何形式的转载都请注明出处。",n.selectAllChildren(o),window.setTimeout(function(){t.removeChild(o)},200))})</script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/codeBlock/codeShrink.js"></script><style type="text/css">code[class*=language-],pre[class*=language-]{white-space:pre!important}</style></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/tocbot/tocbot.min.js"></script><script>$(function(){tocbot.init({tocSelector:"#toc-content",contentSelector:"#articleContent",headingsOffset:-(.4*$(window).height()-45),collapseDepth:Number("0"),headingSelector:"h1,  h2, h3, h4, h5, h6"});let t=0,e="toc-heading-",n=($("#toc-content a").each(function(){$(this).attr("href","#"+e+ ++t)}),t=0,$("#articleContent").children("h1,  h2, h3, h4, h5, h6").each(function(){$(this).attr("id",e+ ++t)}),parseInt(.4*$(window).height()-64)),o=$(".toc-widget");$(window).scroll(function(){$(window).scrollTop()>n?o.addClass("toc-fixed"):o.removeClass("toc-fixed")});const i="expanded";let a=$("#toc-aside"),c=$("#main-content");$("#floating-toc-btn .btn-floating").click(function(){a.hasClass(i)?(a.removeClass(i).hide(),c.removeClass("l9")):(a.addClass(i).show(),c.addClass("l9"));var e="artDetail";if(0!==(e=$("#artDetail")).length){let t=e.width();450<=t?t+=21:350<=t&&t<450?t+=18:300<=t&&t<350?t+=16:t+=14,$("#prenext-posts").width(t)}})})</script></main><footer class="page-footer bg-color"><script data-ad-client="ca-pub-4337512190549598" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><div class="container row center-align" style="margin-bottom:0!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2019</span> <a href="/about" target="_blank">文彦 </a>|&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp; <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><br></div><div class="col s12 m4 l4 social-link social-statis"><a href="https://github.com/ningwenyan" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:ningyanke@outlook.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50"><i class="fas fa-rss"></i></a></div></div></footer><div class="progress-bar"></div><script src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script><script>window.mermaid&&mermaid.initialize({theme:"forest"})</script><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//js/search.js"></script><script type="text/javascript">$(function(){searchFunc("https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/materialize/materialize.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/masonry/masonry.pkgd.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/aos/aos.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/scrollprogress/scrollProgress.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/lightGallery/js/lightgallery-all.min.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//js/matery.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?407f502eb914179baa7e4efa6da65a6e",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",(e=document.getElementsByTagName("script")[0]).parentNode.insertBefore(t,e)}()</script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/others/clicklove.js" async></script><script async src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/others/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/gh/ningwenyan/ningwenyan.github.io@master//libs/instantpage/instantpage.js" type="module"></script><script type="text/javascript" color="122 103 238" opacity="0.7" zindex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"https://cdn.jsdelivr.net/npm/live2d-widget-model-shizuku@1.0.5/assets/shizuku.model.json"},display:{position:"left",width:150,height:300},mobile:{show:!0},react:{opacity:.7}})</script></body></html>